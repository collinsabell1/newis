<!DOCTYPE html>
<html>
<head>
<title>All Academic Records - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
.container{
  max-width:1300px;
  margin:30px auto;
  padding:30px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
  box-shadow:0 0 40px rgba(0,0,0,0.5);
}
h1{text-align:center;margin-bottom:20px;}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:10px;
  text-align:center;
}
th{
  background:rgba(255,255,255,0.2);
}
tr:nth-child(even){
  background:rgba(255,255,255,0.05);
}
button,select,input{
  padding:8px 14px;
  margin:5px;
  border:none;
  border-radius:10px;
  font-weight:bold;
}
.btn-download{background:#00c6ff;color:white;}
.btn-nav{background:#17a2b8;color:white;}
.btn-filter{background:#ffc107;color:black;}
.btn-print{background:#28a745;color:white;}
.btn-delete{background:#dc3545;color:white;}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“Š All Students Academic Records</h1>

<div style="text-align:center;">
<button class="btn-nav" onclick="window.location.href='/index.html'">â¬… Back to Index</button>
<button class="btn-nav" onclick="window.location.href='/academics.html'">â¬… Back to Academics</button>
<button class="btn-nav" onclick="window.location.href='/behavioral.html'">Next âž¡ Behavioral</button>
</div>

<br>

<div style="text-align:center;">
<input type="text" id="searchInput" placeholder="Search Admission Number">

<select id="yearFilter"></select>

<select id="classFilter">
<option value="All">All Classes</option>
</select>

<select id="averageFilter">
<option value="All">All Performance</option>
<option value="Above">Above 50%</option>
<option value="Below">Below 50%</option>
<option value="Equal">Exactly 50%</option>
</select>

<button class="btn-filter" onclick="renderTable()">Apply</button>
</div>

<br>

<button class="btn-download" onclick="downloadAll()">Download All</button>
<button class="btn-download" onclick="downloadSelected()">Download Selected</button>
<button class="btn-delete" onclick="deleteSelected()">ðŸ—‘ Delete Selected</button>

<table id="recordsTable">
<thead>
<tr>
<th><input type="checkbox" id="selectAll"></th>
<th>Adm No</th>
<th>Name</th>
<th>Class</th>
<th>Year</th>
<th>T1</th>
<th>T2</th>
<th>T3</th>
<th>Average</th>
<th>Rank</th>
<th>Report</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Supabase config
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "YOUR_SUPABASE_ANON_KEY"
);

let allData = [];
let currentFiltered = [];

// Load academics with joined student info
async function loadData() {
  const { data: academics, error } = await supabase
    .from('academics')
    .select(`
      *,
      students (
        studentid,
        name,
        studentname,
        grade
      )
    `);

  if (error) return alert("Error loading records: " + error.message);

  allData = academics.map(a => {
    const student = a.students;
    const avg = a.average ?? ((a.term1 + a.term2 + a.term3) / 3);
    return {
      ...a,
      adm: student?.studentid || 'N/A',
      name: student?.name || student?.studentname || 'N/A',
      class: student?.grade || 'N/A',
      avg
    };
  });

  populateFilters();
  renderTable();
}

// Populate filters
function populateFilters() {
  const yearFilter = document.getElementById('yearFilter');
  const classFilter = document.getElementById('classFilter');

  const years = [...new Set(allData.map(d => d.year))].sort();
  yearFilter.innerHTML = `<option value="All">All Years</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');

  const classes = [...new Set(allData.map(d => d.class))].sort();
  classFilter.innerHTML = `<option value="All">All Classes</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
}

// Render table with search, filters, and ranking
function renderTable() {
  const tbody = document.querySelector('#recordsTable tbody');
  const searchValue = document.getElementById('searchInput').value.toLowerCase();
  const yearValue = document.getElementById('yearFilter').value;
  const classValue = document.getElementById('classFilter').value;
  const avgValue = document.getElementById('averageFilter').value;

  currentFiltered = allData.filter(r => {
    let match = true;
    if (searchValue) match = r.adm.toString().includes(searchValue);
    if (yearValue !== 'All') match = match && r.year == yearValue;
    if (classValue !== 'All') match = match && r.class == classValue;
    if (avgValue !== 'All') {
      if (avgValue === 'Above') match = match && r.avg > 50;
      else if (avgValue === 'Below') match = match && r.avg < 50;
      else if (avgValue === 'Equal') match = match && r.avg === 50;
    }
    return match;
  });

  // Calculate rank per year/class (highest first)
  const grouped = {};
  currentFiltered.forEach(r => {
    const key = `${r.year}_${r.class}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  });

  Object.values(grouped).forEach(group => {
    group.sort((a, b) => b.avg - a.avg); // descending
    group.forEach((r, i) => r.rank = i + 1);
  });

  tbody.innerHTML = '';
  currentFiltered.forEach((r, index) => {
    let color = 'lightgreen';
    if (r.avg < 50) color = 'red';
    else if (r.avg <= 65) color = 'yellow';

    tbody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck" data-index="${index}"></td>
        <td>${r.adm}</td>
        <td>${r.name}</td>
        <td>${r.class}</td>
        <td>${r.year}</td>
        <td>${r.term1 ?? 0}</td>
        <td>${r.term2 ?? 0}</td>
        <td>${r.term3 ?? 0}</td>
        <td style="color:${color};font-weight:bold">${r.avg.toFixed(1)}%</td>
        <td>${r.rank}</td>
        <td><button class="btn-print" onclick='printReport(${JSON.stringify(r)})'>Print</button></td>
      </tr>
    `;
  });
}

// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
  document.querySelectorAll(".rowCheck").forEach(cb => cb.checked = this.checked);
});

// Delete Selected
async function deleteSelected() {
  const selected = [...document.querySelectorAll(".rowCheck")]
    .filter(c => c.checked)
    .map(c => currentFiltered[c.dataset.index]);

  if (!selected.length) return alert("âš ï¸ Please select at least one record to delete.");

  if (!confirm(`âš ï¸ CONFIRM DELETION\nYou are about to delete ${selected.length} record(s). This cannot be undone.`)) return;

  for (let r of selected) {
    const { error } = await supabase.from('academics').delete().eq('id', r.id);
    if (error) alert("Error deleting: " + error.message);
  }

  alert("âœ… Selected records deleted.");
  loadData();
}

// Download CSV helper
function downloadCSV(rows, filename) {
  let csv = "AdmNo,Name,Class,Year,T1,T2,T3,Average,Rank\n";
  rows.forEach(r => {
    csv += `${r.adm},${r.name},${r.class},${r.year},${r.term1 ?? 0},${r.term2 ?? 0},${r.term3 ?? 0},${r.avg.toFixed(1)},${r.rank}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

window.downloadAll = () => downloadCSV(currentFiltered, "All_Academic_Records.csv");
window.downloadSelected = () => {
  const sel = [...document.querySelectorAll(".rowCheck")]
    .filter(c => c.checked)
    .map(c => currentFiltered[c.dataset.index]);
  if (!sel.length) return alert("Select students first!");
  downloadCSV(sel, "Selected_Records.csv");
}

// Print report
window.printReport = function(data) {
  const win = window.open("");
  win.document.write(`
    <h2>Student Report Card</h2>
    <p><b>Admission:</b> ${data.adm}</p>
    <p><b>Name:</b> ${data.name}</p>
    <p><b>Class:</b> ${data.class}</p>
    <p><b>Year:</b> ${data.year}</p>
    <p><b>Average:</b> ${data.avg.toFixed(1)}%</p>
    <button onclick="print()">Print</button>
  `);
};

// Auto-load data
loadData();
</script>
</body>
</html>
