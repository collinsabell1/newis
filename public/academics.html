<!DOCTYPE html>
<html>
<head>
<title>Academic Risk - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
.container{
  max-width:1100px;
  margin:30px auto;
  padding:30px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
  box-shadow:0 0 40px rgba(0,0,0,0.5);
}
h1{text-align:center;margin-bottom:25px;}
label{font-weight:500;margin-top:10px;display:block;}
input{
  width:100%;
  padding:12px 14px;
  margin:8px 0;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.15);
  color:white;
  font-size:15px;
}
button{
  padding:10px 15px;
  margin:6px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
}
.btn-add{background:#28a745;color:white;}
.btn-save{background:#00c6ff;color:white;}
.btn-update{background:#ffc107;color:black;}
.btn-clear{background:#6c757d;color:white;}
.btn-view{background:#6f42c1;color:white;}
.btn-nav{background:#17a2b8;color:white;}
.circle{
  width:160px;
  height:160px;
  border-radius:50%;
  background:conic-gradient(#00ff99 0deg,#333 0deg);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:bold;
  margin:25px auto;
}
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:15px;
}
.nav-buttons{text-align:center;margin-top:20px;}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“˜ Academic Risk Assessment</h1>

<label>Admission Number</label>
<input type="text" id="studentId">

<h3>Student Information</h3>
<div class="grid">
<input type="text" id="studentName" readonly>
<input type="text" id="school" readonly>
<input type="text" id="grade" readonly>
<input type="text" id="age" readonly>
<input type="text" id="gender" readonly>
<input type="text" id="parentName" readonly>
</div>

<label>Academic Year</label>
<input type="text" id="year" readonly>

<label>Date Recorded</label>
<input type="text" id="recordDate" readonly>

<h3>Termly Average Scores</h3>
<input type="number" id="term1" placeholder="Term 1 Average" min="0" max="100">
<input type="number" id="term2" placeholder="Term 2 Average" min="0" max="100">
<input type="number" id="term3" placeholder="Term 3 Average" min="0" max="100">

<div style="text-align:center;">
<button class="btn-add" onclick="addNew()">Add New</button>
<button class="btn-save" onclick="saveAcademic()">Save</button>
<button class="btn-update" onclick="updateAcademic()">Update</button>
<button class="btn-clear" onclick="clearFields()">Clear</button>
<button class="btn-view" onclick="window.location.href='view-all.html'">View All</button>
</div>

<div class="circle" id="averageCircle">0%</div>

<div class="nav-buttons">
<button class="btn-nav" onclick="window.location.href='index.html'">â¬… Back to Index</button>
<button class="btn-nav" onclick="window.location.href='behavioral.html'">Next âž¡ Behavioral</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, updateDoc, getDoc,
  getDocs, collection, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "newis-96304.firebaseapp.com",
  projectId: "newis-96304",
  storageBucket: "newis-96304.firebasestorage.app",
  messagingSenderId: "695908769426",
  appId: "1:695908769426:web:dc0db0866cbdaa4fb6d04b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let studentDocId = null;

year.value = new Date().getFullYear();
recordDate.value = new Date().toLocaleString();

/* LOAD STUDENT */
async function loadStudent(){
  const adm = studentId.value.trim();
  if(!adm) return;
  const q = query(collection(db,"students"), where("studentId","==",adm));
  const snap = await getDocs(q);
  if(snap.empty){ alert("Student Not Found"); return;}
  snap.forEach(d=>{
    studentDocId = d.id;
    const data = d.data();
    studentName.value = data.studentName||"";
    school.value = data.school||"";
    grade.value = data.grade||"";
    age.value = data.age||"";
    gender.value = data.gender||"";
    parentName.value = data.parentName||"";
  });
}
studentId.addEventListener("blur", loadStudent);

/* VALIDATE SCORE â€” CLEAR FIELD IF INVALID */
function validateScore(input, termName){
  const num = Number(input.value);

  if (input.value === "") return 0;

  if (isNaN(num) || num > 100 || num < 0){
    alert(termName + " must be between 0 and 100. Field cleared.");
    input.value = "";
    return 0;
  }
  return num;
}

/* CALCULATE */
function calculate(){
  const t1 = validateScore(term1, "Term 1");
  const t2 = validateScore(term2, "Term 2");
  const t3 = validateScore(term3, "Term 3");

  const values = [t1, t2, t3].filter(v => v !== 0);
  const avg = values.length ? values.reduce((a,b)=>a+b,0)/values.length : 0;

  const deg = avg * 3.6;
  let color = avg < 50 ? "red" : avg <= 65 ? "yellow" : "#00ff99";

  averageCircle.style.background =
    `conic-gradient(${color} ${deg}deg,#333 ${deg}deg)`;
  averageCircle.innerHTML = avg.toFixed(1)+"%";

  return avg;
}
[term1,term2,term3].forEach(i=>i.addEventListener("input",calculate));

/* CLEAR */
window.clearFields = () => {
  term1.value = term2.value = term3.value = "";
  calculate();
};

/* ADD NEW */
window.addNew = () => {
  studentId.value="";
  studentDocId=null;
  studentName.value=school.value=grade.value=age.value=gender.value=parentName.value="";
  clearFields();
};

/* SAVE */
window.saveAcademic = async () => {
  if(!studentDocId) return alert("Enter Admission Number");
  const ref = doc(db,"students",studentDocId,"academics",year.value);
  const avg = calculate();
  const snap = await getDoc(ref);

  if(snap.exists()){
    if(confirm("Record exists. Update?")){
      await updateDoc(ref,{
        term1:+term1.value||0,
        term2:+term2.value||0,
        term3:+term3.value||0,
        average:avg,
        recordDate:new Date().toLocaleString()
      });
      alert("Updated Successfully!");
    }
  } else {
    await setDoc(ref,{
      year:year.value,
      recordDate:new Date().toLocaleString(),
      term1:+term1.value||0,
      term2:+term2.value||0,
      term3:+term3.value||0,
      average:avg
    });
    alert("Saved Successfully!");
  }
};

/* UPDATE */
window.updateAcademic = async () => {
  if(!studentDocId) return alert("Enter Admission Number");
  await updateDoc(
    doc(db,"students",studentDocId,"academics",year.value),
    {
      term1:+term1.value||0,
      term2:+term2.value||0,
      term3:+term3.value||0,
      average:calculate(),
      recordDate:new Date().toLocaleString()
    }
  );
  alert("Updated Successfully!");
};
</script>
</body>
</html>
