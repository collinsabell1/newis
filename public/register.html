<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  display:flex;
  justify-content:center;
  padding-top:20px;
}
.container{
  background:rgba(255,255,255,.12);
  padding:30px;
  border-radius:20px;
  width:560px;
  backdrop-filter:blur(15px);
}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:none;
  border-radius:10px;
}
button{font-weight:bold;cursor:pointer}
.navbtn{background:#17a2b8}
.btn-create{background:#00c6ff}
.btn-search{background:#ffc107;color:black}
.btn-update{background:#28a745}
.btn-cam{background:#ff9800}
.success{text-align:center;color:#00ff99;margin-top:10px}
#video{width:100%;display:none;border-radius:10px}
#preview{width:150px;margin-top:10px;border-radius:12px;display:none}
</style>
</head>

<body>
<div class="container">

<h2>Student Registration</h2>

<button class="navbtn" onclick="location.href='index.html'">üè† Home</button>
<button class="navbtn" onclick="location.href='schooldetails.html'">üè´ Register School</button>

<hr>

<input id="studentId" placeholder="Admission Number">
<button class="btn-search" onclick="searchStudent()">Search Student</button>

<input id="studentName" placeholder="Student Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option>Loading schools...</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option>Select Class</option></select>
<select id="streamSelect"><option>Select Stream</option></select>

<label>Upload Photo</label>
<input type="file" id="photoUpload">

<button class="btn-cam" onclick="startCamera()">Start Camera</button>
<button class="btn-cam" onclick="capturePhoto()">Capture Photo</button>

<video id="video" autoplay></video>
<canvas id="canvas" style="display:none"></canvas>
<img id="preview">

<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>

<hr>
<h3>Live Students</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ------------------- SUPABASE CLIENT ------------------- */
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

const el=id=>document.getElementById(id);

let schoolsMap={},currentStudentId=null,capturedBlob=null,cameraStream=null;

/* ------------------- CALCULATE AGE ------------------- */
el("dateOfBirth").addEventListener("change",()=>{
  const val=el("dateOfBirth").value;
  if(!val){ el("age").value=""; return; }

  const b=new Date(val);
  const t=new Date();

  let a=t.getFullYear()-b.getFullYear();
  if(t.getMonth()<b.getMonth()||(t.getMonth()==b.getMonth()&&t.getDate()<b.getDate())) a--;

  el("age").value=a>0?a:"";
});

/* ------------------- LOAD SCHOOLS ------------------- */
async function loadSchools(){
  const {data,error}=await supabase.from("schools").select("*").order("name");

  if(error){ alert(error.message); return; }
  if(!data || data.length===0){
    el("schoolSelect").innerHTML="<option>No schools found</option>";
    return;
  }

  el("schoolSelect").innerHTML="<option value=''>Select School</option>";

  data.forEach(s=>{
    schoolsMap[s.name] = s;
    el("schoolSelect").add(new Option(s.name, s.name));
  });
}
loadSchools();

/* ------------------- SCHOOL CHANGE ------------------- */
el("schoolSelect").onchange = () => {
  const s = schoolsMap[el("schoolSelect").value];

  el("gradeSelect").innerHTML="<option>Select Class</option>";
  el("streamSelect").innerHTML="<option>Select Stream</option>";

  if(!s) return;

  el("levelDisplay").value = s.level || "";

  (s.classes || []).forEach(c=>el("gradeSelect").add(new Option(c,c)));
  (s.streams || []).forEach(st=>el("streamSelect").add(new Option(st,st)));
};

/* ------------------- SEARCH STUDENT ------------------- */
window.searchStudent = async ()=>{
  const id = el("studentId").value.trim();
  if(!id) return alert("Enter admission number");

  const {data,error} = await supabase
    .from("students")
    .select("*")
    .eq("studentid", id)
    .single();

  if(error){ alert("Student not found"); return; }

  currentStudentId = id;

  el("studentName").value = data.studentname || "";
  el("dateOfBirth").value = data.dateofbirth || "";
  el("age").value = data.age || "";

  el("schoolSelect").value = data.school || "";
  el("schoolSelect").dispatchEvent(new Event("change"));

  el("gradeSelect").value = data.grade || "";
  el("streamSelect").value = data.stream || "";

  if(data.photo){
    el("preview").src = data.photo;
    el("preview").style.display="block";
  }
};

/* ------------------- CAMERA ------------------- */
async function startCamera(){
  cameraStream = await navigator.mediaDevices.getUserMedia({video:true});
  el("video").srcObject = cameraStream;
  el("video").style.display = "block";
}

function capturePhoto(){
  const video = el("video");
  const canvas = el("canvas");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);

  canvas.toBlob(b=>{
    capturedBlob = b;
    el("preview").src = URL.createObjectURL(b);
    el("preview").style.display = "block";
  });

  cameraStream?.getTracks().forEach(t=>t.stop());
  video.style.display="none";
}

/* ------------------- UPLOAD PHOTO ------------------- */
async function uploadPhoto(id){
  let f = el("photoUpload").files[0] || capturedBlob;
  if(!f) return null;

  const path = `students/${id}_${Date.now()}.jpg`;

  const {error} = await supabase.storage.from("photos").upload(path,f);
  if(error){alert(error.message); return null;}

  return supabase.storage.from("photos").getPublicUrl(path).data.publicUrl;
}

/* ------------------- REGISTER STUDENT ------------------- */
window.registerStudent = async ()=>{
  const id = el("studentId").value.trim();
  if(!id) return alert("Admission number required");

  const photo = await uploadPhoto(id);

  const {error} = await supabase.from("students").insert([{
    studentid: id,
    studentname: el("studentName").value,
    dateofbirth: el("dateOfBirth").value || null,
    age: Number(el("age").value) || null,
    school: el("schoolSelect").value || null,
    level: el("levelDisplay").value || null,
    grade: el("gradeSelect").value || null,
    stream: el("streamSelect").value || null,
    photo
  }]);

  if(error) return alert(error.message);

  el("message").innerText="Student Registered ‚úî";
};

/* ------------------- UPDATE STUDENT ------------------- */
window.updateStudent = async ()=>{
  if(!currentStudentId) return alert("Search student first");

  const photo = await uploadPhoto(currentStudentId);

  let data = {
    studentname: el("studentName").value,
    dateofbirth: el("dateOfBirth").value,
    age: Number(el("age").value) || null,
    school: el("schoolSelect").value,
    level: el("levelDisplay").value,
    grade: el("gradeSelect").value,
    stream: el("streamSelect").value
  };
  if(photo) data.photo = photo;

  const {error} = await supabase.from("students").update(data)
    .eq("studentid", currentStudentId);

  if(error) return alert(error.message);

  el("message").innerText="Student Updated ‚úî";
};

/* ------------------- LIVE STUDENT LIST ------------------- */
(async()=>{
  const {data,error} = await supabase.from("students").select("*").limit(20);
  if(error) return alert(error.message);

  data.forEach(s=>{
    el("liveList").innerHTML += `<div>${s.studentid} ‚Äî ${s.studentname}</div>`;
  });
})();
</script>

</body>
</html>
