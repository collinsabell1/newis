<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NEWIS Student System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}

body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
display:flex;
justify-content:center;
padding:15px;
}

/* CONTAINER */
.container{
width:100%;
max-width:750px;
background:rgba(255,255,255,.08);
backdrop-filter:blur(18px);
border-radius:20px;
padding:20px;
box-shadow:0 10px 30px rgba(0,0,0,.4);
}

/* NAVIGATION */
.nav{
display:flex;
flex-wrap:wrap;
gap:10px;
margin-bottom:15px;
}

.nav button{
flex:1;
min-width:120px;
}

/* INPUTS */
input,select{
width:100%;
padding:12px;
margin:6px 0;
border-radius:10px;
border:none;
font-size:15px;
}

/* BUTTONS */
button{
padding:12px;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
transition:.25s;
width:100%;
}

button:active{
transform:scale(.97);
}

button:hover{
transform:translateY(-2px);
box-shadow:0 6px 15px rgba(0,0,0,.3);
}

/* COLORS */
.primary{background:linear-gradient(45deg,#00c6ff,#0072ff);}
.success{background:linear-gradient(45deg,#00b09b,#96c93d);}
.warning{background:linear-gradient(45deg,#f7971e,#ffd200);color:black;}
.danger{background:linear-gradient(45deg,#ff416c,#ff4b2b);}
.purple{background:linear-gradient(45deg,#7f00ff,#e100ff);}
.dark{background:#222}

/* FLEX ROW */
.row{
display:flex;
gap:10px;
flex-wrap:wrap;
}

.row button{flex:1}

/* ALERT */
#alert{
margin-top:10px;
padding:10px;
border-radius:8px;
font-weight:bold;
text-align:center;
display:none;
}

#alert.success{background:#00c851;}
#alert.error{background:#ff4444;}

/* VIDEO */
#video{width:100%;display:none;border-radius:10px;margin-top:10px}
#preview{width:130px;border-radius:10px;margin-top:10px;display:none}

/* STUDENT LIST */
.student{
padding:6px;
border-bottom:1px solid rgba(255,255,255,.2);
font-size:14px;
}

/* MOBILE */
@media(max-width:480px){
.nav,.row{flex-direction:column}
}
</style>
</head>

<body>
<div class="container">

<h2>NEWIS Student System</h2>

<!-- NAVIGATION -->
<div class="nav">
<button class="primary" type="button" onclick="refreshPage()">Refresh</button>
<button class="purple" type="button" onclick="downloadCSV()">Download CSV</button>
<button class="dark" type="button" onclick="toggleBulk()">Bulk Upload</button>
</div>

<!-- BULK UPLOAD SECTION -->
<div id="bulkSection" style="display:none">
<p><b>CSV Format Instructions:</b></p>
<small>
Columns must be:<br>
studentId,studentName,dateOfBirth,age,school,level,grade,stream
</small>
<input type="file" id="csvFile" accept=".csv">
<button class="success" type="button" onclick="uploadCSV()">Upload CSV</button>
<hr>
</div>

<!-- STUDENT FORM -->
<input id="studentId" placeholder="Admission Number">
<button class="warning" type="button" onclick="searchStudent()">Search Student</button>

<input id="studentName" placeholder="Student Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option>Loading schools...</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>
<select id="gradeSelect"><option>Select Class</option></select>
<select id="streamSelect"><option>Select Stream</option></select>

<div class="row">
<button class="success" type="button" onclick="registerStudent()">Register</button>
<button class="primary" type="button" onclick="updateStudent()">Update</button>
<button class="danger" type="button" onclick="deleteStudent()">Delete</button>
</div>

<hr>
<h3>Live Students</h3>
<div id="studentList"></div>

<div id="alert"></div>

</div>

<script>

/* SUPABASE */
const supabase = window.supabase.createClient(
"https://YOUR_PROJECT.supabase.co",
"YOUR_PUBLIC_ANON_KEY"
);

const el=id=>document.getElementById(id);
let schoolsMap={},currentStudent=null;

/* ALERT */
function showAlert(msg,type="success"){
const a=el("alert");
a.className=type;
a.innerText=msg;
a.style.display="block";
setTimeout(()=>a.style.display="none",4000);
}

/* REFRESH */
function refreshPage(){location.reload();}

/* AGE */
el("dateOfBirth").addEventListener("change",()=>{
const dob=new Date(el("dateOfBirth").value);
if(!dob)return;
const today=new Date();
let age=today.getFullYear()-dob.getFullYear();
if(today.getMonth()<dob.getMonth() ||
(today.getMonth()==dob.getMonth() && today.getDate()<dob.getDate())) age--;
el("age").value=age>=0?age:"";
});

/* LOAD SCHOOLS */
async function loadSchools(){
const {data,error}=await supabase.from("schools").select("*");
if(error) return showAlert(error.message,"error");

el("schoolSelect").innerHTML="<option value=''>Select School</option>";
data.forEach(s=>{
if(typeof s.classes==="string") s.classes=JSON.parse(s.classes||"[]");
if(typeof s.streams==="string") s.streams=JSON.parse(s.streams||"[]");
schoolsMap[s.name]=s;
el("schoolSelect").add(new Option(s.name,s.name));
});
}
loadSchools();

/* SCHOOL CHANGE */
el("schoolSelect").addEventListener("change",()=>{
const s=schoolsMap[el("schoolSelect").value];
el("gradeSelect").innerHTML="<option>Select Class</option>";
el("streamSelect").innerHTML="<option>Select Stream</option>";
if(!s)return;
el("levelDisplay").value=s.level||"";
(s.classes||[]).forEach(c=>el("gradeSelect").add(new Option(c,c)));
(s.streams||[]).forEach(st=>el("streamSelect").add(new Option(st,st)));
});

/* REGISTER */
async function registerStudent(){
const id=el("studentId").value.trim();
if(!id) return showAlert("Admission number required","error");

const {error}=await supabase.from("students").insert([{
studentId:id,
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value||null,
age:Number(el("age").value)||null,
school:el("schoolSelect").value||null,
level:el("levelDisplay").value||null,
grade:el("gradeSelect").value||null,
stream:el("streamSelect").value||null
}]);

if(error) return showAlert(error.message,"error");

showAlert("Student Registered");
loadStudents();
}

/* SEARCH */
async function searchStudent(){
const id=el("studentId").value.trim();
if(!id) return showAlert("Enter admission number","error");

const {data,error}=await supabase.from("students")
.select("*").eq("studentId",id).maybeSingle();

if(error) return showAlert(error.message,"error");
if(!data) return showAlert("Student not found","error");

currentStudent=data;

el("studentName").value=data.studentName||"";
el("dateOfBirth").value=data.dateOfBirth||"";
el("age").value=data.age||"";
el("schoolSelect").value=data.school||"";
el("schoolSelect").dispatchEvent(new Event("change"));
el("gradeSelect").value=data.grade||"";
el("streamSelect").value=data.stream||"";

showAlert("Student Loaded");
}

/* UPDATE */
async function updateStudent(){
if(!currentStudent) return showAlert("Search student first","error");

const {error}=await supabase.from("students")
.update({
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value||null,
age:Number(el("age").value)||null,
school:el("schoolSelect").value||null,
level:el("levelDisplay").value||null,
grade:el("gradeSelect").value||null,
stream:el("streamSelect").value||null
})
.eq("studentId",currentStudent.studentId);

if(error) return showAlert(error.message,"error");

showAlert("Student Updated");
loadStudents();
}

/* DELETE */
async function deleteStudent(){
if(!currentStudent) return showAlert("Search student first","error");

await supabase.from("students")
.delete()
.eq("studentId",currentStudent.studentId);

showAlert("Student Deleted");
loadStudents();
}

/* LOAD STUDENTS */
async function loadStudents(){
const {data}=await supabase.from("students").select("*").order("created_at",{ascending:false});
el("studentList").innerHTML="";
data?.forEach(s=>{
el("studentList").innerHTML+=
`<div class="student">${s.studentId} - ${s.studentName}</div>`;
});
}
loadStudents();

/* BULK CSV DOWNLOAD */
async function downloadCSV(){
const {data}=await supabase.from("students").select("*");
if(!data.length) return showAlert("No data available","error");

let csv="studentId,studentName,dateOfBirth,age,school,level,grade,stream\n";
data.forEach(s=>{
csv+=`${s.studentId},${s.studentName},${s.dateOfBirth},${s.age},${s.school},${s.level},${s.grade},${s.stream}\n`;
});

const blob=new Blob([csv],{type:"text/csv"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="students.csv";
a.click();
}

/* BULK UPLOAD */
function toggleBulk(){
const s=el("bulkSection");
s.style.display=s.style.display==="none"?"block":"none";
}

async function uploadCSV(){
const file=el("csvFile").files[0];
if(!file) return showAlert("Select CSV file","error");

const text=await file.text();
const rows=text.split("\n").slice(1);

let students=[];

rows.forEach(r=>{
const cols=r.split(",");
if(cols.length>=8){
students.push({
studentId:cols[0],
studentName:cols[1],
dateOfBirth:cols[2]||null,
age:Number(cols[3])||null,
school:cols[4],
level:cols[5],
grade:cols[6],
stream:cols[7]
});
}
});

if(!students.length) return showAlert("Invalid CSV format","error");

const {error}=await supabase.from("students").insert(students);
if(error) return showAlert(error.message,"error");

showAlert("Bulk Upload Successful");
loadStudents();
}

</script>
</body>
</html>
