<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  display:flex;
  justify-content:center;
  padding:10px;
}
.container{
  background:rgba(255,255,255,.12);
  padding:20px;
  border-radius:15px;
  width:100%;
  max-width:550px;
  backdrop-filter:blur(15px);
}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:none;
  border-radius:10px;
  font-size:1em;
}
button{font-weight:bold;cursor:pointer}
.navbtn{background:#17a2b8}
.btn-create{background:#00c6ff}
.btn-search{background:#ffc107;color:black}
.btn-update{background:#28a745}
.btn-cam{background:#ff9800}
.success{text-align:center;color:#00ff99;margin-top:10px}
#error{text-align:center;color:#ff4d4d;margin-top:10px}
#video{width:100%;display:none;border-radius:10px;object-fit:cover;}
#previewContainer{position:relative;width:100%;padding-top:100%;margin-top:10px;}
#preview{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:12px;object-fit:cover;cursor:pointer;}
#cropBox{
  position:absolute;
  border:2px dashed #00ff99;
  width:80px;height:80px;
  cursor:move;
  display:none;
}
.info{text-align:left;color:#ccc;font-size:0.85em;margin:5px 0;}
@media(max-width:480px){
  .container{padding:15px;}
  input, select, button{font-size:0.9em;}
  #cropBox{width:60px;height:60px;}
}
</style>
</head>

<body>
<div class="container">

<h2>Student Registration</h2>

<!-- NAVIGATION BUTTONS -->
<button class="navbtn" onclick="location.href='index.html'">üè† Home</button>
<button class="navbtn" onclick="location.href='schooldetails.html'">üè´ Register School</button>
<button class="navbtn" onclick="location.href='view-all.html'">üìã All Students</button>
<button class="navbtn" onclick="location.href='registerview.html'">üìÑ Register View</button>

<hr>

<!-- STUDENT SEARCH -->
<input id="studentId" placeholder="Admission Number">
<button class="btn-search" onclick="searchStudent()">Search Student</button>

<!-- STUDENT FORM -->
<input id="studentName" placeholder="Student Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option>Loading schools...</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option>Select Class</option></select>
<select id="streamSelect"><option>Select Stream</option></select>

<label>Upload Photo</label>
<input type="file" id="photoUpload" accept="image/*" capture="environment">
<div class="info">
  Supported formats: JPG, PNG. Drag the crop box over the image to select area.
</div>

<button class="btn-cam" onclick="startCamera()">Start Camera</button>
<button class="btn-cam" onclick="capturePhoto()">Capture Photo</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none"></canvas>

<div id="previewContainer">
  <img id="preview" alt="Photo Preview">
  <div id="cropBox"></div>
</div>

<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>

<hr>

<!-- BULK UPLOAD -->
<h3>Bulk Upload Students (Excel)</h3>
<div class="info">
  Format your Excel sheet with columns:<br>
  <b>studentid | studentname | dateofbirth (YYYY-MM-DD) | school | grade | stream</b><br>
  First row should be the header.
</div>
<button class="btn-create" onclick="downloadCSVTemplate()">‚¨á Download CSV Template</button>
<input type="file" id="bulkExcel" accept=".xlsx,.xls,.csv">
<button class="btn-create" onclick="bulkUploadExcel()">Upload Excel</button>

<hr>
<h3>Live Students</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>
<div id="error"></div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ------------------- SUPABASE ------------------- */
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

const el=id=>document.getElementById(id);
let schoolsMap={},currentStudentId=null,capturedBlob=null,cameraStream=null;

/* ------------------- OFFLINE DB ------------------- */
const dbName="studentsOffline";
let db;
const request=indexedDB.open(dbName,1);
request.onupgradeneeded=e=>{ db=e.target.result; db.createObjectStore("students",{keyPath:"studentid"}); };
request.onsuccess=e=>{ db=e.target.result; console.log("Offline DB ready"); };
request.onerror=e=>{ console.error("DB error",e); };

async function saveOffline(student){ return new Promise(resolve=>{ const tx=db.transaction("students","readwrite"); tx.objectStore("students").put(student); tx.oncomplete=()=>resolve(true); }); }
async function getOffline(studentid){ return new Promise(resolve=>{ const tx=db.transaction("students","readonly"); const req=tx.objectStore("students").get(studentid); req.onsuccess=e=>resolve(e.target.result); }); }

/* ------------------- AGE CALC ------------------- */
el("dateOfBirth").addEventListener("change",()=>{ 
  const val=el("dateOfBirth").value; 
  if(!val){ el("age").value=""; return; } 
  const b=new Date(val), t=new Date();
  let a=t.getFullYear()-b.getFullYear();
  if(t.getMonth()<b.getMonth()||(t.getMonth()==b.getMonth()&&t.getDate()<b.getDate())) a--;
  el("age").value=a>0?a:""; 
});

/* ------------------- LOAD SCHOOLS ------------------- */
async function loadSchools(){
  const {data,error}=await supabase.from("schools").select("*").order("name");
  if(error){ alert(error.message); return; }
  if(!data || data.length===0){ el("schoolSelect").innerHTML="<option>No schools found</option>"; return; }
  el("schoolSelect").innerHTML="<option value=''>Select School</option>";
  data.forEach(s=>{ schoolsMap[s.name]=s; el("schoolSelect").add(new Option(s.name,s.name)); });
}
loadSchools();

/* ------------------- SCHOOL CHANGE ------------------- */
el("schoolSelect").onchange = ()=>{
  const s=schoolsMap[el("schoolSelect").value];
  el("gradeSelect").innerHTML="<option>Select Class</option>";
  el("streamSelect").innerHTML="<option>Select Stream</option>";
  if(!s) return;
  el("levelDisplay").value=s.level||"";
  (s.classes||[]).forEach(c=>el("gradeSelect").add(new Option(c,c)));
  (s.streams||[]).forEach(st=>el("streamSelect").add(new Option(st,st)));
};

/* ------------------- SEARCH STUDENT ------------------- */
window.searchStudent = async ()=>{
  const id=el("studentId").value.trim();
  if(!id) return alert("Enter admission number");
  if(!navigator.onLine){
    const student=await getOffline(id);
    if(student){ fillForm(student); return; } 
    else { alert("Student not found offline"); return; }
  }
  const {data,error}=await supabase.from("students").select("*").eq("studentid",id).single();
  if(error){ alert("Student not found"); return; }
  fillForm(data);
};
function fillForm(data){
  currentStudentId=data.studentid;
  el("studentName").value=data.studentname||"";
  el("dateOfBirth").value=data.dateofbirth||"";
  el("age").value=data.age||"";
  el("schoolSelect").value=data.school||"";
  el("schoolSelect").dispatchEvent(new Event("change"));
  el("gradeSelect").value=data.grade||"";
  el("streamSelect").value=data.stream||"";
  if(data.photo){ el("preview").src=data.photo; cropBox.style.display="block"; }
}

/* ------------------- CAMERA ------------------- */
async function startCamera(){
  cameraStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  el("video").srcObject=cameraStream;
  el("video").style.display="block";
}
function capturePhoto(){
  const video=el("video");
  const canvas=el("canvas");
  const size=Math.min(video.videoWidth,video.videoHeight);
  const x=(video.videoWidth-size)/2;
  const y=(video.videoHeight-size)/2;
  canvas.width=300; canvas.height=300;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(video,x,y,size,size,0,0,300,300);
  canvas.toBlob(b=>{ capturedBlob=b; el("preview").src=URL.createObjectURL(b); cropBox.style.display="block"; });
  cameraStream?.getTracks().forEach(t=>t.stop());
  video.style.display="none";
}

/* ------------------- DRAGGABLE CROP ------------------- */
const cropBox = el("cropBox");
let drag=false, startX, startY;
cropBox.addEventListener("mousedown", e=>{ drag=true; startX=e.offsetX; startY=e.offsetY; });
document.addEventListener("mouseup", ()=>{ drag=false; });
document.addEventListener("mousemove", e=>{
  if(!drag) return;
  const rect=cropBox.parentElement.getBoundingClientRect();
  let left=e.clientX-rect.left-startX;
  let top=e.clientY-rect.top-startY;
  left=Math.max(0, Math.min(left, rect.width-cropBox.offsetWidth));
  top=Math.max(0, Math.min(top, rect.height-cropBox.offsetHeight));
  cropBox.style.left=left+"px"; cropBox.style.top=top+"px";
});

/* ------------------- UPLOAD PHOTO ------------------- */
async function uploadPhoto(id){
  if(!el("preview").src) return null;
  const img=new Image();
  img.src=el("preview").src;
  await img.decode();
  const canvas=el("canvas");
  canvas.width=cropBox.offsetWidth; canvas.height=cropBox.offsetHeight;
  const ctx=canvas.getContext("2d");
  const imgRect=el("preview").getBoundingClientRect();
  const scaleX=img.naturalWidth/imgRect.width;
  const scaleY=img.naturalHeight/imgRect.height;
  const sx=cropBox.offsetLeft*scaleX;
  const sy=cropBox.offsetTop*scaleY;
  const sw=cropBox.offsetWidth*scaleX;
  const sh=cropBox.offsetHeight*scaleY;
  ctx.drawImage(img,sx,sy,sw,sh,0,0,cropBox.offsetWidth,cropBox.offsetHeight);
  return new Promise(resolve=>{
    canvas.toBlob(b=>{
      const reader=new FileReader();
      reader.onloadend=()=>resolve(reader.result); // offline: base64
      reader.readAsDataURL(b);
    });
  });
}

/* ------------------- CLEAR FORM ------------------- */
function clearForm(){
  currentStudentId=null;
  el("studentId").value="";
  el("studentName").value="";
  el("dateOfBirth").value="";
  el("age").value="";
  el("schoolSelect").value="";
  el("schoolSelect").dispatchEvent(new Event("change"));
  el("gradeSelect").value="";
  el("streamSelect").value="";
  el("preview").src="";
  cropBox.style.display="none";
  capturedBlob=null;
}

/* ------------------- REGISTER / UPDATE ------------------- */
async function saveStudent(online=true){
  const id=el("studentId").value.trim();
  if(!id) return alert("Admission number required");
  const photo=await uploadPhoto(id);
  const student={
    studentid:id,
    studentname:el("studentName").value,
    dateofbirth:el("dateOfBirth").value||null,
    age:Number(el("age").value)||null,
    school:el("schoolSelect").value||null,
    level:el("levelDisplay").value||null,
    grade:el("gradeSelect").value||null,
    stream:el("streamSelect").value||null,
    photo
  };
  if(!navigator.onLine || !online){
    await saveOffline(student);
    el("message").innerText="Saved Offline ‚úî";
  } else {
    const {error}=await supabase.from("students").upsert([student]);
    if(error){ await saveOffline(student); el("message").innerText="Saved Offline ‚úî"; }
    else el("message").innerText="Saved Online ‚úî";
  }
  clearForm();
  loadLiveStudents();
}
window.registerStudent = ()=>saveStudent();
window.updateStudent = ()=>saveStudent();

/* ------------------- BULK EXCEL ------------------- */
async function bulkUploadExcel(){
  const file=el("bulkExcel").files[0];
  if(!file) return alert("Select Excel file first");
  const reader=new FileReader();
  reader.onload=async e=>{
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:"array"});
    const sheetName=workbook.SheetNames[0];
    const sheet=workbook.Sheets[sheetName];
    const json=XLSX.utils.sheet_to_json(sheet,{defval:""});
    const students=json.map(r=>({
      studentid:r.studentid, studentname:r.studentname,
      dateofbirth:r.dateofbirth||null, school:r.school||null,
      grade:r.grade||null, stream:r.stream||null
    })).filter(r=>r.studentid && r.studentname);
    if(students.length===0) return alert("No valid students found");
    if(!navigator.onLine){
      for(const s of students) await saveOffline(s);
      el("message").innerText=`Bulk saved offline: ${students.length}`;
      return;
    }
    const {error}=await supabase.from("students").insert(students);
    if(error){ el("error").innerText=error.message; return; }
    el("message").innerText=`Bulk upload successful: ${students.length} students`;
    el("bulkExcel").value="";
    loadLiveStudents();
  };
  reader.readAsArrayBuffer(file);
}

/* ------------------- CSV TEMPLATE ------------------- */
function downloadCSVTemplate(){
  const csvContent="studentid,studentname,dateofbirth,school,grade,stream\n";
  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="students_template.csv"; a.click();
}

/* ------------------- LIVE STUDENTS ------------------- */
async function loadLiveStudents(){
  el("liveList").innerHTML="";
  if(!navigator.onLine){
    const tx=db.transaction("students","readonly");
    const req=tx.objectStore("students").getAll();
    req.onsuccess=e=>{
      e.target.result.forEach(s=>el("liveList").innerHTML+=`<div>${s.studentid} ‚Äî ${s.studentname}</div>`);
    };
    return;
  }
  const {data,error}=await supabase.from("students").select("*").limit(20);
  if(error) return alert(error.message);
  data.forEach(s=>el("liveList").innerHTML+=`<div>${s.studentid} ‚Äî ${s.studentname}</div>`);
}
loadLiveStudents();

</script>

</body>
</html>
