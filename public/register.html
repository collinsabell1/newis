<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FACE API -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',Arial,sans-serif;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
display:flex;
justify-content:center;
padding-top:20px;
min-height:100vh;
}

.container{
background:rgba(255,255,255,0.12);
padding:30px;
border-radius:20px;
width:560px;
backdrop-filter:blur(15px);
}

input,select,button{
width:100%;
padding:10px;
margin:6px 0;
border:none;
border-radius:10px;
}

button{font-weight:bold;cursor:pointer;}

.btn-create{background:#00c6ff;}
.btn-search{background:#ffc107;color:black;}
.btn-update{background:#28a745;}
.btn-cam{background:#ff9800;}

.success{
text-align:center;
color:#00ff99;
margin-top:10px;
}

.floating-actions{
position:fixed;
top:20px;
left:20px;
display:flex;
gap:12px;
z-index:9999;
}

.float-btn{
padding:10px 18px;
border-radius:14px;
border:none;
font-weight:600;
cursor:pointer;
color:white;
background-size:300% 300%;
animation:gradientMove 6s ease infinite;
box-shadow:0 8px 20px rgba(0,0,0,0.35);
}

.btn-home{background-image:linear-gradient(45deg,#ff416c,#ff4b2b,#ff6a00);}
.btn-school{background-image:linear-gradient(45deg,#00c6ff,#0072ff,#00ffcc);}

@keyframes gradientMove{
0%{background-position:0% 50%;}
50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}

#video{
width:100%;
border-radius:10px;
margin-top:10px;
display:none;
}

#preview{
width:140px;
margin-top:10px;
border-radius:12px;
display:none;
}
</style>
</head>

<body>

<div class="floating-actions">
<button class="float-btn btn-home" onclick="location.href='index.html'">‚¨Ö Home</button>
<button class="float-btn btn-school" onclick="location.href='schooldetails.html'">üè´ School</button>
</div>

<div class="container">
<h2>Student Registration</h2>

<input id="studentId" placeholder="Admission Number (ADM-001)">
<button class="btn-search" onclick="searchStudent()">üîç Search Student</button>

<input id="studentName" placeholder="Student Full Name">

<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option value="">Select School</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option value="">Select Class</option></select>
<select id="streamSelect"><option value="">Select Stream</option></select>

<label>Student Photo</label>
<input type="file" id="photoUpload" accept="image/*">

<button class="btn-cam" onclick="startCamera()">üì∑ Take Live Photo</button>
<button class="btn-cam" onclick="capturePhoto()">üì∏ Capture</button>

<video id="video" autoplay></video>
<canvas id="canvas" style="display:none;"></canvas>
<img id="preview">

<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>

<hr>
<h3>Live Student List</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase=createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"YOUR_API_KEY"
);

/* LOAD FACE MODEL */
await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");

/* ELEMENTS */
const schoolSelect=document.getElementById("schoolSelect");
const gradeSelect=document.getElementById("gradeSelect");
const streamSelect=document.getElementById("streamSelect");
const levelDisplay=document.getElementById("levelDisplay");
const studentId=document.getElementById("studentId");
const studentName=document.getElementById("studentName");
const dateOfBirth=document.getElementById("dateOfBirth");
const ageField=document.getElementById("age");
const photoUpload=document.getElementById("photoUpload");
const preview=document.getElementById("preview");
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const message=document.getElementById("message");
const liveList=document.getElementById("liveList");

let schoolsMap={};
let currentStudentId=null;
let cameraStream=null;
let capturedBlob=null;

/* AGE */
dateOfBirth.onchange=()=>{
const birth=new Date(dateOfBirth.value);
const today=new Date();
let age=today.getFullYear()-birth.getFullYear();
const m=today.getMonth()-birth.getMonth();
if(m<0||(m===0 && today.getDate()<birth.getDate())) age--;
ageField.value=age;
};

/* LOAD SCHOOLS */
async function loadSchools(){
const {data}=await supabase.from("schools").select("*");
data.forEach(s=>{
schoolsMap[s.name]=s;
schoolSelect.add(new Option(s.name,s.name));
});
}
loadSchools();

/* SCHOOL CHANGE */
schoolSelect.onchange=()=>{
gradeSelect.innerHTML="<option>Select Class</option>";
streamSelect.innerHTML="<option>Select Stream</option>";
const s=schoolsMap[schoolSelect.value];
if(!s) return;
levelDisplay.value=s.level||"";
(s.classes||[]).forEach(c=>gradeSelect.add(new Option(c,c)));
(s.streams||[]).forEach(st=>streamSelect.add(new Option(st,st)));
};

/* SEARCH */
window.searchStudent=async()=>{
if(!studentId.value) return alert("Enter admission number");

const {data,error}=await supabase
.from("students")
.select("*")
.eq("studentId",studentId.value)
.single();

if(error||!data) return alert("Student not in system");

currentStudentId=data.studentId;

studentName.value=data.studentName||"";
dateOfBirth.value=data.dateOfBirth||"";
ageField.value=data.age||"";
schoolSelect.value=data.school||"";
schoolSelect.onchange();
gradeSelect.value=data.grade||"";
streamSelect.value=data.stream||"";

if(data.photo){
preview.src=data.photo;
preview.style.display="block";
}

message.innerText="Student loaded";
};

/* CAMERA */
window.startCamera=async()=>{
cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
video.srcObject=cameraStream;
video.style.display="block";
};

window.capturePhoto=()=>{
const ctx=canvas.getContext("2d");
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.drawImage(video,0,0);

canvas.toBlob(blob=>{
capturedBlob=blob;
preview.src=URL.createObjectURL(blob);
preview.style.display="block";
});
};

/* AI FACE CROP */
async function optimizeImage(file){

return new Promise(resolve=>{
const img=new Image();
img.onload=async()=>{

const detection=await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions());

let sx,sy,size;

if(detection){
const box=detection.box;
size=Math.max(box.width,box.height)*1.6;
sx=box.x+box.width/2-size/2;
sy=box.y+box.height/2-size/2;

sx=Math.max(0,sx);
sy=Math.max(0,sy);
size=Math.min(size,img.width-sx,img.height-sy);
}else{
size=Math.min(img.width,img.height);
sx=(img.width-size)/2;
sy=(img.height-size)/2;
}

const out=500;
const c=document.createElement("canvas");
c.width=out;
c.height=out;

const ctx=c.getContext("2d");
ctx.drawImage(img,sx,sy,size,size,0,0,out,out);

c.toBlob(blob=>resolve(blob),"image/jpeg",0.7);
};
img.src=URL.createObjectURL(file);
});
}

/* UPLOAD */
async function uploadPhoto(id){

let file=photoUpload.files[0]||capturedBlob;
if(!file) return null;

const optimized=await optimizeImage(file);
const path=`students/${id}_${Date.now()}.jpg`;

await supabase.storage.from("photos").upload(path,optimized);
const {data}=supabase.storage.from("photos").getPublicUrl(path);
return data.publicUrl;
}

/* VALID */
function validId(id){
return /^[A-Za-z0-9\-]{3,20}$/.test(id);
}

/* REGISTER */
window.registerStudent=async()=>{
if(!validId(studentId.value)) return alert("Invalid ID");

if(!studentId.value||!studentName.value||!schoolSelect.value||!gradeSelect.value)
return alert("Fill required");

const {data:exists}=await supabase
.from("students")
.select("studentId")
.eq("studentId",studentId.value)
.limit(1);

if(exists.length) return alert("Student exists");

const photo=await uploadPhoto(studentId.value);

await supabase.from("students").insert([{
studentId:studentId.value,
studentName:studentName.value,
dateOfBirth:dateOfBirth.value,
age:Number(ageField.value),
school:schoolSelect.value,
level:levelDisplay.value,
grade:gradeSelect.value,
stream:streamSelect.value||"",
photo:photo,
created_at:new Date()
}]);

message.innerText="‚úî Student Registered";
};

/* UPDATE */
window.updateStudent=async()=>{
if(!currentStudentId) return alert("Search student first");

let photo=await uploadPhoto(currentStudentId);

const updateData={
studentName:studentName.value,
dateOfBirth:dateOfBirth.value,
age:Number(ageField.value),
school:schoolSelect.value,
level:levelDisplay.value,
grade:gradeSelect.value,
stream:streamSelect.value||""
};

if(photo) updateData.photo=photo;

await supabase
.from("students")
.update(updateData)
.eq("studentId",currentStudentId);

message.innerText="‚úî Student Updated";
};

/* REALTIME */
supabase
.channel("students")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"students"},
payload=>{
const s=payload.new;
liveList.innerHTML+=`<div>${s.studentId} ‚Äî ${s.studentName}</div>`;
})
.subscribe();

/* LOAD */
async function loadStudents(){
const {data}=await supabase.from("students").select("*").limit(20);
data.forEach(s=>{
liveList.innerHTML+=`<div>${s.studentId} ‚Äî ${s.studentName}</div>`;
});
}
loadStudents();
</script>

</body>
</html>
