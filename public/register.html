<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
margin:0;
font-family:Segoe UI;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
display:flex;
justify-content:center;
padding-top:20px;
}
.container{
background:rgba(255,255,255,.12);
padding:30px;
border-radius:20px;
width:560px;
backdrop-filter:blur(15px);
}
input,select,button{
width:100%;
padding:10px;
margin:6px 0;
border:none;
border-radius:10px;
}
button{font-weight:bold;cursor:pointer}
.navbtn{background:#17a2b8}
.btn-create{background:#00c6ff}
.btn-search{background:#ffc107;color:black}
.btn-update{background:#28a745}
.btn-cam{background:#ff9800}
.success{text-align:center;color:#00ff99;margin-top:10px}
#video{width:100%;display:none;border-radius:10px}
#preview{width:150px;margin-top:10px;border-radius:12px;display:none}
</style>
</head>

<body>
<div class="container">

<h2>Student Registration</h2>

<button class="navbtn" onclick="location.href='index.html'">üè† Home</button>
<button class="navbtn" onclick="location.href='schooldetails.html'">üè´ Register School</button>

<hr>

<input id="studentId" placeholder="Admission Number">
<button class="btn-search" onclick="searchStudent()">Search Student</button>

<input id="studentName" placeholder="Student Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option>Loading schools...</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option>Select Class</option></select>
<select id="streamSelect"><option>Select Stream</option></select>

<label>Upload Photo</label>
<input type="file" id="photoUpload">

<button class="btn-cam" onclick="startCamera()">Start Camera</button>
<button class="btn-cam" onclick="capturePhoto()">Capture Photo</button>

<video id="video" autoplay></video>
<canvas id="canvas" style="display:none"></canvas>
<img id="preview">

<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>

<hr>
<h3>Live Students</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>

</div>

<script>

/* GLOBAL ERROR ALERT */
window.onerror = function(msg, src, line, col){
alert(
"JS ERROR:\n"+msg+
"\nFile: "+src+
"\nLine: "+line+
"\nColumn: "+col
);
};

/* SUPABASE INIT */
const supabase = window.supabase.createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"YOUR_PUBLIC_ANON_KEY"
);

const el=id=>document.getElementById(id);

let schoolsMap={},currentStudentId=null,capturedBlob=null,cameraStream=null;

/* AGE CALCULATION ‚Äî FIXED */
function calcAge(){
const val = el("dateOfBirth").value;
if(!val){ el("age").value=""; return; }

const birth = new Date(val);
if(isNaN(birth)){ el("age").value=""; return; }

const today=new Date();
let age=today.getFullYear()-birth.getFullYear();
const m=today.getMonth()-birth.getMonth();

if(m<0 || (m===0 && today.getDate()<birth.getDate()))
age--;

el("age").value = age>=0 ? age : "";
}
el("dateOfBirth").addEventListener("input",calcAge);
el("dateOfBirth").addEventListener("change",calcAge);

/* LOAD SCHOOLS */
async function loadSchools(){
try{

const {data,error}=await supabase.from("schools").select("*");

if(error) return alert("School Load Error:\n"+error.message);
if(!data || data.length===0) return alert("No schools in database");

el("schoolSelect").innerHTML="<option value=''>Select School</option>";

data.forEach(s=>{
try{
if(typeof s.classes==="string") s.classes=JSON.parse(s.classes||"[]");
if(typeof s.streams==="string") s.streams=JSON.parse(s.streams||"[]");
}catch{}

schoolsMap[s.name]=s;
el("schoolSelect").add(new Option(s.name,s.name));
});

}catch(err){
alert("Fatal school load:\n"+err.message);
}
}
loadSchools();

/* SCHOOL CHANGE */
el("schoolSelect").onchange=()=>{
const s=schoolsMap[el("schoolSelect").value];

el("gradeSelect").innerHTML="<option>Select Class</option>";
el("streamSelect").innerHTML="<option>Select Stream</option>";

if(!s) return;

el("levelDisplay").value=s.level||"";

(s.classes||[]).forEach(c=>el("gradeSelect").add(new Option(c,c)));
(s.streams||[]).forEach(st=>el("streamSelect").add(new Option(st,st)));
};

/* SEARCH STUDENT */
async function searchStudent(){
try{

const id=el("studentId").value.trim();
if(!id) return alert("Enter admission number");

const {data,error}=await supabase
.from("students")
.select("*")
.eq("studentId",id)
.maybeSingle();

if(error) return alert("Search Error:\n"+error.message);
if(!data) return alert("Student not found");

currentStudentId=id;

el("studentName").value=data.studentName||"";
el("dateOfBirth").value=data.dateOfBirth||"";
calcAge();

el("schoolSelect").value=data.school||"";
el("schoolSelect").onchange();

el("gradeSelect").value=data.grade||"";
el("streamSelect").value=data.stream||"";

if(data.photo){
el("preview").src=data.photo;
el("preview").style.display="block";
}

}catch(err){
alert("Search crash:\n"+err.message);
}
}

/* CAMERA */
async function startCamera(){
try{
cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
el("video").srcObject=cameraStream;
el("video").style.display="block";
}catch(err){ alert(err.message); }
}

function capturePhoto(){
try{
const video=el("video");
const canvas=el("canvas");

canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext("2d").drawImage(video,0,0);

canvas.toBlob(b=>{
capturedBlob=b;
el("preview").src=URL.createObjectURL(b);
el("preview").style.display="block";
});

cameraStream?.getTracks().forEach(t=>t.stop());
video.style.display="none";
}catch(err){ alert(err.message); }
}

/* UPLOAD PHOTO */
async function uploadPhoto(id){
try{
let f=el("photoUpload").files[0]||capturedBlob;
if(!f) return null;

const path=`students/${id}_${Date.now()}.jpg`;

const {error}=await supabase.storage.from("photos").upload(path,f);
if(error){ alert(error.message); return null; }

return supabase.storage.from("photos").getPublicUrl(path).data.publicUrl;

}catch(err){ alert(err.message); }
}

/* REGISTER */
async function registerStudent(){
try{

const id=el("studentId").value.trim();
if(!id) return alert("Admission number required");

const photo=await uploadPhoto(id);

const {error}=await supabase.from("students").insert([{
studentId:id,
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value||null,
age:Number(el("age").value)||null,
school:el("schoolSelect").value||null,
level:el("levelDisplay").value||null,
grade:el("gradeSelect").value||null,
stream:el("streamSelect").value||null,
photo
}]);

if(error) return alert("Insert Error:\n"+error.message);

el("message").innerText="Student Registered ‚úî";

}catch(err){ alert(err.message); }
}

/* UPDATE */
async function updateStudent(){
try{

if(!currentStudentId) return alert("Search student first");

const photo=await uploadPhoto(currentStudentId);

let data={
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value||null,
age:Number(el("age").value)||null,
school:el("schoolSelect").value||null,
level:el("levelDisplay").value||null,
grade:el("gradeSelect").value||null,
stream:el("streamSelect").value||null
};

if(photo) data.photo=photo;

const {error}=await supabase
.from("students")
.update(data)
.eq("studentId",currentStudentId);

if(error) return alert("Update Error:\n"+error.message);

el("message").innerText="Student Updated ‚úî";

}catch(err){ alert(err.message); }
}

/* REALTIME LIST */
supabase.channel("students")
.on("postgres_changes",
{event:"INSERT",schema:"public",table:"students"},
p=>el("liveList").innerHTML+=`<div>${p.new.studentId} ‚Äî ${p.new.studentName}</div>`
).subscribe();

/* INITIAL LOAD */
(async()=>{
const {data,error}=await supabase.from("students").select("*").limit(20);
if(error) return alert(error.message);

data?.forEach(s=>{
el("liveList").innerHTML+=`<div>${s.studentId} ‚Äî ${s.studentName}</div>`;
});
})();
</script>
</body>
</html>
