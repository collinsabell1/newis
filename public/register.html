<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  display:flex;
  justify-content:center;
  padding:10px;
}
.container{
  background:rgba(255,255,255,.12);
  padding:20px;
  border-radius:15px;
  width:100%;
  max-width:550px;
  backdrop-filter:blur(15px);
}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:none;
  border-radius:10px;
  font-size:1em;
}
button{font-weight:bold;cursor:pointer}
.navbtn{background:#17a2b8}
.btn-create{background:#00c6ff}
.btn-search{background:#ffc107;color:black}
.btn-update{background:#28a745}
.btn-cam{background:#ff9800}
.success{text-align:center;color:#00ff99;margin-top:10px}
#error{text-align:center;color:#ff4d4d;margin-top:10px}
#video{width:100%;display:none;border-radius:10px;object-fit:cover;}
#previewContainer{position:relative;width:100%;padding-top:100%;margin-top:10px;}
#preview{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:12px;object-fit:cover;cursor:pointer;}
#cropBox{
  position:absolute;
  border:2px dashed #00ff99;
  width:80px;height:80px;
  cursor:move;
  display:none;
}
.info{text-align:left;color:#ccc;font-size:0.85em;margin:5px 0;}
@media(max-width:480px){
  .container{padding:15px;}
  input, select, button{font-size:0.9em;}
  #cropBox{width:60px;height:60px;}
}

/* ------------------- REGISTERED ALERT ------------------- */
#registeredAlert {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,255,153,0.95);
  color:#000;
  padding:15px 25px;
  border-radius:12px;
  font-size:1.1em;
  text-align:center;
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition: opacity 0.5s ease-in-out;
}
#registeredAlert.show{
  opacity:1;
}
</style>
</head>

<body>
<div class="container">

<h2>Student Registration</h2>

<!-- NAVIGATION BUTTONS -->
<button class="navbtn" onclick="location.href='index.html'">üè† Home</button>
<button class="navbtn" onclick="location.href='schooldetails.html'">üè´ Register School</button>
<button class="navbtn" onclick="location.href='view-all.html'">üìã All Students</button>
<button class="navbtn" onclick="location.href='registerview.html'">üìÑ Register View</button>

<hr>

<!-- STUDENT SEARCH -->
<input id="studentId" placeholder="Admission Number">
<button class="btn-search" onclick="searchStudent()">Search Student</button>

<!-- STUDENT FORM -->
<input id="studentName" placeholder="Student Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option>Loading schools...</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option>Select Class</option></select>
<select id="streamSelect"><option>Select Stream</option></select>

<label>Upload Photo</label>
<input type="file" id="photoUpload" accept="image/*" capture="environment">
<div class="info">
  Supported formats: JPG, PNG. Drag the crop box over the image to select area.
</div>

<button class="btn-cam" onclick="startCamera()">Start Camera</button>
<button class="btn-cam" onclick="capturePhoto()">Capture Photo</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none"></canvas>

<div id="previewContainer">
  <img id="preview" alt="Photo Preview">
  <div id="cropBox"></div>
</div>

<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>

<hr>

<!-- BULK UPLOAD -->
<h3>Bulk Upload Students (Excel)</h3>
<div class="info">
  Format your Excel sheet with columns:<br>
  <b>studentid | studentname | dateofbirth (YYYY-MM-DD) | school | grade | stream</b><br>
  First row should be the header.
</div>
<button class="btn-create" onclick="downloadCSVTemplate()">‚¨á Download CSV Template</button>
<input type="file" id="bulkExcel" accept=".xlsx,.xls,.csv">
<button class="btn-create" onclick="bulkUploadExcel()">Upload Excel</button>

<hr>
<h3>Live Students</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>
<div id="error"></div>

</div>

<!-- REGISTERED ALERT -->
<div id="registeredAlert">‚úÖ Registered Successfully!</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

const el = id => document.getElementById(id);
let schoolsMap = {}, currentStudentId = null, capturedBlob = null, cameraStream = null;
const alertEl = el("registeredAlert");

/* ------------------- ALERT FUNCTION ------------------- */
function showAlert(msg = "‚úÖ Registered Successfully!") {
  alertEl.innerText = msg;
  alertEl.classList.add("show");
  setTimeout(() => alertEl.classList.remove("show"), 2500);
}

/* ------------------- CHECK FOR DUPLICATE ------------------- */
async function checkDuplicate(studentId) {
  const { data, error } = await supabase
    .from("students")
    .select("*")
    .eq("studentid", studentId)
    .single();

  if (error && error.code !== 'PGRST116') {  // No student found
    return false;
  }

  return data !== null;  // Return true if a student with this ID exists
}

/* ------------------- REGISTER STUDENT ------------------- */
window.registerStudent = async () => {
  const studentId = el("studentId").value.trim();
  if (!studentId) return alert("Admission number required");

  const isDuplicate = await checkDuplicate(studentId);
  if (isDuplicate) {
    alert("This admission number is already taken. Please use a different one.");
    return; // Prevent proceeding with registration
  }

  await saveStudent(); // Proceed with the registration if no duplicate
};

/* ------------------- SAVE STUDENT ------------------- */
async function saveStudent(online = true) {
  const id = el("studentId").value.trim();
  if (!id) return alert("Admission number required");
  const photo = await uploadPhoto(id);
  const student = {
    studentid: id,
    studentname: el("studentName").value,
    dateofbirth: el("dateOfBirth").value || null,
    age: Number(el("age").value) || null,
    school: el("schoolSelect").value || null,
    level: el("levelDisplay").value || null,
    grade: el("gradeSelect").value || null,
    stream: el("streamSelect").value || null,
    photo
  };

  if (!navigator.onLine || !online) {
    await saveOffline(student);
    showAlert("‚úÖ Saved Offline!");
  } else {
    const { error } = await supabase.from("students").upsert([student]);
    if (error) {
      await saveOffline(student);
      showAlert("‚úÖ Saved Offline!");
    } else {
      showAlert("‚úÖ Registered Successfully!");
    }
  }
  clearForm();
  loadLiveStudents();
}

/* ------------------- UPLOAD PHOTO ------------------- */
async function uploadPhoto(id) {
  if (!el("preview").src) return null;
  const img = new Image();
  img.src = el("preview").src;
  await img.decode();
  const canvas = el("canvas");
  canvas.width = cropBox.offsetWidth;
  canvas.height = cropBox.offsetHeight;
  const ctx = canvas.getContext("2d");
  const imgRect = el("preview").getBoundingClientRect();
  const scaleX = img.naturalWidth / imgRect.width;
  const scaleY = img.naturalHeight / imgRect.height;
  const sx = cropBox.offsetLeft * scaleX;
  const sy = cropBox.offsetTop * scaleY;
  const sw = cropBox.offsetWidth * scaleX;
  const sh = cropBox.offsetHeight * scaleY;
  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, cropBox.offsetWidth, cropBox.offsetHeight);
  return new Promise(resolve => {
    canvas.toBlob(b => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(b);
    });
  });
}

/* ------------------- CLEAR FORM ------------------- */
function clearForm() {
  currentStudentId = null;
  el("studentId").value = "";
  el("studentName").value = "";
  el("dateOfBirth").value = "";
  el("age").value = "";
  el("schoolSelect").value = "";
  el("schoolSelect").dispatchEvent(new Event("change"));
  el("gradeSelect").value = "";
  el("streamSelect").value = "";
  el("preview").src = "";
  cropBox.style.display = "none";
  capturedBlob = null;
}

/* ------------------- LOAD LIVE STUDENTS ------------------- */
async function loadLiveStudents() {
  const { data, error } = await supabase.from("students").select("*").order("studentid", { ascending: true });
  if (error) return alert("Error loading live students");
  const liveList = el("liveList");
  liveList.innerHTML = data.map(student => `<div>${student.studentid} - ${student.studentname}</div>`).join("");
}

/* ------------------- SEARCH STUDENT ------------------- */
window.searchStudent = async () => {
  const id = el("studentId").value.trim();
  if (!id) return alert("Enter admission number");
  const { data, error } = await supabase.from("students").select("*").eq("studentid", id).single();
  if (error) return alert("Student not found");
  fillForm(data);
};

function fillForm(data) {
  currentStudentId = data.studentid;
  el("studentName").value = data.studentname || "";
  el("dateOfBirth").value = data.dateofbirth || "";
  el("age").value = data.age || "";
  el("schoolSelect").value = data.school || "";
  el("schoolSelect").dispatchEvent(new Event("change"));
  el("gradeSelect").value = data.grade || "";
  el("streamSelect").value = data.stream || "";
  if (data.photo) {
    el("preview").src = data.photo;
    cropBox.style.display = "block";
  }
}

</script>

</body>
</html>
