<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',Arial,sans-serif;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
display:flex;
justify-content:center;
padding-top:20px;
min-height:100vh;
}
.container{
background:rgba(255,255,255,0.12);
padding:30px;
border-radius:20px;
width:560px;
backdrop-filter:blur(15px);
}
input,select,button{
width:100%;
padding:10px;
margin:6px 0;
border:none;
border-radius:10px;
}
button{font-weight:bold;cursor:pointer;}
.btn-create{background:#00c6ff;}
.btn-search{background:#ffc107;color:black;}
.btn-update{background:#28a745;}
.btn-cam{background:#ff9800;}
.btn-bulk{background:#9c27b0;}
.success{text-align:center;color:#00ff99;margin-top:10px;}

.floating-actions{
position:fixed;
top:20px;
left:20px;
display:flex;
gap:12px;
z-index:9999;
}
.float-btn{
padding:10px 18px;
border-radius:14px;
border:none;
font-weight:600;
cursor:pointer;
color:white;
background-size:300% 300%;
animation:gradientMove 6s ease infinite;
box-shadow:0 8px 20px rgba(0,0,0,0.35);
}
.btn-home{background-image:linear-gradient(45deg,#ff416c,#ff4b2b,#ff6a00);}
.btn-school{background-image:linear-gradient(45deg,#00c6ff,#0072ff,#00ffcc);}
@keyframes gradientMove{
0%{background-position:0% 50%;}
50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}

#video{width:100%;border-radius:10px;margin-top:10px;display:none;}
#preview{width:140px;margin-top:10px;border-radius:12px;display:none;}
</style>
</head>

<body>

<div class="floating-actions">
<button class="float-btn btn-home" onclick="location.href='index.html'">‚¨Ö Home</button>
<button class="float-btn btn-school" onclick="location.href='schooldetails.html'">üè´ School</button>
</div>

<div class="container">
<h2>Student Registration</h2>

<input id="studentId" placeholder="Admission Number">
<button class="btn-search" onclick="searchStudent()">üîç Search Student</button>

<input id="studentName" placeholder="Student Full Name">

<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option value="">Select School</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option value="">Select Class</option></select>
<select id="streamSelect"><option value="">Select Stream</option></select>

<label>Student Photo</label>
<input type="file" id="photoUpload" accept="image/*">

<button class="btn-cam" onclick="startCamera()">üì∑ Take Live Photo</button>
<button class="btn-cam" onclick="capturePhoto()">üì∏ Capture</button>

<video id="video" autoplay></video>
<canvas id="canvas" style="display:none;"></canvas>
<img id="preview">

<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>

<hr>

<h3>Bulk Upload Students (Excel)</h3>
<p style="font-size:13px;opacity:.9">
Excel columns must be:<br>
<b>studentId | studentName | dateOfBirth | school | grade | stream</b>
</p>
<input type="file" id="excelFile" accept=".xlsx,.xls">
<button class="btn-bulk" onclick="bulkUpload()">Upload Excel</button>

<hr>
<h3>Live Student List</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase=createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");

const el=id=>document.getElementById(id);
let schoolsMap={},currentStudentId=null,capturedBlob=null,cameraStream=null;

/* AGE */
el("dateOfBirth").onchange=()=>{
const b=new Date(el("dateOfBirth").value);
const t=new Date();
let a=t.getFullYear()-b.getFullYear();
if(t.getMonth()<b.getMonth()||(t.getMonth()==b.getMonth()&&t.getDate()<b.getDate()))a--;
el("age").value=a;
};

/* LOAD SCHOOLS */
const {data:schools}=await supabase.from("schools").select("*");
schools.forEach(s=>{
schoolsMap[s.name]=s;
el("schoolSelect").add(new Option(s.name,s.name));
});

/* SCHOOL CHANGE */
el("schoolSelect").onchange=()=>{
const s=schoolsMap[el("schoolSelect").value];
el("gradeSelect").innerHTML="<option>Select Class</option>";
el("streamSelect").innerHTML="<option>Select Stream</option>";
if(!s)return;
el("levelDisplay").value=s.level||"";
(s.classes||[]).forEach(c=>el("gradeSelect").add(new Option(c,c)));
(s.streams||[]).forEach(st=>el("streamSelect").add(new Option(st,st)));
};

/* SEARCH */
window.searchStudent=async()=>{
const id=el("studentId").value;
if(!id)return alert("Enter ID");

const {data}=await supabase.from("students").select("*").eq("studentId",id).single();
if(!data)return alert("Student not in system");

currentStudentId=data.studentId;
el("studentName").value=data.studentName;
el("dateOfBirth").value=data.dateOfBirth;
el("age").value=data.age;
el("schoolSelect").value=data.school;
el("schoolSelect").onchange();
el("gradeSelect").value=data.grade;
el("streamSelect").value=data.stream;

if(data.photo){
el("preview").src=data.photo;
el("preview").style.display="block";
}
};

/* CAMERA */
window.startCamera=async()=>{
cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
el("video").srcObject=cameraStream;
el("video").style.display="block";
};

window.capturePhoto=()=>{
const v=el("video");
const c=el("canvas");
c.width=v.videoWidth;
c.height=v.videoHeight;
c.getContext("2d").drawImage(v,0,0);
c.toBlob(b=>{
capturedBlob=b;
el("preview").src=URL.createObjectURL(b);
el("preview").style.display="block";
});
};

/* AI FACE + WHITE BG */
async function optimize(file){
return new Promise(res=>{
const img=new Image();
img.onload=async()=>{
const d=await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions());
let sx,sy,size;

if(d){
const b=d.box;
size=Math.max(b.width,b.height)*1.6;
sx=b.x+b.width/2-size/2;
sy=b.y+b.height/2-size/2;
}else{
size=Math.min(img.width,img.height);
sx=(img.width-size)/2;
sy=(img.height-size)/2;
}

sx=Math.max(0,sx);
sy=Math.max(0,sy);
size=Math.min(size,img.width-sx,img.height-sy);

const out=500;
const c=document.createElement("canvas");
c.width=out;
c.height=out;
const ctx=c.getContext("2d");

ctx.fillStyle="white";
ctx.fillRect(0,0,out,out);

ctx.drawImage(img,sx,sy,size,size,0,0,out,out);

c.toBlob(blob=>res(blob),"image/jpeg",0.75);
};
img.src=URL.createObjectURL(file);
});
}

/* UPLOAD PHOTO */
async function uploadPhoto(id){
let f=el("photoUpload").files[0]||capturedBlob;
if(!f)return null;
const opt=await optimize(f);
const path=`students/${id}_${Date.now()}.jpg`;
await supabase.storage.from("photos").upload(path,opt);
return supabase.storage.from("photos").getPublicUrl(path).data.publicUrl;
}

/* REGISTER */
window.registerStudent=async()=>{
const id=el("studentId").value;
if(!id)return alert("ID required");

const {data:exists}=await supabase.from("students").select("studentId").eq("studentId",id).limit(1);
if(exists.length)return alert("Student exists");

const photo=await uploadPhoto(id);

await supabase.from("students").insert([{
studentId:id,
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value,
age:Number(el("age").value),
school:el("schoolSelect").value,
level:el("levelDisplay").value,
grade:el("gradeSelect").value,
stream:el("streamSelect").value,
photo
}]);

el("message").innerText="‚úî Registered";
};

/* UPDATE */
window.updateStudent=async()=>{
if(!currentStudentId)return alert("Search first");

const photo=await uploadPhoto(currentStudentId);

const data={
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value,
age:Number(el("age").value),
school:el("schoolSelect").value,
level:el("levelDisplay").value,
grade:el("gradeSelect").value,
stream:el("streamSelect").value
};
if(photo)data.photo=photo;

await supabase.from("students").update(data).eq("studentId",currentStudentId);
el("message").innerText="‚úî Updated";
};

/* BULK EXCEL */
window.bulkUpload=async()=>{
const file=el("excelFile").files[0];
if(!file)return alert("Upload Excel file");

const data=await file.arrayBuffer();
const wb=XLSX.read(data);
const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

for(const r of rows){
await supabase.from("students").insert([r]);
}

alert("Bulk upload complete");
};

/* REALTIME */
supabase.channel("students")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"students"},
p=>liveList.innerHTML+=`<div>${p.new.studentId} ‚Äî ${p.new.studentName}</div>`)
.subscribe();

/* LOAD LIST */
const {data:list}=await supabase.from("students").select("*").limit(20);
list.forEach(s=>liveList.innerHTML+=`<div>${s.studentId} ‚Äî ${s.studentName}</div>`);
</script>

</body>
</html>
