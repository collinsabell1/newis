<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:linear-gradient(135deg,#141e30,#243b55);
display:flex;
justify-content:center;
padding:20px;
color:white;
}

/* GLASS CONTAINER */
.container{
width:100%;
max-width:600px;
background:rgba(255,255,255,0.1);
backdrop-filter:blur(20px);
border-radius:20px;
padding:25px;
box-shadow:0 8px 30px rgba(0,0,0,.4);
}

/* INPUTS */
input,select{
width:100%;
padding:12px;
margin:6px 0;
border-radius:10px;
border:none;
font-size:15px;
outline:none;
}

/* BUTTONS */
button{
padding:12px;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
color:white;
transition:all .3s ease;
width:100%;
margin:6px 0;
}

button:hover{
transform:translateY(-2px);
box-shadow:0 5px 15px rgba(0,0,0,.3);
}

/* COLORS */
.navbtn{background:linear-gradient(45deg,#00c6ff,#0072ff);}
.btn-search{background:linear-gradient(45deg,#f7971e,#ffd200);color:black;}
.btn-create{background:linear-gradient(45deg,#00b09b,#96c93d);}
.btn-update{background:linear-gradient(45deg,#11998e,#38ef7d);}
.btn-cam{background:linear-gradient(45deg,#fc466b,#3f5efb);}

/* FLEX ROW */
.row{
display:flex;
gap:10px;
flex-wrap:wrap;
}

.row button{
flex:1;
min-width:120px;
}

#video{
width:100%;
display:none;
border-radius:10px;
margin-top:10px;
}

#preview{
width:150px;
border-radius:12px;
margin-top:10px;
display:none;
}

.alert{
margin-top:10px;
padding:10px;
border-radius:8px;
font-weight:bold;
text-align:center;
}

.success{background:#00c851;}
.error{background:#ff4444;}

@media(max-width:480px){
.row{flex-direction:column;}
}
</style>
</head>

<body>
<div class="container">

<h2>Student Registration</h2>

<div class="row">
<button class="navbtn" onclick="location.href='index.html'">üè† Home</button>
<button class="navbtn" onclick="location.href='schooldetails.html'">üè´ Register School</button>
</div>

<hr>

<input id="studentId" placeholder="Admission Number">

<button class="btn-search" onclick="searchStudent()">Search Student</button>

<input id="studentName" placeholder="Student Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option>Loading schools...</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>

<select id="gradeSelect"><option>Select Class</option></select>
<select id="streamSelect"><option>Select Stream</option></select>

<label>Upload Photo</label>
<input type="file" id="photoUpload">

<div class="row">
<button class="btn-cam" onclick="startCamera()">Start Camera</button>
<button class="btn-cam" onclick="capturePhoto()">Capture Photo</button>
</div>

<video id="video" autoplay></video>
<canvas id="canvas" style="display:none"></canvas>
<img id="preview">

<div class="row">
<button class="btn-create" onclick="registerStudent()">Register Student</button>
<button class="btn-update" onclick="updateStudent()">Update Student</button>
</div>

<hr>
<h3>Live Students</h3>
<div id="liveList"></div>

<div id="alertBox"></div>

</div>

<script>

/* ===== SUPABASE CONNECTION ===== */
const supabase = window.supabase.createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"YOUR_PUBLIC_ANON_KEY"
);

const el=id=>document.getElementById(id);
let schoolsMap={},currentStudentId=null,capturedBlob=null,cameraStream=null;

/* ===== ALERT SYSTEM ===== */
function showAlert(msg,type="success"){
const box=el("alertBox");
box.innerHTML=`<div class="alert ${type}">${msg}</div>`;
setTimeout(()=>box.innerHTML="",4000);
}

/* ===== FIXED AGE CALCULATION ===== */
function calcAge(){
const dob=el("dateOfBirth").value;
if(!dob){el("age").value="";return;}

const birth=new Date(dob);
const today=new Date();

let age=today.getFullYear()-birth.getFullYear();
const m=today.getMonth()-birth.getMonth();

if(m<0 || (m===0 && today.getDate()<birth.getDate())){
age--;
}

el("age").value=age>=0?age:"";
}
el("dateOfBirth").addEventListener("change",calcAge);

/* ===== LOAD SCHOOLS WITH ERROR HANDLING ===== */
async function loadSchools(){
try{
const {data,error}=await supabase.from("schools").select("*");
if(error) throw error;

if(!data.length){
showAlert("No schools found","error");
return;
}

el("schoolSelect").innerHTML="<option value=''>Select School</option>";

data.forEach(s=>{
try{
if(typeof s.classes==="string") s.classes=JSON.parse(s.classes||"[]");
if(typeof s.streams==="string") s.streams=JSON.parse(s.streams||"[]");
}catch{}

schoolsMap[s.name]=s;
el("schoolSelect").add(new Option(s.name,s.name));
});

showAlert("Schools Loaded ‚úî");
}catch(err){
showAlert("School Load Error: "+err.message,"error");
}
}
loadSchools();

/* ===== SCHOOL CHANGE ===== */
el("schoolSelect").addEventListener("change",()=>{
const s=schoolsMap[el("schoolSelect").value];

el("gradeSelect").innerHTML="<option>Select Class</option>";
el("streamSelect").innerHTML="<option>Select Stream</option>";

if(!s)return;

el("levelDisplay").value=s.level||"";
(s.classes||[]).forEach(c=>el("gradeSelect").add(new Option(c,c)));
(s.streams||[]).forEach(st=>el("streamSelect").add(new Option(st,st)));
});

/* ===== SEARCH ===== */
async function searchStudent(){
try{
const id=el("studentId").value.trim();
if(!id) return showAlert("Enter admission number","error");

const {data,error}=await supabase
.from("students")
.select("*")
.eq("studentId",id)
.maybeSingle();

if(error) throw error;
if(!data) return showAlert("Student not found","error");

currentStudentId=id;

el("studentName").value=data.studentName||"";
el("dateOfBirth").value=data.dateOfBirth||"";
calcAge();

el("schoolSelect").value=data.school||"";
el("schoolSelect").dispatchEvent(new Event("change"));

el("gradeSelect").value=data.grade||"";
el("streamSelect").value=data.stream||"";

if(data.photo){
el("preview").src=data.photo;
el("preview").style.display="block";
}

showAlert("Student Loaded ‚úî");

}catch(err){
showAlert(err.message,"error");
}
}

/* ===== CAMERA ===== */
async function startCamera(){
cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
el("video").srcObject=cameraStream;
el("video").style.display="block";
}

function capturePhoto(){
const v=el("video"),c=el("canvas");
c.width=v.videoWidth;
c.height=v.videoHeight;
c.getContext("2d").drawImage(v,0,0);

c.toBlob(b=>{
capturedBlob=b;
el("preview").src=URL.createObjectURL(b);
el("preview").style.display="block";
});

cameraStream?.getTracks().forEach(t=>t.stop());
v.style.display="none";
}

/* ===== REGISTER ===== */
async function registerStudent(){
try{
const id=el("studentId").value.trim();
if(!id) return showAlert("Admission number required","error");

const {error}=await supabase.from("students").insert([{
studentId:id,
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value||null,
age:Number(el("age").value)||null,
school:el("schoolSelect").value||null,
level:el("levelDisplay").value||null,
grade:el("gradeSelect").value||null,
stream:el("streamSelect").value||null
}]);

if(error) throw error;

showAlert("Student Registered ‚úî");
}catch(err){
showAlert(err.message,"error");
}
}

/* ===== UPDATE ===== */
async function updateStudent(){
try{
if(!currentStudentId)
return showAlert("Search student first","error");

const {error}=await supabase
.from("students")
.update({
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value||null,
age:Number(el("age").value)||null,
school:el("schoolSelect").value||null,
level:el("levelDisplay").value||null,
grade:el("gradeSelect").value||null,
stream:el("streamSelect").value||null
})
.eq("studentId",currentStudentId);

if(error) throw error;

showAlert("Student Updated ‚úî");
}catch(err){
showAlert(err.message,"error");
}
}

</script>
</body>
</html>
