<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{
margin:0;
font-family:Segoe UI;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
display:flex;
justify-content:center;
padding-top:20px;
}
.container{
background:rgba(255,255,255,.12);
padding:30px;
border-radius:20px;
width:560px;
}
input,select,button{
width:100%;
padding:10px;
margin:6px 0;
border:none;
border-radius:10px;
}
button{font-weight:bold;cursor:pointer}
.btn{background:#00c6ff}
#preview{width:150px;display:none;margin-top:10px;border-radius:12px}
#video{width:100%;display:none}
.success{text-align:center;color:#00ff99}
.error{text-align:center;color:red}
</style>
</head>

<body>
<div class="container">

<h2>Student Registration</h2>

<input id="studentId" placeholder="Admission Number">
<button onclick="searchStudent()">Search</button>

<input id="studentName" placeholder="Full Name">
<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"></select>
<input id="levelDisplay" readonly placeholder="Level">

<select id="gradeSelect"></select>
<select id="streamSelect"></select>

<input type="file" id="photoUpload">

<button onclick="registerStudent()" class="btn">Register</button>
<button onclick="updateStudent()" class="btn">Update</button>
<button onclick="promoteStudents()" class="btn">Auto Promote All</button>

<video id="video" autoplay></video>
<canvas id="canvas" hidden></canvas>
<img id="preview">

<hr>
<div id="liveList"></div>
<div id="msg"></div>

</div>

<script>
const supabase = window.supabase.createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

const el=id=>document.getElementById(id);
let schools={},current=null;

/* MESSAGE */
function msg(t,err=false){
el("msg").innerHTML=t;
el("msg").className=err?"error":"success";
}

/* AGE */
el("dateOfBirth").onchange=()=>{
let b=new Date(el("dateOfBirth").value);
let t=new Date();
let a=t.getFullYear()-b.getFullYear();
if(t.getMonth()<b.getMonth()||(t.getMonth()==b.getMonth()&&t.getDate()<b.getDate()))a--;
el("age").value=a;
};

/* LOAD SCHOOLS */
async function loadSchools(){
msg("Loading schools...");
const {data,error}=await supabase.from("schools").select("*");

if(error){ msg(error.message,true); return; }

el("schoolSelect").innerHTML="<option value=''>Select School</option>";

data.forEach(s=>{
schools[s.name]=s;
el("schoolSelect").add(new Option(s.name,s.name));
});
msg("Schools loaded");
}
loadSchools();

/* SCHOOL CHANGE */
el("schoolSelect").onchange=()=>{
let s=schools[el("schoolSelect").value];
if(!s)return;

el("levelDisplay").value=s.level||"";

el("gradeSelect").innerHTML="";
(s.classes||[]).forEach(c=>el("gradeSelect").add(new Option(c,c)));

el("streamSelect").innerHTML="";
(s.streams||[]).forEach(c=>el("streamSelect").add(new Option(c,c)));
};

/* SEARCH */
async function searchStudent(){
let id=el("studentId").value.trim();
if(!id) return msg("Enter ID",true);

let {data,error}=await supabase.from("students").select("*").eq("studentId",id).maybeSingle();

if(!data){ msg("Student not found",true); return; }

current=id;

el("studentName").value=data.studentName||"";
el("dateOfBirth").value=data.dateOfBirth||"";
el("age").value=data.age||"";
el("schoolSelect").value=data.school||"";
el("schoolSelect").onchange();
el("gradeSelect").value=data.grade||"";
el("streamSelect").value=data.stream||"";

if(data.photo){
el("preview").src=data.photo;
el("preview").style.display="block";
}

msg("Student loaded");
}

/* UPLOAD PHOTO */
async function upload(id){
let f=el("photoUpload").files[0];
if(!f) return null;

let path=`students/${id}_${Date.now()}.jpg`;

let {error}=await supabase.storage.from("photos").upload(path,f);
if(error){ msg(error.message,true); return null; }

return supabase.storage.from("photos").getPublicUrl(path).data.publicUrl;
}

/* REGISTER */
async function registerStudent(){
let id=el("studentId").value.trim();
if(!id) return msg("Enter ID",true);

let photo=await upload(id);

let {error}=await supabase.from("students").insert([{
studentId:id,
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value,
age:Number(el("age").value)||null,
school:el("schoolSelect").value,
level:el("levelDisplay").value,
grade:el("gradeSelect").value,
stream:el("streamSelect").value,
photo
}]);

if(error){ msg(error.message,true); return; }
msg("Registered successfully");
}

/* UPDATE */
async function updateStudent(){
if(!current) return msg("Search student first",true);

let photo=await upload(current);

let obj={
studentName:el("studentName").value,
dateOfBirth:el("dateOfBirth").value,
age:Number(el("age").value)||null,
school:el("schoolSelect").value,
level:el("levelDisplay").value,
grade:el("gradeSelect").value,
stream:el("streamSelect").value
};
if(photo) obj.photo=photo;

let {error}=await supabase.from("students").update(obj).eq("studentId",current);
if(error){ msg(error.message,true); return; }

msg("Updated");
}

/* AUTO PROMOTE */
async function promoteStudents(){
msg("Promoting students...");

let {data}=await supabase.from("students").select("*");

for(let s of data){
let g=parseInt(s.grade);
if(!isNaN(g)) g++;

await supabase.from("students")
.update({grade:g})
.eq("studentId",s.studentId);
}

msg("Promotion complete");
}

/* LIVE LIST */
supabase.channel("live")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"students"},
p=>el("liveList").innerHTML+=`<div>${p.new.studentName}</div>`
).subscribe();
</script>
</body>
</html>
