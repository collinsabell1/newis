<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',Arial,sans-serif;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
display:flex;
justify-content:center;
padding-top:20px;
min-height:100vh;
}
.container{
background:rgba(255,255,255,0.12);
padding:30px;border-radius:20px;width:560px;
backdrop-filter:blur(15px);
}
input,select,button{
width:100%;padding:10px;margin:6px 0;
border:none;border-radius:10px;
}
button{font-weight:bold;cursor:pointer;}
.btn-create{background:#00c6ff;}
.success{text-align:center;color:#00ff99;margin-top:10px;}
</style>
</head>
<body>

<div class="container">
<h2>Student Registration</h2>

<input id="studentId" placeholder="Admission Number (e.g. ADM-001)">
<input id="studentName" placeholder="Student Full Name">

<input type="date" id="dateOfBirth">
<input id="age" placeholder="Age" readonly>

<select id="schoolSelect"><option value="">Select School</option></select>
<input id="levelDisplay" placeholder="School Level" readonly>
<select id="gradeSelect"><option value="">Select Class</option></select>
<select id="streamSelect"><option value="">Select Stream</option></select>

<label>Student Photo</label>
<input type="file" id="photoInput" accept="image/*">

<button class="btn-create" onclick="registerStudent()">Register Student</button>

<hr>

<h3>Scan QR Admission</h3>
<div id="reader" style="width:100%"></div>

<hr>
<h3>Live Student List</h3>
<div id="liveList"></div>

<div id="message" class="success"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"YOUR_API_KEY"
);

/* ELEMENTS */
const schoolSelect=document.getElementById("schoolSelect");
const gradeSelect=document.getElementById("gradeSelect");
const streamSelect=document.getElementById("streamSelect");
const levelDisplay=document.getElementById("levelDisplay");
const studentId=document.getElementById("studentId");
const studentName=document.getElementById("studentName");
const dateOfBirth=document.getElementById("dateOfBirth");
const ageField=document.getElementById("age");
const photoInput=document.getElementById("photoInput");
const message=document.getElementById("message");
const liveList=document.getElementById("liveList");

let schoolsMap={};

/* AGE AUTO CALC */
dateOfBirth.onchange=()=>{
const birth=new Date(dateOfBirth.value);
const today=new Date();
let age=today.getFullYear()-birth.getFullYear();
const m=today.getMonth()-birth.getMonth();
if(m<0|| (m===0 && today.getDate()<birth.getDate())) age--;
ageField.value=age;
};

/* LOAD SCHOOLS */
async function loadSchools(){
const {data}=await supabase.from("schools").select("*");
data.forEach(s=>{
schoolsMap[s.name]=s;
schoolSelect.add(new Option(s.name,s.name));
});
}
loadSchools();

/* SCHOOL CHANGE */
schoolSelect.onchange=()=>{
gradeSelect.innerHTML="<option>Select Class</option>";
streamSelect.innerHTML="<option>Select Stream</option>";

const s=schoolsMap[schoolSelect.value];
if(!s) return;

levelDisplay.value=s.level||"";
(s.classes||[]).forEach(c=>gradeSelect.add(new Option(c,c)));
(s.streams||[]).forEach(st=>streamSelect.add(new Option(st,st)));
};

/* ID FORMAT VALIDATION */
function validId(id){
return /^[A-Za-z0-9\-]{3,20}$/.test(id);
}

/* OFFLINE STORAGE */
function saveOffline(data){
let list=JSON.parse(localStorage.getItem("offlineStudents")||"[]");
list.push(data);
localStorage.setItem("offlineStudents",JSON.stringify(list));
}

/* SYNC OFFLINE */
async function syncOffline(){
let list=JSON.parse(localStorage.getItem("offlineStudents")||"[]");
for(const s of list){
await supabase.from("students").insert([s]);
}
localStorage.removeItem("offlineStudents");
}
window.addEventListener("online",syncOffline);

/* PHOTO UPLOAD */
async function uploadPhoto(id){
const file=photoInput.files[0];
if(!file) return "";

const path=`students/${id}_${Date.now()}`;
await supabase.storage.from("photos").upload(path,file);
const {data}=supabase.storage.from("photos").getPublicUrl(path);
return data.publicUrl;
}

/* REGISTER */
window.registerStudent=async()=>{

if(!validId(studentId.value))
return alert("Invalid ID format");

if(!studentId.value||!studentName.value||!schoolSelect.value||!gradeSelect.value)
return alert("Fill required fields");

/* DUPLICATE CHECK */
const {data:exists}=await supabase
.from("students")
.select("id")
.eq("studentId",studentId.value)
.eq("school",schoolSelect.value)
.limit(1);

if(exists.length) return alert("Duplicate student");

/* PHOTO */
let photo="";
if(photoInput.files.length)
photo=await uploadPhoto(studentId.value);

const payload={
studentId:studentId.value,
studentName:studentName.value,
dateOfBirth:dateOfBirth.value,
age:Number(ageField.value),
school:schoolSelect.value,
level:levelDisplay.value,
grade:gradeSelect.value,
stream:streamSelect.value||"",
photo:photo,
created_at:new Date()
};

try{
await supabase.from("students").insert([payload]);
message.innerText="✔ Student Registered";
}catch{
saveOffline(payload);
message.innerText="⚠ Saved offline (no internet)";
}

studentId.value="";
studentName.value="";
};

/* REALTIME LIVE LIST */
supabase
.channel("students")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"students"},
payload=>{
const s=payload.new;
liveList.innerHTML+=`<div>${s.studentId} — ${s.studentName}</div>`;
})
.subscribe();

/* QR SCANNER */
const scanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250});
scanner.render((text)=>{
studentId.value=text;
});

/* LOAD EXISTING */
async function loadStudents(){
const {data}=await supabase.from("students").select("*").limit(20);
data.forEach(s=>{
liveList.innerHTML+=`<div>${s.studentId} — ${s.studentName}</div>`;
});
}
loadStudents();
</script>
</body>
</html>
