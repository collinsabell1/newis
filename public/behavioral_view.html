<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>All Behavioral Records - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
.container{
  max-width:1300px;
  margin:30px auto;
  padding:30px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
  box-shadow:0 0 40px rgba(0,0,0,0.5);
}
h1{text-align:center;margin-bottom:20px;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:10px;
  text-align:center;
}
th{background:rgba(255,255,255,0.2);}
tr:nth-child(even){background:rgba(255,255,255,0.05);}

button,select,input{
  padding:8px 14px;
  margin:5px;
  border:none;
  border-radius:10px;
  font-weight:bold;
}

.btn-download{background:#00c6ff;color:white;}
.btn-nav{background:#17a2b8;color:white;}
.btn-filter{background:#ffc107;color:black;}
.btn-print{background:#28a745;color:white;}
.btn-delete{background:#dc3545;color:white;}

.green{color:lightgreen;font-weight:bold;}
.yellow{color:yellow;font-weight:bold;}
.red{color:#ff4d4d;font-weight:bold;}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“Š All Students Behavioral Risk Records</h1>

<div style="text-align:center;">
<button class="btn-nav" onclick="window.location.href='behavioral.html'">â¬… Back</button>
<button class="btn-nav" onclick="window.location.href='assessment.html'">Next âž¡</button>
</div>

<br>

<div style="text-align:center;">
<input type="text" id="searchInput" placeholder="Search Admission Number">

<select id="classFilter">
<option value="All">All Classes</option>
</select>

<select id="riskFilter">
<option value="All">All Risk Levels</option>
<option value="High">High Risk (>50%)</option>
<option value="Medium">Moderate Risk (=50%)</option>
<option value="Low">Low Risk (<50%)</option>
</select>

<button class="btn-filter" onclick="renderTable()">Apply</button>
</div>

<br>

<div style="text-align:center;">
<button class="btn-download" onclick="downloadAll()">Download All</button>
<button class="btn-download" onclick="downloadSelected()">Download Selected</button>
<button class="btn-print" onclick="printAll()">Print All</button>
<button class="btn-print" onclick="printSelected()">Print Selected</button>
<button class="btn-delete" onclick="deleteSelected()">Delete Selected</button>
</div>

<table id="recordsTable">
<thead>
<tr>
<th><input type="checkbox" id="selectAll"></th>
<th>Adm No</th>
<th>Name</th>
<th>Class</th>
<th>School</th>
<th>Risk %</th>
<th>Date Recorded</th>
<th>Status</th>
<th>Report</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  collectionGroup,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "newis-96304.firebaseapp.com",
  projectId: "newis-96304",
  storageBucket: "newis-96304.appspot.com",
  messagingSenderId: "695908769426",
  appId: "1:695908769426:web:dc0db0866cbdaa4fb6d04b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allData = [];

/* ================= FAST LOAD DATA ================= */
async function loadData(){

  allData = [];
  const classSet = new Set();

  const studentsSnap = await getDocs(collection(db,"students"));
  const studentMap = new Map();

  studentsSnap.forEach(docSnap=>{
    const s = docSnap.data();
    studentMap.set(docSnap.id, s);
    if(s.grade) classSet.add(s.grade);
  });

  const behavioralSnap = await getDocs(collectionGroup(db,"behavioral"));

  behavioralSnap.forEach(docSnap=>{

    if(docSnap.id !== "record") return;

    const studentId = docSnap.ref.parent.parent.id;
    const student = studentMap.get(studentId);
    if(!student) return;

    const b = docSnap.data();
    const riskScore = Number(b.riskPercent ?? 0);

    let status = "Low Risk";
    if(riskScore > 50) status="High Risk";
    else if(riskScore === 50) status="Moderate Risk";

    let recordedDate = new Date();
    if(b.dateRecorded?.toDate){
      recordedDate = b.dateRecorded.toDate();
    } else if(b.dateRecorded){
      recordedDate = new Date(b.dateRecorded);
    }

    allData.push({
      id: studentId,
      adm: student.studentId || "",
      name: student.studentName || "",
      class: student.grade || "",
      school: student.school || "",
      risk: riskScore,
      date: recordedDate,
      status
    });

  });

  populateClassFilter(classSet);
  renderTable();
}

/* ================= CLASS FILTER ================= */
function populateClassFilter(classSet){
  const classFilter = document.getElementById("classFilter");
  classFilter.innerHTML = `<option value="All">All Classes</option>`;
  [...classSet].sort().forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c;
    opt.textContent=c;
    classFilter.appendChild(opt);
  });
}

/* ================= RENDER TABLE ================= */
window.renderTable = function(){

  const search=document.getElementById("searchInput").value.toLowerCase();
  const selectedClass=document.getElementById("classFilter").value;
  const riskFilter=document.getElementById("riskFilter").value;
  const tbody=document.querySelector("#recordsTable tbody");

  tbody.innerHTML="";
  document.getElementById("selectAll").checked=false;

  const filtered=allData.filter(r=>{
    if(search && !r.adm.toLowerCase().includes(search)) return false;
    if(selectedClass!=="All" && r.class!==selectedClass) return false;
    if(riskFilter==="High" && r.risk<=50) return false;
    if(riskFilter==="Medium" && r.risk!==50) return false;
    if(riskFilter==="Low" && r.risk>=50) return false;
    return true;
  }).sort((a,b)=>b.risk-a.risk);

  filtered.forEach(r=>{
    const colorClass=
      r.risk>50?"red":
      r.risk===50?"yellow":
      "green";

    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td><input type="checkbox" class="rowCheck" data-id="${r.id}"></td>
      <td>${r.adm}</td>
      <td>${r.name}</td>
      <td>${r.class}</td>
      <td>${r.school}</td>
      <td class="${colorClass}">${r.risk}%</td>
      <td>${r.date.toLocaleDateString()}</td>
      <td>${r.status}</td>
      <td><button class="btn-print">Print</button></td>
    `;

    tr.querySelector(".btn-print")
      .addEventListener("click",()=>printReport(r));

    tbody.appendChild(tr);
  });
};

/* ================= SELECT ALL ================= */
document.getElementById("selectAll").addEventListener("change",function(){
  document.querySelectorAll(".rowCheck")
    .forEach(cb=>cb.checked=this.checked);
});

/* ================= DELETE SELECTED ================= */
window.deleteSelected = async () => {

  const selectedIds=[...document.querySelectorAll(".rowCheck:checked")]
    .map(cb=>cb.dataset.id);

  if(!selectedIds.length){
    alert("No records selected");
    return;
  }

  if(!confirm(`Delete ${selectedIds.length} behavioral record(s)? This cannot be undone.`)) return;

  for(const studentId of selectedIds){
    await deleteDoc(doc(db,"students",studentId,"behavioral","record"));
  }

  alert("Selected records deleted successfully");
  loadData();
};

/* ================= CSV DOWNLOAD ================= */
function downloadCSV(rows, filename){
  if(!rows.length) return alert("No data!");

  const header="AdmNo,Name,Class,School,Risk%,Status,Date\n";
  const csv=rows.map(r=>
    `${r.adm},${r.name},${r.class},${r.school},${r.risk},${r.status},${r.date.toLocaleDateString()}`
  ).join("\n");

  const blob=new Blob([header+csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}

window.downloadAll=()=>downloadCSV(allData,"All_Behavioral_Records.csv");

window.downloadSelected=()=>{
  const selectedIds=[...document.querySelectorAll(".rowCheck:checked")]
    .map(cb=>cb.dataset.id);

  const selected=allData.filter(r=>selectedIds.includes(r.id));
  downloadCSV(selected,"Selected_Behavioral_Records.csv");
};

/* ================= PRINT ================= */
window.printReport=(data)=>{
  const win=window.open("","_blank");
  win.document.write(`<h2>Behavioral Risk Report</h2>${generateReport([data])}`);
};

window.printAll=()=>{
  const win=window.open("","_blank");
  win.document.write(`<h2>All Behavioral Records</h2>${generateReport(allData)}`);
};

window.printSelected=()=>{
  const selectedIds=[...document.querySelectorAll(".rowCheck:checked")]
    .map(cb=>cb.dataset.id);
  const selected=allData.filter(r=>selectedIds.includes(r.id));
  const win=window.open("","_blank");
  win.document.write(`<h2>Selected Behavioral Records</h2>${generateReport(selected)}`);
};

function generateReport(dataArray){
  let html="";
  dataArray.forEach(r=>{
    html+=`
      <hr>
      <p><b>Admission:</b> ${r.adm}</p>
      <p><b>Name:</b> ${r.name}</p>
      <p><b>Class:</b> ${r.class}</p>
      <p><b>School:</b> ${r.school}</p>
      <p><b>Risk:</b> ${r.risk}%</p>
      <p><b>Status:</b> ${r.status}</p>
      <p><b>Date:</b> ${r.date.toLocaleDateString()}</p>
    `;
  });
  html+=`<br><button onclick="window.print()">Print</button>`;
  return html;
}

/* ================= START ================= */
loadData();
</script>

</body>
</html>
