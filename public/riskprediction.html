<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEWIS AI Dropout Risk Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

  <style>
    /* Same styles as you provided */
    /* Add your styles here */
  </style>
</head>
<body>
  <div class="container">
    <div class="top-widget">
      <h2>NEWIS AI Dropout Risk Dashboard</h2>
      <div class="controls">
        <input id="studentId" placeholder="Admission Number (numeric)">
        <button onclick="loadStudent()">Load</button>
        <button onclick="location.reload()">Refresh</button>
      </div>
    </div>

    <div class="details-card">
      <p><b>Name:</b> <span id="studentName">-</span></p>
      <p><b>Class:</b> <span id="studentClass">-</span></p>
      <p><b>School:</b> <span id="studentSchool">-</span></p>
    </div>

    <div class="summary">
      <div id="academicCard" class="summary-card">Academic</div>
      <div id="behaviorCard" class="summary-card">Behavior</div>
      <div id="socialCard" class="summary-card">Social + Socioeconomic</div>
      <div id="finalCard" class="summary-card">Overall</div>
    </div>

    <div class="chart-card">
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <div id="predictionCard" class="prediction-card">
    <div id="predTitle" class="pred-title"></div>
    <div id="predMeta" class="pred-meta"></div>
    <div id="completionTag" class="confidence"></div>
    <div id="dropoutTag" class="confidence"></div>
    <div class="explain">
      Overall = (Academic × 0.4) + (Behavior × 0.3) + (Social × 0.3)
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Initialize Supabase
    const supabase = createClient(
      "https://xnvnskxcsphbvkxhndui.supabase.co",
      "YOUR_SUPABASE_ANON_KEY"
    );

    let chart;

    // Safety function to make sure values are in the range 0-100
    const safe = v => Math.max(0, Math.min(100, Number(v) || 0));

    // Load Student by ID
    async function loadStudent() {
      const adm = document.getElementById("studentId").value.trim();
      if (!adm) return alert("Enter Admission Number");

      // Load student details
      const { data: student, error: studentErr } = await supabase
        .from("students")
        .select("*")
        .eq("studentid", adm)
        .single();

      if (studentErr || !student) return alert("Student not found");

      document.getElementById("studentName").textContent = student.studentname || "-";
      document.getElementById("studentClass").textContent = student.grade || "-";
      document.getElementById("studentSchool").textContent = student.school || "-";

      // Load academic details
      const { data: acad } = await supabase
        .from("academics")
        .select("*")
        .eq("student_id", student.id)
        .single();

      const term1 = safe(acad?.term1);
      const term2 = safe(acad?.term2);
      const term3 = safe(acad?.term3);
      const academicAvg = Math.round((term1 + term2 + term3) / 3);

      // Load behavior details
      const { data: behavior } = await supabase
        .from("behavior")
        .select("*")
        .eq("student_id", student.id)
        .single();

      const attendanceDays = behavior?.total_days || 0;
      const presentDays = behavior?.days_present || 0;
      const absent = Math.max(0, attendanceDays - presentDays);
      const attendanceRisk = attendanceDays ? (absent * 100 / attendanceDays) * 0.2 : 0;
      const behaviorRisk = (behavior?.behavior_risks?.length || 0) * (80 / 10);
      const behaviorTotal = Math.round(attendanceRisk + behaviorRisk);

      // Load social risk details
      let socialRisk = safe(student.social_risk);

      // Load socioeconomic details
      const { data: socio } = await supabase
        .from("socioeconomic")
        .select("*")
        .eq("student_id", student.id)
        .single();

      const socioRisk = safe(socio?.risk);
      if (socioRisk) socialRisk = Math.round((socialRisk + socioRisk) / 2);

      // Calculate overall risk
      const overall = Math.round(academicAvg * 0.4 + behaviorTotal * 0.3 + socialRisk * 0.3);

      // Update UI with the fetched data
      updateCard("academicCard", academicAvg);
      updateCard("behaviorCard", behaviorTotal);
      updateCard("socialCard", socialRisk);
      updateCard("finalCard", overall);

      // Draw chart with the fetched data
      drawChart(academicAvg, behaviorTotal, socialRisk, overall);

      // Predict dropout outcome
      predictOutcome(overall, student.grade);
    }

    // Update each card with a value and a corresponding color
    function updateCard(id, val) {
      const el = document.getElementById(id);
      el.textContent = el.textContent.split(" ")[0] + " " + val + "%";
      el.className = "summary-card " + (val < 35 ? "green" : val < 60 ? "yellow" : "red");
    }

    // Draw the chart using Chart.js
    function drawChart(a, b, c, o) {
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
          labels: ["Academic", "Behavior", "Social + Socioeconomic", "Overall"],
          datasets: [
            {
              data: [a, b, c, o],
              backgroundColor: ["#1abc9c", "#3498db", "#9b59b6", "#e74c3c"]
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              min: 0,
              max: 100
            }
          }
        }
      });
    }

    // Predict dropout risk based on overall score
    function predictOutcome(risk, grade) {
      const card = document.getElementById("predictionCard");
      card.style.display = "block";
      let status, color;
      if (risk <= 35) {
        status = "LIKELY TO COMPLETE";
        color = "linear-gradient(135deg, #11998e, #38ef7d)";
      } else if (risk <= 60) {
        status = "COMPLETION AT RISK";
        color = "linear-gradient(135deg, #f7971e, #ffd200)";
      } else {
        status = "HIGH DROPOUT RISK";
        color = "linear-gradient(135deg, #cb2d3e, #ef473a)";
      }
      card.style.background = color;
      document.getElementById("predTitle").textContent = status;
      document.getElementById("predMeta").textContent = "Class: " + grade;
      document.getElementById("completionTag").textContent = status;
      document.getElementById("dropoutTag").textContent = "Overall Risk: " + risk + "%";
    }
  </script>
</body>
</html>
