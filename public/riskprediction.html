<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEWIS AI Dropout Risk Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

<style>
:root{
  --primary:#134E5E;
  --green:#28a745;
  --yellow:#ffc107;
  --red:#dc3545;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#134E5E,#71B280);
  color:#111;
}
.container{
  padding:15px;
  padding-bottom:160px;
  max-width:1100px;
  margin:auto;
}
.top-widget{
  background:#fff;
  padding:15px;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.2);
}
.top-widget h2{
  margin:0;
  font-size:1.2rem;
  text-align:center;
}
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.controls input{
  flex:1;
  min-width:140px;
}
.controls button{
  flex:1;
  min-width:90px;
}
input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
.details-card{
  background:#203a43;
  color:#fff;
  padding:15px;
  border-radius:12px;
  margin:15px 0;
  font-size:14px;
}
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
}
.summary-card{
  padding:16px;
  border-radius:12px;
  text-align:center;
  font-weight:bold;
  color:#fff;
}
.green{background:var(--green);}
.yellow{background:var(--yellow);color:#000;}
.red{background:var(--red);}
.chart-card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-top:15px;
  height:300px;
}
canvas{width:100%!important;height:100%!important;}
.prediction-card{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:15px;
  width:95%;
  max-width:420px;
  padding:18px;
  border-radius:20px;
  color:#fff;
  display:none;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}
.pred-title{font-weight:900;font-size:18px;}
.pred-meta{font-size:13px;margin:6px 0;}
.confidence{
  display:inline-block;
  padding:6px 12px;
  border-radius:12px;
  font-size:12px;
  font-weight:bold;
  margin:4px 4px 0 0;
}
.explain{
  margin-top:10px;
  font-size:12px;
  background:rgba(255,255,255,.15);
  padding:10px;
  border-radius:10px;
}
@media(min-width:768px){
  .top-widget{
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
  }
  .top-widget h2{text-align:left;}
}
</style>
</head>

<body>
<div class="container">

<div class="top-widget">
  <h2>AI Dropout Risk Dashboard</h2>
  <div class="controls">
    <input id="studentId" placeholder="Admission Number">
    <button onclick="loadStudent()">Load</button>
    <button onclick="location.reload()">Refresh</button>
  </div>
</div>

<div class="details-card">
  <p><b>Name:</b> <span id="studentName">-</span></p>
  <p><b>Class:</b> <span id="studentClass">-</span></p>
  <p><b>School:</b> <span id="studentSchool">-</span></p>
</div>

<div class="summary">
  <div id="academicCard" class="summary-card">Academic</div>
  <div id="behaviourCard" class="summary-card">Behaviour</div>
  <div id="socialCard" class="summary-card">Social</div>
  <div id="finalCard" class="summary-card">Overall</div>
</div>

<div class="chart-card">
  <canvas id="barChart"></canvas>
</div>

</div>

<div id="predictionCard" class="prediction-card">
  <div id="predTitle" class="pred-title"></div>
  <div id="predMeta" class="pred-meta"></div>
  <div id="completionTag" class="confidence"></div>
  <div id="dropoutTag" class="confidence"></div>
  <div class="explain">
    Overall = (Academic Ã— 0.4) + (Behaviour Ã— 0.3) + (Social Ã— 0.3)
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

// ðŸ”¹ Supabase config
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
)

const safe=v=>Math.max(0,Math.min(100,Number(v)||0))
let chart

async function loadStudent(){
  const adm=document.getElementById("studentId").value.trim()
  if(!adm) return alert("Enter Admission Number")

  const {data:student,error}=await supabase
    .from("students")
    .select("*")
    .eq("studentid",adm)
    .single()

  if(error||!student) return alert("Student not found")

  document.getElementById("studentName").textContent=student.studentname
  document.getElementById("studentClass").textContent=student.grade
  document.getElementById("studentSchool").textContent=student.school||"-"

  const academicRisk=safe(student.academic_risk||0)
  const behaviour=safe(student.behaviour_risk||0)
  const social=safe(student.social_risk||0)

  const overall=safe(
    academicRisk*0.4+
    behaviour*0.3+
    social*0.3
  )

  updateCard("academicCard",academicRisk)
  updateCard("behaviourCard",behaviour)
  updateCard("socialCard",social)
  updateCard("finalCard",overall)

  drawChart(academicRisk,behaviour,social,overall)
  predictOutcome(overall,student.grade)
}

function updateCard(id,val){
  const el=document.getElementById(id)
  el.textContent=el.textContent.split(" ")[0]+" "+val+"%"
  el.className="summary-card "+(val<35?"green":val<60?"yellow":"red")
}

function drawChart(a,b,c,o){
  if(chart) chart.destroy()
  chart=new Chart(document.getElementById("barChart"),{
    type:"bar",
    data:{
      labels:["Academic","Behaviour","Social","Overall"],
      datasets:[{
        data:[a,b,c,o],
        backgroundColor:["#1abc9c","#3498db","#9b59b6","#e74c3c"]
      }]
    },
    options:{responsive:true,scales:{y:{min:0,max:100}}}
  })
}

function predictOutcome(risk,grade){
  const card=document.getElementById("predictionCard")
  card.style.display="block"

  let status,color
  if(risk<=35){
    status="LIKELY TO COMPLETE"
    color="linear-gradient(135deg,#11998e,#38ef7d)"
  }else if(risk<=60){
    status="COMPLETION AT RISK"
    color="linear-gradient(135deg,#f7971e,#ffd200)"
  }else{
    status="HIGH DROPOUT RISK"
    color="linear-gradient(135deg,#cb2d3e,#ef473a)"
  }

  card.style.background=color
  document.getElementById("predTitle").textContent=status
  document.getElementById("predMeta").textContent="Class: "+grade
  document.getElementById("completionTag").textContent=status
  document.getElementById("dropoutTag").textContent="Overall Risk: "+risk+"%"
}
</script>

</body>
</html>
