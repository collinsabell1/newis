<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEWIS AI Dropout Risk Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

<style>
:root{
  --primary:#134E5E;
  --green:#28a745;
  --yellow:#ffc107;
  --red:#dc3545;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#134E5E,#71B280);
  color:#fff;
}
.container{
  padding:15px;
  max-width:1100px;
  margin:auto;
}
.top-widget{
  background:#fff;
  color:#111;
  padding:15px;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.2);
}
.top-widget h2{
  margin:0;
  font-size:1.4rem;
  text-align:center;
}
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.controls input{
  flex:1;
  min-width:140px;
}
.controls button{
  flex:1;
  min-width:90px;
}
input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
.details-card{
  background:rgba(0,0,0,.4);
  color:#fff;
  padding:15px;
  border-radius:12px;
  margin:15px 0;
  font-size:14px;
}
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
}
.summary-card{
  padding:16px;
  border-radius:12px;
  text-align:center;
  font-weight:bold;
  color:#fff;
}
.green{background:var(--green);}
.yellow{background:var(--yellow);color:#000;}
.red{background:var(--red);}
.chart-card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-top:15px;
  height:300px;
  color:#111;
}
canvas{width:100%!important;height:100%!important;}
.prediction-card{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:15px;
  width:95%;
  max-width:420px;
  padding:18px;
  border-radius:20px;
  color:#fff;
  display:none;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}
.pred-title{font-weight:900;font-size:18px;}
.pred-meta{font-size:13px;margin:6px 0;}
.confidence{
  display:inline-block;
  padding:6px 12px;
  border-radius:12px;
  font-size:12px;
  font-weight:bold;
  margin:4px 4px 0 0;
}
.explain{
  margin-top:10px;
  font-size:12px;
  background:rgba(255,255,255,.15);
  padding:10px;
  border-radius:10px;
}
@media(min-width:768px){
  .top-widget{
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
  }
  .top-widget h2{text-align:left;}
}
</style>
</head>
<body>
<div class="container">

<div class="top-widget">
  <h2>NEWIS AI Dropout Risk Dashboard</h2>
  <div class="controls">
    <input id="studentId" placeholder="Admission Number (numeric)">
    <button onclick="loadStudent()">Load</button>
    <button onclick="location.reload()">Refresh</button>
  </div>
</div>

<div class="details-card">
  <p><b>Name:</b> <span id="studentName">Missing</span></p>
  <p><b>Class:</b> <span id="studentClass">Missing</span></p>
  <p><b>School:</b> <span id="studentSchool">Missing</span></p>
</div>

<div class="summary">
  <div id="academicCard" class="summary-card">Academic</div>
  <div id="behaviorCard" class="summary-card">Behavior</div>
  <div id="socialCard" class="summary-card">Social + Socioeconomic</div>
  <div id="finalCard" class="summary-card">Overall</div>
</div>

<div class="chart-card">
  <canvas id="barChart"></canvas>
</div>

</div>

<div id="predictionCard" class="prediction-card">
  <div id="predTitle" class="pred-title"></div>
  <div id="predMeta" class="pred-meta"></div>
  <div id="completionTag" class="confidence"></div>
  <div id="dropoutTag" class="confidence"></div>
  <div class="explain">
    Overall = (Academic × 0.4) + (Behavior × 0.3) + (Social × 0.3)
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ----------------- SUPABASE -----------------
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

let chart;
const safe = v => Math.max(0, Math.min(100, Number(v)||0));

async function loadStudent() {
  const adm = document.getElementById("studentId").value.trim();
  if(!adm) return alert("Enter Admission Number");

  // ------------------- Load student -------------------
  const { data: student, error: studentErr } = await supabase
    .from("students").select("*").eq("studentid", adm).single();
  if(studentErr || !student) return alert("Student not found");

  document.getElementById("studentName").textContent = student.studentname || "Missing";
  document.getElementById("studentClass").textContent = student.grade || "Missing";
  document.getElementById("studentSchool").textContent = student.school || "Missing";

  // ------------------- Load Academics -------------------
  const { data: acad } = await supabase
    .from("academics").select("*").eq("student_id", student.id).single();
  const term1 = safe(acad?.term1);
  const term2 = safe(acad?.term2);
  const term3 = safe(acad?.term3);
  const academicAvg = Math.round((term1 + term2 + term3)/3);

  // ------------------- Load Behavior -------------------
  const { data: behavior } = await supabase
    .from("behavior").select("*").eq("student_id", student.id).single();
  const attendanceDays = behavior?.total_days || 0;
  const presentDays = behavior?.days_present || 0;
  const absent = Math.max(0, attendanceDays - presentDays);
  const attendanceRisk = attendanceDays ? (absent*100/attendanceDays)*0.2 : 0;
  const behaviorRisk = (behavior?.behavior_risks?.length || 0) * (80/10);
  const behaviorTotal = Math.round(attendanceRisk + behaviorRisk);

  // ------------------- Load Social Risk -------------------
  let socialRisk = safe(student.social_risk);

  // ------------------- Load Socioeconomic -------------------
  const { data: socio } = await supabase
    .from("socioeconomic").select("*").eq("student_id", student.id).single();
  const socioRisk = safe(socio?.risk);
  if(socioRisk) socialRisk = Math.round((socialRisk + socioRisk)/2);

  // ------------------- Overall -------------------
  const overall = Math.round(academicAvg*0.4 + behaviorTotal*0.3 + socialRisk*0.3);

  // ------------------- Update Cards -------------------
  updateCard("academicCard", academicAvg);
  updateCard("behaviorCard", behaviorTotal);
  updateCard("socialCard", socialRisk);
  updateCard("finalCard", overall);

  // ------------------- Draw Chart -------------------
  drawChart(academicAvg, behaviorTotal, socialRisk, overall);

  // ------------------- Predict Outcome -------------------
  predictOutcome(overall, student.grade);
}

function updateCard(id, val) {
  const el = document.getElementById(id);
  if (val === undefined || val === null) {
    el.textContent = "Missing";
    el.className = "summary-card red"; // Red for missing values
  } else {
    el.textContent = el.textContent.split(" ")[0] + " " + val + "%";
    el.className = "summary-card " + (val < 35 ? "green" : val < 60 ? "yellow" : "red");
  }
}

function drawChart(a, b, c, o) {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: ["Academic", "Behavior", "Social + Socioeconomic", "Overall"],
      datasets: [{
        data: [a || 0, b || 0, c || 0, o || 0],
        backgroundColor: ["#1abc9c", "#3498db", "#9b59b6", "#e74c3c"]
      }]
    },
    options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
  });
}

function predictOutcome(overall, grade) {
  const predictionCard = document.getElementById("predictionCard");
  const predTitle = document.getElementById("predTitle");
  const predMeta = document.getElementById("predMeta");
  const completionTag = document.getElementById("completionTag");
  const dropoutTag = document.getElementById("dropoutTag");

  if (overall > 75) {
    predTitle.textContent = "Low Risk of Dropout";
    predMeta.textContent = `Your student's risk is currently at ${overall}%`;
    completionTag.textContent = "Stay the course!";
    dropoutTag.textContent = "";
  } else if (overall > 50) {
    predTitle.textContent = "Moderate Risk of Dropout";
    predMeta.textContent = `Your student's risk is currently at ${overall}%`;
    completionTag.textContent = "Intervention needed!";
    dropoutTag.textContent = "";
  } else {
    predTitle.textContent = "High Risk of Dropout";
    predMeta.textContent = `Your student's risk is currently at ${overall}%`;
    completionTag.textContent = "Immediate action required!";
    dropoutTag.textContent = "Consider counseling and support.";
  }

  predictionCard.style.display = "block";
}
</script>
</body>
</html>
