<!DOCTYPE html>
<html lang="en">
<head>
  <title>Behavioral Risk Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #141e30, #243b55);
      color: white;
    }
    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 30px;
      background: rgba(255,255,255,0.08);
      border-radius: 20px;
      backdrop-filter: blur(15px);
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }
    h2 { text-align:center; margin-bottom:25px; }
    .grid {
      display:grid;
      grid-template-columns:1fr;
      gap:25px;
    }
    @media(min-width:992px){
      .grid{ grid-template-columns:1fr 1fr; }
    }
    .section{
      padding:20px;
      border-radius:15px;
      background:rgba(255,255,255,0.1);
    }
    input[type="text"]{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      margin-bottom:12px;
    }
    input[readonly]{
      background:#e0e0e0;
      font-weight:bold;
    }
    .checkbox-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }
    @media(min-width:600px){
      .checkbox-grid{ grid-template-columns:1fr 1fr; }
    }
    .button-area{
      text-align:center;
      margin-top:25px;
    }
    button{
      padding:10px 18px;
      margin:6px;
      border:none;
      border-radius:10px;
      font-weight:bold;
      cursor:pointer;
    }
    .save{ background:#28a745; color:white; }
    .update{ background:#ffc107; }
    .delete{ background:#dc3545; color:white; }
    .circular{
      width:200px;
      height:200px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:32px;
      font-weight:bold;
      margin:30px auto;
    }
    .green{ background:#28a745; }
    .yellow{ background:#ffc107; color:black; }
    .red{ background:#dc3545; }
  </style>
</head>

<body>
<div class="container">
  <h2>Behavioral Risk Assessment</h2>

  <div class="grid">
    <div class="section">
      <label>Enter Admission Number:</label>
      <input type="text" id="studentId" placeholder="Enter Admission Number">

      <!-- ONLY NAME & GENDER -->
      <input type="text" id="studentName" readonly placeholder="Student Name">
      <input type="text" id="studentGender" readonly placeholder="Gender">
    </div>

    <div class="section">
      <h3>Behavioral Indicators</h3>
      <div class="checkbox-grid" id="checklist"></div>
    </div>
  </div>

  <div id="circle" class="circular green">0%</div>

  <div class="button-area">
    <button class="save" onclick="saveRecord()">Save</button>
    <button class="update" onclick="updateRecord()">Update</button>
    <button class="delete" onclick="deleteRecord()">Delete</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* SUPABASE CONNECTION */
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

/* STRICTLY BEHAVIORAL FACTORS ONLY */
const risks = [
  "Chronic absenteeism",
  "Frequent lateness",
  "Truancy",
  "Bullying others",
  "Fighting in school",
  "Drug abuse",
  "Alcohol abuse",
  "Theft",
  "Disrespect",
  "Dishonesty",
  "Incomplete assignments",
  "Repeated discipline cases",
  "Lack of focus in class",
  "Sexual harassment",
  "Gang involvement",
  "Running away from school",
  "Non-compliance with school rules",
  "Excessive phone usage",
  "Dormitory misconduct"
];

/* CREATE CHECKBOXES */
const checklist = document.getElementById("checklist");
risks.forEach(r => {
  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="neg"> ${r}`;
  checklist.appendChild(label);
});

let currentId = null;

/* FETCH ONLY NAME & GENDER */
document.getElementById("studentId").addEventListener("change", async (e) => {
  const id = e.target.value.trim();
  if (!id) return;

  const { data, error } = await supabase
    .from("students")
    .select("studentid, name, gender")
    .eq("studentid", id)
    .single();

  if (error || !data) {
    alert("Student not found.");
    return;
  }

  currentId = data.studentid;
  document.getElementById("studentName").value = data.name || "";
  document.getElementById("studentGender").value = data.gender || "";

  loadBehavior();
});

/* CALCULATE % */
function calculate(){
  const checked = document.querySelectorAll(".neg:checked").length;
  const percent = (checked / risks.length) * 100;

  const circle = document.getElementById("circle");
  circle.innerHTML = percent.toFixed(1) + "%";

  circle.className = "circular " +
    (percent > 60 ? "red" :
     percent > 40 ? "yellow" :
     "green");

  return percent;
}

document.addEventListener("change", (e)=>{
  if(e.target.classList.contains("neg")) calculate();
});

/* LOAD EXISTING RECORD */
async function loadBehavior(){
  const { data } = await supabase
    .from("behavior")
    .select("*")
    .eq("student_id", currentId)
    .single();

  if(!data) return;

  document.querySelectorAll(".neg").forEach(cb=>{
    cb.checked = data.risks?.includes(
      cb.parentElement.textContent.trim()
    );
  });

  calculate();
}

/* SAVE / UPDATE */
window.saveRecord = async ()=>{
  if(!currentId) return alert("Enter admission number first.");

  const percent = calculate();
  const risksList = [...document.querySelectorAll(".neg:checked")]
    .map(cb=>cb.parentElement.textContent.trim());

  const { error } = await supabase
    .from("behavior")
    .upsert({
      student_id: currentId,
      behaviorrisk: percent,
      risks: risksList,
      recorded_at: new Date().toISOString()
    }, { onConflict: "student_id" });

  if(error) alert("Error saving: " + error.message);
  else alert("Record saved successfully!");
};

window.updateRecord = window.saveRecord;

/* DELETE */
window.deleteRecord = async ()=>{
  if(!currentId) return;
  if(!confirm("Delete record?")) return;

  await supabase
    .from("behavior")
    .delete()
    .eq("student_id", currentId);

  document.querySelectorAll(".neg").forEach(cb=>cb.checked=false);
  calculate();
  alert("Record deleted successfully!");
};
</script>
</body>
</html>
