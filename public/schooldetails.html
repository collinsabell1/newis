<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Manager - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
 --bg1:#0f2027;
 --bg2:#203a43;
 --bg3:#2c5364;
 --glass:rgba(255,255,255,0.12);
 --text:white;
}
.light{
 --bg1:#f2f7ff;
 --bg2:#dbeafe;
 --bg3:#c7d2fe;
 --glass:rgba(255,255,255,0.85);
 --text:#111;
}
body{
 margin:0;
 font-family:Segoe UI;
 background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
 color:var(--text);
 display:flex;
 justify-content:center;
 padding:20px;
}
.container{
 width:720px;
 background:var(--glass);
 padding:25px;
 border-radius:20px;
 backdrop-filter:blur(15px);
}
input,select,button{
 width:100%;
 padding:10px;
 margin:6px 0;
 border:none;
 border-radius:10px;
}
button{cursor:pointer;font-weight:bold}
.btn{background:#00c6ff;color:white}
.btn-edit{background:#28a745;color:white}
.btn-danger{background:#dc3545;color:white}
.btn-clear{background:#6c757d;color:white}
.item-list{display:flex;flex-wrap:wrap;gap:6px}
.item{background:rgba(0,0,0,.4);padding:5px 10px;border-radius:12px;}
.spinner{display:none;text-align:center}
.search-results{
 background:#111;
 border-radius:10px;
 max-height:150px;
 overflow:auto;
 position:absolute;
 width:85%;
 z-index:99;
}
.stats{
 background:rgba(0,0,0,.4);
 padding:10px;
 border-radius:10px;
 margin-top:15px;
}
.back-btn{
position:fixed;
top:20px;
left:20px;
padding:12px 18px;
border:none;
border-radius:14px;
font-weight:600;
cursor:pointer;
color:white;
background:linear-gradient(45deg,#ff416c,#ff4b2b,#ff6a00);
background-size:300% 300%;
animation:gradientMove 6s ease infinite;
box-shadow:0 8px 20px rgba(0,0,0,.35);
z-index:9999;
}
@keyframes gradientMove{
0%{background-position:0% 50%}
50%{background-position:100% 50%}
100%{background-position:0% 50%}
}
</style>
</head>

<body>

<button class="back-btn" onclick="goBack()">‚¨Ö Back</button>

<div class="container">

<button onclick="toggleTheme()">Toggle Theme</button>

<h2>School Manager</h2>

<input id="searchName" placeholder="Search school...">
<div id="results" class="search-results"></div>

<input id="schoolName" placeholder="School Name">

<select id="schoolLevel">
<option value="">Level</option>
<option>Pre-primary</option>
<option>Primary</option>
<option>Junior Secondary</option>
<option>Senior Secondary</option>
<option>College / TVET</option>
</select>

<input list="countiesList" id="schoolCounty" placeholder="County">
<datalist id="countiesList"></datalist>

<input id="schoolRegion" placeholder="Region" readonly>

<input list="subcountiesList" id="schoolSubcounty" placeholder="Subcounty">
<datalist id="subcountiesList"></datalist>

<button onclick="detectGPS()">üìç Detect County Automatically</button>

<input id="schoolPhone" placeholder="Phone">

<input id="classInput" placeholder="Enter class + Enter">
<div id="classesList" class="item-list"></div>

<input id="streamInput" placeholder="Enter stream + Enter">
<div id="streamsList" class="item-list"></div>

<button class="btn" onclick="createSchool()">Create</button>
<button class="btn-edit" onclick="updateSchool()">Update</button>
<button class="btn-danger" onclick="deleteSchool()">Delete</button>
<button class="btn-clear" onclick="clearForm()">Clear</button>

<div class="spinner" id="loader">‚è≥ Processing...</div>
<div id="message"></div>

<div class="stats">
<h3>Dashboard Stats</h3>
<div id="statsBox">Loading stats...</div>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* SUPABASE */
const supabase=createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

/* BACK */
window.goBack=()=> document.referrer?history.back():location.href="index.html";

/* STATE */
let currentId=null;
let classes=[];
let streams=[];
const loader=document.getElementById("loader");
const message=document.getElementById("message");
function load(x){loader.style.display=x?"block":"none"}

/* THEME */
window.toggleTheme=()=>document.body.classList.toggle("light")

/* CLEAR */
window.clearForm=()=>{ 
  currentId=null;
  classes=[]; streams=[];
  document.querySelectorAll("input").forEach(i=>i.value="");
  document.querySelectorAll("select").forEach(s=>s.value="");
  classesList.innerHTML=""; streamsList.innerHTML="";
}

/* TAG INPUTS */
function render(arr,box){
  box.innerHTML="";
  arr.forEach((v,i)=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=v+" ‚úï";
    d.onclick=()=>{arr.splice(i,1); render(arr,box)}
    box.appendChild(d);
  })
}
classInput.onkeydown=e=>{
  if(e.key==="Enter" && classInput.value){
    classes.push(classInput.value);
    render(classes,classesList);
    classInput.value="";
  }
}
streamInput.onkeydown=e=>{
  if(e.key==="Enter" && streamInput.value){
    streams.push(streamInput.value);
    render(streams,streamsList);
    streamInput.value="";
  }
}

/* REGIONS */
const regions={
"Nairobi":"Nairobi Region","Mombasa":"Coast","Kwale":"Coast","Kilifi":"Coast",
"Taita Taveta":"Coast","Lamu":"Coast","Tana River":"Coast",
"Garissa":"North Eastern","Wajir":"North Eastern","Mandera":"North Eastern"
};

/* FULL COUNTIES + SUBCOUNTIES */
const counties = {
"Nairobi":["Westlands","Dagoretti North","Dagoretti South","Langata","Kibra","Roysambu","Kasarani","Ruaraka","Embakasi South","Embakasi North","Embakasi Central","Embakasi East","Embakasi West","Makadara","Kamukunji","Starehe","Mathare"],
"Mombasa":["Changamwe","Jomvu","Kisauni","Nyali","Likoni","Mvita"],
"Kwale":["Msambweni","Lunga Lunga","Matuga","Kinango"],
"Kilifi":["Kilifi North","Kilifi South","Kaloleni","Rabai","Ganze","Malindi","Magarini"],
"Tana River":["Garsen","Galole","Bura"],
"Lamu":["Lamu East","Lamu West"],
"Taita Taveta":["Taveta","Wundanyi","Mwatate","Voi"],
"Garissa":["Garissa Township","Balambala","Lagdera","Dadaab","Fafi","Ijara"],
"Wajir":["Wajir North","Wajir East","Tarbaj","Wajir West","Eldas","Wajir South"],
"Mandera":["Mandera West","Banissa","Mandera North","Mandera South","Mandera East","Lafey"]
};

/* LOAD COUNTIES */
Object.keys(counties).forEach(c=>countiesList.appendChild(new Option(c,c)));

schoolCounty.oninput=()=>{
  schoolRegion.value=regions[schoolCounty.value]||"Other Region";
  subcountiesList.innerHTML="";
  (counties[schoolCounty.value]||[]).forEach(s=>subcountiesList.appendChild(new Option(s,s)))
}

/* GPS */
window.detectGPS=()=>{
if(!navigator.geolocation)return alert("GPS not supported");
load(true);
navigator.geolocation.getCurrentPosition(async pos=>{
try{
const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
const data=await res.json();
let county=(data.address.county||data.address.state||"").replace(" County","").trim();
schoolCounty.value=county;
schoolCounty.dispatchEvent(new Event("input"));
message.innerText="Detected: "+county;
}catch{alert("Location detected but county not found")}
load(false);
},()=>{load(false);alert("Permission denied")})
}

/* ===== OFFLINE STORAGE WITH INDEXEDDB ===== */
let db;
const request=indexedDB.open("schoolDB",1);
request.onupgradeneeded=e=>{
db=e.target.result;
if(!db.objectStoreNames.contains("schools")){
const store=db.createObjectStore("schools",{keyPath:"id",autoIncrement:true});
store.createIndex("name","name",{unique:false});
store.createIndex("synced","synced",{unique:false});
}
};
request.onsuccess=e=>{db=e.target.result; syncOffline(); };
request.onerror=e=>console.error("IndexedDB error",e);

async function saveOffline(school){
const tx=db.transaction("schools","readwrite");
const store=tx.objectStore("schools");
school.synced=false;
store.put(school);
return tx.complete;
}

async function getOfflineSchools(){
return new Promise(res=>{
const tx=db.transaction("schools","readonly");
const store=tx.objectStore("schools");
const all=[];
store.openCursor().onsuccess=e=>{
const cursor=e.target.result;
if(cursor){all.push(cursor.value);cursor.continue()}
else res(all);
}
});
}

async function syncOffline(){
if(!navigator.onLine) return;
const schools=await getOfflineSchools();
for(const s of schools){
if(!s.synced){
const {data,error}=await supabase.from("schools").upsert([{
id:s.id,name:s.name,level:s.level,county:s.county,region:s.region,
subcounty:s.subcounty,phone:s.phone,classes:s.classes,streams:s.streams
}]).select();
if(!error){
const tx=db.transaction("schools","readwrite");
tx.objectStore("schools").put({...s,synced:true});
}
}
}
}

/* CREATE */
window.createSchool=async()=>{
const school={
name:schoolName.value,
level:schoolLevel.value,
county:schoolCounty.value,
region:schoolRegion.value,
subcounty:schoolSubcounty.value,
phone:schoolPhone.value,
classes,streams
};
load(true);
if(navigator.onLine){
const {data,error}=await supabase.from("schools").insert([school]).select();
if(error){message.innerText=error.message; await saveOffline(school)}
else{currentId=data[0].id; message.innerText="Saved ‚úî"; clearForm();} 
}else{await saveOffline(school); message.innerText="Saved offline ‚úî"; clearForm();}
loadStats(); load(false);
}

/* UPDATE */
window.updateSchool=async()=>{
if(!currentId)return alert("Search school first");
const school={
id:currentId,
name:schoolName.value,level:schoolLevel.value,county:schoolCounty.value,
region:schoolRegion.value,subcounty:schoolSubcounty.value,
phone:schoolPhone.value,classes,streams
};
load(true);
if(navigator.onLine){
const {error}=await supabase.from("schools").update(school).eq("id",currentId);
message.innerText=error?error.message:"Updated ‚úî"; clearForm();
}else{await saveOffline(school); message.innerText="Updated offline ‚úî"; clearForm();}
loadStats(); load(false);
}

/* DELETE */
window.deleteSchool=async()=>{
if(!currentId)return alert("Search first");
load(true);
if(navigator.onLine){
await supabase.from("schools").delete().eq("id",currentId);
}else{
const tx=db.transaction("schools","readwrite");
tx.objectStore("schools").delete(currentId);
}
clearForm(); message.innerText="Deleted ‚úî"; loadStats(); load(false);
}

/* SEARCH */
searchName.oninput=async()=>{
const q=searchName.value
results.innerHTML=""
if(!q) return
let data=[]
if(navigator.onLine){
const res=await supabase.from("schools").select("*").ilike("name","%"+q+"%").limit(5)
data=res.data||[]
}else{
const offline=await getOfflineSchools();
data=offline.filter(s=>s.name.toLowerCase().includes(q.toLowerCase())).slice(0,5)
}
data.forEach(s=>{
const d=document.createElement("div")
d.textContent=s.name
d.onclick=()=>{
currentId=s.id
schoolName.value=s.name
schoolLevel.value=s.level
schoolCounty.value=s.county
schoolCounty.dispatchEvent(new Event("input"))
schoolSubcounty.value=s.subcounty
schoolPhone.value=s.phone
classes=s.classes||[]
streams=s.streams||[]
render(classes,classesList)
render(streams,streamsList)
results.innerHTML=""
}
results.appendChild(d)
})
}

/* STATS */
async function loadStats(){
let data=[]
if(navigator.onLine){
const res=await supabase.from("schools").select("county")
data=res.data||[]
}else{
data=await getOfflineSchools()
}
let c={}
data.forEach(s=>c[s.county]=(c[s.county]||0)+1)
statsBox.innerHTML=""
Object.entries(c).forEach(([k,v])=>statsBox.innerHTML+=`<div>${k}: ${v}</div>`)
}

/* SYNC WHEN BACK ONLINE */
window.addEventListener("online",()=>{syncOffline(); message.innerText="Back online, syncing..."})
loadStats()
</script>
</body>
</html>
