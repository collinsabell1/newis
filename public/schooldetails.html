<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Details - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
 --bg1:#0f2027;
 --bg2:#203a43;
 --bg3:#2c5364;
 --glass:rgba(255,255,255,0.12);
 --text:white;
}
.light{
 --bg1:#f2f7ff;
 --bg2:#dbeafe;
 --bg3:#c7d2fe;
 --glass:rgba(255,255,255,0.8);
 --text:#111;
}
body{
 margin:0;
 font-family:'Segoe UI',Arial;
 background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
 color:var(--text);
 display:flex;
 justify-content:center;
 padding-top:20px;
 min-height:100vh;
 transition:.3s;
}
.container{
 background:var(--glass);
 padding:30px;
 border-radius:20px;
 width:720px;
 backdrop-filter:blur(15px);
}
input,select,button{
 width:100%;
 padding:10px;
 margin:6px 0;
 border:none;
 border-radius:10px;
}
button{font-weight:bold;cursor:pointer}
.btn{background:#00c6ff;color:white}
.btn-danger{background:#dc3545}
.btn-edit{background:#28a745}
.btn-clear{background:#6c757d}
.topbar{
 display:flex;
 justify-content:space-between;
 margin-bottom:10px;
}
.item-list{display:flex;flex-wrap:wrap;gap:6px}
.item{
 background:rgba(0,0,0,.4);
 padding:5px 10px;
 border-radius:12px;
}
.item button{
 margin-left:6px;
 background:red;
 color:white;
 border-radius:50%;
}
.success{text-align:center;color:#00ff99;margin-top:10px}
.spinner{
 display:none;
 text-align:center;
 font-size:18px;
}
.search-results{
 background:#111;
 border-radius:10px;
 max-height:150px;
 overflow:auto;
 position:absolute;
 width:90%;
 z-index:99;
}
.search-results div{
 padding:8px;
 cursor:pointer;
}
.search-results div:hover{
 background:#00c6ff;
}
</style>
</head>

<body>

<div class="container">

<div class="topbar">
<button onclick="logout()">Logout</button>
<button onclick="toggleTheme()">Toggle Theme</button>
</div>

<h2>School Manager</h2>

<input id="searchName" placeholder="Search school..." autocomplete="off">
<div id="results" class="search-results"></div>

<input id="schoolName" placeholder="School Name">
<select id="schoolLevel">
<option value="">Level</option>
<option>Primary</option>
<option>Secondary</option>
<option>College</option>
</select>

<input id="schoolCounty" placeholder="County">
<input id="schoolSubcounty" placeholder="Subcounty">
<input id="schoolPhone" placeholder="Phone">

<input id="classInput" placeholder="Enter class + Enter">
<div id="classesList" class="item-list"></div>

<input id="streamInput" placeholder="Enter stream + Enter">
<div id="streamsList" class="item-list"></div>

<button class="btn" onclick="createSchool()">Create</button>
<button class="btn-edit" onclick="updateSchool()">Update</button>
<button class="btn-danger" onclick="deleteSchool()">Delete</button>
<button class="btn-clear" onclick="clearForm()">Clear</button>

<div class="spinner" id="loader">‚è≥ Processing...</div>
<div id="message" class="success"></div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* CONNECT */
const supabase=createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

/* AUTH CHECK */
const {data:{session}}=await supabase.auth.getSession();
if(!session) location.href="login.html";

/* ROLE */
let role="viewer";
const {data:userRow}=await supabase
.from("users")
.select("role")
.eq("id",session.user.id)
.single();
if(userRow) role=userRow.role;

/* UI CONTROL */
if(role==="viewer"){
 document.querySelectorAll("button").forEach(b=>{
  if(!b.textContent.includes("Clear")) b.disabled=true;
 });
}

/* STATE */
let currentId=null;
let classes=[],streams=[];

const loader=document.getElementById("loader");
function load(on){loader.style.display=on?"block":"none"}

/* THEME */
window.toggleTheme=()=>{
 document.body.classList.toggle("light")
};

/* CLEAR */
window.clearForm=()=>{
 currentId=null;
 classes=[];streams=[];
 document.querySelectorAll("input").forEach(i=>i.value="")
 classesList.innerHTML="";
 streamsList.innerHTML="";
};

/* RENDER TAGS */
function render(arr,box){
 box.innerHTML="";
 arr.forEach((v,i)=>{
  const d=document.createElement("div");
  d.className="item";
  d.innerHTML=v+" <button>x</button>";
  d.onclick=()=>{arr.splice(i,1);render(arr,box)}
  box.appendChild(d);
 })
}

classInput.onkeydown=e=>{
 if(e.key==="Enter"&&classInput.value){
  classes.push(classInput.value);
  render(classes,classesList);
  classInput.value=""
 }
};
streamInput.onkeydown=e=>{
 if(e.key==="Enter"&&streamInput.value){
  streams.push(streamInput.value);
  render(streams,streamsList);
  streamInput.value=""
 }
};

/* SEARCH AUTOCOMPLETE */
searchName.oninput=async()=>{
 const q=searchName.value;
 if(q.length<2){results.innerHTML="";return}

 const {data}=await supabase
 .from("schools")
 .select("name")
 .ilike("name",`%${q}%`)
 .limit(5);

 results.innerHTML="";
 data.forEach(s=>{
  const d=document.createElement("div");
  d.textContent=s.name;
  d.onclick=()=>loadSchool(s.name);
  results.appendChild(d);
 })
};

/* LOAD SCHOOL */
async function loadSchool(name){
 load(true);
 results.innerHTML="";
 searchName.value=name;

 const id=name.toLowerCase().replace(/\s+/g,"_");
 currentId=id;

 const {data}=await supabase
 .from("schools")
 .select("*")
 .eq("id",id)
 .single();

 if(!data){alert("Not found");load(false);return}

 schoolName.value=data.name;
 schoolLevel.value=data.level;
 schoolCounty.value=data.county;
 schoolSubcounty.value=data.subcounty;
 schoolPhone.value=data.phone;

 classes=data.classes||[];
 streams=data.streams||[];

 render(classes,classesList);
 render(streams,streamsList);
 load(false);
}

/* VALIDATE */
function validate(){
 if(!schoolName.value) return "Enter school name";
 if(!schoolLevel.value) return "Select level";
 return null;
}

/* CREATE */
window.createSchool=async()=>{
 const err=validate();
 if(err)return alert(err);

 load(true);

 const id=schoolName.value.toLowerCase().replace(/\s+/g,"_");

 const {error}=await supabase.from("schools").insert({
 id,
 name:schoolName.value,
 level:schoolLevel.value,
 county:schoolCounty.value,
 subcounty:schoolSubcounty.value,
 phone:schoolPhone.value,
 classes,
 streams
 });

 load(false);
 if(error) return alert(error.message);
 message.innerText="Created successfully";
 clearForm();
};

/* UPDATE */
window.updateSchool=async()=>{
 if(!currentId) return alert("Search school first");
 load(true);

 const {error}=await supabase
 .from("schools")
 .update({
 name:schoolName.value,
 level:schoolLevel.value,
 county:schoolCounty.value,
 subcounty:schoolSubcounty.value,
 phone:schoolPhone.value,
 classes,
 streams
 })
 .eq("id",currentId);

 load(false);
 if(error) return alert(error.message);
 message.innerText="Updated";
};

/* DELETE */
window.deleteSchool=async()=>{
 if(!currentId) return alert("Search first");
 if(!confirm("Delete?")) return;
 load(true);

 const {error}=await supabase
 .from("schools")
 .delete()
 .eq("id",currentId);

 load(false);
 if(error)return alert(error.message);
 message.innerText="Deleted";
 clearForm();
};

/* LOGOUT */
window.logout=async()=>{
 await supabase.auth.signOut();
 location.href="login.html";
};
</script>
</body>
</html>
