<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Manager - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
 --bg1:#0f2027;
 --bg2:#203a43;
 --bg3:#2c5364;
 --glass:rgba(255,255,255,0.12);
 --text:white;
}
.light{
 --bg1:#f2f7ff;
 --bg2:#dbeafe;
 --bg3:#c7d2fe;
 --glass:rgba(255,255,255,0.85);
 --text:#111;
}
body{
 margin:0;
 font-family:Segoe UI;
 background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
 color:var(--text);
 display:flex;
 justify-content:center;
 padding:20px;
}
.container{
 width:720px;
 background:var(--glass);
 padding:25px;
 border-radius:20px;
 backdrop-filter:blur(15px);
}
input,select,button{
 width:100%;
 padding:10px;
 margin:6px 0;
 border:none;
 border-radius:10px;
}
button{cursor:pointer;font-weight:bold}
.btn{background:#00c6ff;color:white}
.btn-edit{background:#28a745;color:white}
.btn-danger{background:#dc3545;color:white}
.btn-clear{background:#6c757d;color:white}
.item-list{display:flex;flex-wrap:wrap;gap:6px}
.item{
 background:rgba(0,0,0,.4);
 padding:5px 10px;
 border-radius:12px;
}
.spinner{display:none;text-align:center}
.search-results{
 background:#111;
 border-radius:10px;
 max-height:150px;
 overflow:auto;
 position:absolute;
 width:85%;
 z-index:99;
}
.stats{
 background:rgba(0,0,0,.4);
 padding:10px;
 border-radius:10px;
 margin-top:15px;
}

/* FLOATING BACK BUTTON */
.back-btn{
position:fixed;
top:20px;
left:20px;
padding:12px 18px;
border:none;
border-radius:14px;
font-weight:600;
cursor:pointer;
color:white;
background:linear-gradient(45deg,#ff416c,#ff4b2b,#ff6a00);
background-size:300% 300%;
animation:gradientMove 6s ease infinite;
box-shadow:0 8px 20px rgba(0,0,0,.35);
z-index:9999;
}
@keyframes gradientMove{
0%{background-position:0% 50%}
50%{background-position:100% 50%}
100%{background-position:0% 50%}
}
</style>
</head>

<body>

<button class="back-btn" onclick="goBack()">‚¨Ö Back</button>

<div class="container">

<button onclick="toggleTheme()">Toggle Theme</button>

<h2>School Manager</h2>

<input id="searchName" placeholder="Search school...">
<div id="results" class="search-results"></div>

<input id="schoolName" placeholder="School Name">

<select id="schoolLevel">
<option value="">Level</option>
<option>Pre-primary</option>
<option>Primary</option>
<option>Junior Secondary</option>
<option>Senior Secondary</option>
<option>College / TVET</option>
</select>

<input list="countiesList" id="schoolCounty" placeholder="County">
<datalist id="countiesList"></datalist>

<input id="schoolRegion" placeholder="Region" readonly>

<input list="subcountiesList" id="schoolSubcounty" placeholder="Subcounty">
<datalist id="subcountiesList"></datalist>

<button onclick="detectGPS()">üìç Detect County Automatically</button>

<input id="schoolPhone" placeholder="Phone">

<input id="classInput" placeholder="Enter class + Enter">
<div id="classesList" class="item-list"></div>

<input id="streamInput" placeholder="Enter stream + Enter">
<div id="streamsList" class="item-list"></div>

<button class="btn" onclick="createSchool()">Create</button>
<button class="btn-edit" onclick="updateSchool()">Update</button>
<button class="btn-danger" onclick="deleteSchool()">Delete</button>
<button class="btn-clear" onclick="clearForm()">Clear</button>

<div class="spinner" id="loader">‚è≥ Processing...</div>
<div id="message"></div>

<div class="stats">
<h3>Dashboard Stats</h3>
<div id="statsBox">Loading stats...</div>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase=createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"YOUR_PUBLIC_ANON_KEY"
);

/* BACK BUTTON */
window.goBack=()=>{
if(document.referrer){
history.back();
}else{
location.href="index.html";
}
};

/* STATE */
let currentId=null;
let classes=[];
let streams=[];
const loader=document.getElementById("loader");
function load(x){loader.style.display=x?"block":"none"}

/* THEME */
window.toggleTheme=()=>document.body.classList.toggle("light")

/* CLEAR */
window.clearForm=()=>{
currentId=null;
classes=[];streams=[];
document.querySelectorAll("input").forEach(i=>i.value="")
classesList.innerHTML="";
streamsList.innerHTML="";
}

/* TAG INPUTS */
function render(arr,box){
box.innerHTML="";
arr.forEach((v,i)=>{
const d=document.createElement("div");
d.className="item";
d.innerHTML=v+" ‚úï";
d.onclick=()=>{arr.splice(i,1);render(arr,box)}
box.appendChild(d);
})
}
classInput.onkeydown=e=>{
if(e.key==="Enter"&&classInput.value){
classes.push(classInput.value);
render(classes,classesList);
classInput.value="";
}}
streamInput.onkeydown=e=>{
if(e.key==="Enter"&&streamInput.value){
streams.push(streamInput.value);
render(streams,streamsList);
streamInput.value="";
}}

/* REGIONS */
const regions={
"Nairobi":"Nairobi Region",
"Mombasa":"Coast",
"Kwale":"Coast",
"Kilifi":"Coast",
"Taita Taveta":"Coast",
"Lamu":"Coast",
"Tana River":"Coast",
"Garissa":"North Eastern",
"Wajir":"North Eastern",
"Mandera":"North Eastern"
};

/* COUNTIES */
const counties={
"Nairobi":["Westlands","Dagoretti North","Dagoretti South","Langata","Kibra","Roysambu","Kasarani","Ruaraka","Embakasi South","Embakasi North","Embakasi Central","Embakasi East","Embakasi West","Makadara","Kamukunji","Starehe","Mathare"],
"Mombasa":["Changamwe","Jomvu","Kisauni","Nyali","Likoni","Mvita"],
"Kwale":["Msambweni","Lunga Lunga","Matuga","Kinango"],
"Kilifi":["Kilifi North","Kilifi South","Kaloleni","Rabai","Ganze","Malindi","Magarini"],
"Tana River":["Garsen","Galole","Bura"],
"Lamu":["Lamu East","Lamu West"],
"Taita Taveta":["Taveta","Wundanyi","Mwatate","Voi"],
"Garissa":["Garissa Township","Balambala","Lagdera","Dadaab","Fafi","Ijara"],
"Wajir":["Wajir North","Wajir East","Tarbaj","Wajir West","Eldas","Wajir South"],
"Mandera":["Mandera West","Banissa","Mandera North","Mandera South","Mandera East","Lafey"]
};

/* LOAD COUNTIES */
Object.keys(counties).forEach(c=>countiesList.appendChild(new Option(c,c)));

schoolCounty.oninput=()=>{
schoolRegion.value=regions[schoolCounty.value]||"Other Region";
subcountiesList.innerHTML="";
(counties[schoolCounty.value]||[]).forEach(s=>{
subcountiesList.appendChild(new Option(s,s))
})
}

/* GPS DETECTOR FIX */
window.detectGPS=()=>{
if(!navigator.geolocation){
alert("GPS not supported");
return;
}

load(true);

navigator.geolocation.getCurrentPosition(async pos=>{
try{
const lat=pos.coords.latitude;
const lon=pos.coords.longitude;

/* reverse geocode using openstreetmap */
const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
const data=await res.json();

let county=
data.address.county ||
data.address.state_district ||
data.address.state ||
"";

/* clean county names */
county=county.replace(" County","").trim();

/* set fields */
schoolCounty.value=county;
schoolCounty.dispatchEvent(new Event("input"));

message.innerText="Detected: "+county;
}
catch(err){
alert("Location detected but county not found");
console.error(err);
}
load(false);
},
err=>{
load(false);
alert("Location permission denied");
});
}

/* STATS */
async function loadStats(){
const {data}=await supabase.from("schools").select("county");
let counts={};
data.forEach(s=>counts[s.county]=(counts[s.county]||0)+1);
statsBox.innerHTML="";
Object.entries(counts).forEach(([c,n])=>{
statsBox.innerHTML+=`<div>${c}: ${n} schools</div>`;
});
}
loadStats();
</script>
</body>
</html>
