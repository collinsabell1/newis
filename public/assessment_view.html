<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Socioeconomic View All - NEWIS</title>

<style>
body{
  font-family: Arial;
  background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
}
.container{
  max-width:1400px;
  margin:30px auto;
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 15px 40px rgba(0,0,0,0.4);
}
h2{text-align:center;color:#203a43;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{padding:10px;border:1px solid #ddd;text-align:center;}
th{background:#203a43;color:white;}
.green{background:#d4edda;}
.yellow{background:#fff3cd;}
.red{background:#f8d7da;}
.buttons{
  margin-top:20px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
button{
  padding:10px 15px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
.download{background:#28a745;color:white;}
.select{background:#17a2b8;color:white;}
.filter{background:#ffc107;color:black;}
.back{background:#6c757d;color:white;}
.next{background:#007bff;color:white;}
.delete{background:#dc3545;color:white;}
@media(max-width:768px){table{font-size:12px;}}
</style>
</head>

<body>
<div class="container">

<h2>All Socioeconomic Assessment Records</h2>

<div class="buttons">
  <button class="filter" onclick="showAll()">Show All</button>
  <button class="filter" onclick="showHighRisk()">High Risk (>55%)</button>
  <button class="filter" onclick="showMediumRisk()">Medium Risk (45–55%)</button>
  <button class="filter" onclick="showLowRisk()">Low Risk (<45%)</button>

  <button class="select" onclick="selectAll()">Select All</button>
  <button class="delete" onclick="deleteSelected()">Delete Selected</button>

  <button class="download" onclick="downloadSelected()">Download Selected</button>
  <button class="download" onclick="downloadAll()">Download All</button>

  <button class="back" onclick="location.href='assessment.html'">⬅ Back</button>
  <button class="next" onclick="location.href='riskprediction.html'">Next ➜</button>
</div>

<table id="dataTable">
<thead>
<tr>
<th>Select</th>
<th>Admission No</th>
<th>Name</th>
<th>Class</th>
<th>Risk %</th>
<th>Date Recorded</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
"https://xnvnskxcsphbvkxhndui.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);


/* LOAD DATA */
async function loadData(){
  const { data, error } = await supabase
    .from("socioeconomic")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){
    alert("Error loading data");
    console.error(error);
    return;
  }

  const tbody = document.querySelector("tbody");
  tbody.innerHTML="";

  data.forEach(row=>{
    const tr=document.createElement("tr");

    let color="";
    if(row.risk > 55) color="red";
    else if(row.risk >=45) color="yellow";
    else color="green";

    tr.className=color;

    tr.innerHTML=`
      <td><input type="checkbox" class="selector" data-id="${row.id}"></td>
      <td>${row.student_id}</td>
      <td>${row.name}</td>
      <td>${row.class}</td>
      <td>${row.risk}%</td>
      <td>${row.created_at ? new Date(row.created_at).toLocaleString() : ""}</td>
    `;

    tbody.appendChild(tr);
  });
}

loadData();


/* FILTERS */
window.showAll=()=>document.querySelectorAll("tbody tr").forEach(r=>r.style.display="");

window.showHighRisk=()=>filter(r=>parseInt(r.cells[4].innerText)>55);
window.showMediumRisk=()=>filter(r=>{
  let v=parseInt(r.cells[4].innerText);
  return v>=45 && v<=55;
});
window.showLowRisk=()=>filter(r=>parseInt(r.cells[4].innerText)<45);

function filter(cond){
  document.querySelectorAll("tbody tr").forEach(r=>{
    r.style.display=cond(r)?"":"none";
  });
}


/* SELECT ALL */
window.selectAll=()=>{
  document.querySelectorAll(".selector").forEach(c=>c.checked=true);
};


/* DELETE */
window.deleteSelected = async ()=>{
  const selected=[...document.querySelectorAll(".selector")]
  .filter(c=>c.checked)
  .map(c=>c.dataset.id);

  if(!selected.length) return alert("Nothing selected");

  if(!confirm("Delete selected records?")) return;

  const { error } = await supabase
    .from("socioeconomic")
    .delete()
    .in("id",selected);

  if(error){
    alert("Delete failed");
    console.error(error);
  }else{
    loadData();
  }
};


/* CSV */
function generateCSV(rows){
  let csv="Admission No,Name,Class,Risk %,Date Recorded\n";
  rows.forEach(r=>{
    const c=r.children;
    csv+=`${c[1].innerText},${c[2].innerText},${c[3].innerText},${c[4].innerText},${c[5].innerText}\n`;
  });
  return csv;
}
function download(csv){
  const b=new Blob([csv],{type:"text/csv"});
  const u=URL.createObjectURL(b);
  const a=document.createElement("a");
  a.href=u;a.download="socioeconomic.csv";
  a.click();
  URL.revokeObjectURL(u);
}
window.downloadSelected=()=>{
  const r=[...document.querySelectorAll("tbody tr")]
  .filter(x=>x.querySelector(".selector").checked && x.style.display!=="none");
  if(!r.length) return alert("No selection");
  download(generateCSV(r));
};
window.downloadAll=()=>{
  const r=[...document.querySelectorAll("tbody tr")]
  .filter(x=>x.style.display!=="none");
  if(!r.length) return alert("No records");
  download(generateCSV(r));
};

</script>

<script type="module" src="test.js"></script>
</body>
</html>
