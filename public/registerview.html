<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>All Registered Students - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Body & Container */
body {
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
.floating-back {
  position:fixed;
  top:20px;
  left:20px;
  padding:10px 16px;
  border-radius:30px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  background:rgba(0,198,255,0.9);
  color:black;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
  backdrop-filter:blur(10px);
  z-index:1000;
  transition:0.3s;
}
.floating-back:hover {background:#00c6ff; transform:translateY(-2px) scale(1.05);}
.container {
  max-width:1200px;
  margin:80px auto 30px;
  padding:20px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
}
h1{text-align:center; font-size:1.8rem; margin-bottom:20px;}

/* Table */
.table-wrapper {
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  border-radius:10px;
}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:0.9rem;
}
thead th {
  position: sticky;
  top:0;
  background:rgba(255,255,255,0.2);
  backdrop-filter:blur(5px);
  z-index:5;
  cursor:pointer;
}
th,td{
  padding:8px;
  text-align:center;
  vertical-align: middle;
}
tr:nth-child(even){background:rgba(255,255,255,0.05);}

/* Buttons & Inputs */
button, select, input {
  padding:6px 10px;
  margin:3px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}
button:hover{transform:scale(1.05);}
.status-active{color:#00ff99;font-weight:bold;}
.status-suspended{color:orange;font-weight:bold;}
.status-expelled{color:red;font-weight:bold;}
.delete-btn{background:#ff4d4d;color:white;}
.pagination{text-align:center;margin-top:15px; flex-wrap:wrap; display:flex; justify-content:center;}
.pagination button{margin:3px;}

/* Images */
img.student-photo{width:50px;height:50px;object-fit:cover;border-radius:6px;}
.section-title{font-weight:bold;margin:20px 0 10px;font-size:1.2rem;text-align:center;}
.upload-container{text-align:center;margin-bottom:30px;background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;}

/* ID Cards */
#idPreview{margin-top:15px; display:flex; flex-wrap: wrap; gap:10px; justify-content:center;}
.id-card{
  width:85mm;
  height:55mm;
  border:1px solid #fff;
  border-radius:5px;
  padding:5mm;
  background:rgba(255,255,255,0.1);
  position:relative;
  color:white;
  font-size:12px;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
}
.id-card img.logo{width:20mm; height:20mm; object-fit:cover; position:absolute; top:5mm; left:5mm;}
.id-card img.photo{width:25mm; height:30mm; object-fit:cover; position:absolute; top:5mm; right:5mm;}
.id-card .text{position:absolute; top:5mm; left:30mm;}

/* Responsive */
@media(max-width:768px){
  .container{margin:60px 10px;padding:15px;}
  h1{font-size:1.5rem;}
  table{font-size:0.8rem;}
  .id-card{width:70mm; height:45mm;}
}
</style>
</head>
<body>

<!-- Back button to register page -->
<button class="floating-back" onclick="goBack()">‚¨Ö Back</button>

<div class="container">

  <!-- Upload Logo -->
  <div class="upload-container">
    <div class="section-title">üè´ Upload School Logo</div>
    <input type="file" id="logoUpload" accept="image/*">
    <button onclick="uploadLogo()">Upload Logo</button>
    <button onclick="deleteLogo()">Delete Logo</button>
    <button onclick="previewLogo()">Preview Logo</button>
    <span id="logoStatus" style="margin-left:10px;"></span>
  </div>

  <!-- Header -->
  <h1>üìã All Registered Students</h1>

  <!-- Filters & Actions -->
  <div style="text-align:center;margin-bottom:20px;">
    <input type="text" id="searchInput" placeholder="Search Admission No or Name">
    <select id="classFilter"><option value="All">All Classes</option></select>
    <select id="statusFilter">
      <option value="All">All Status</option>
      <option>Active</option>
      <option>Suspended</option>
      <option>Expelled</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
    <button onclick="bulkAction('Suspended')">Bulk Suspend</button>
    <button onclick="bulkAction('Expelled')">Bulk Expel</button>
    <button onclick="bulkAction('Active')">Bulk Restore</button>
    <button class="delete-btn" onclick="deleteSelected()">üóë Delete Selected</button>
    <button onclick="downloadPDF()">Export PDF</button>
    <button onclick="downloadExcel()">Export Excel</button>
    <button onclick="downloadIDCards()">Download ID Cards</button>
    <button onclick="bulkPromote()">Promote Selected</button>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    <table id="studentsTable">
      <thead>
        <tr>
          <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
          <th onclick="sortTable('studentid')">Adm No</th>
          <th onclick="sortTable('studentname')">Name</th>
          <th onclick="sortTable('dateofbirth')">DOB</th>
          <th onclick="sortTable('age')">Age</th>
          <th onclick="sortTable('school')">School</th>
          <th onclick="sortTable('level')">Level</th>
          <th onclick="sortTable('grade')">Class</th>
          <th onclick="sortTable('stream')">Stream</th>
          <th>Photo</th>
          <th onclick="sortTable('status')">Status</th>
          <th onclick="sortTable('created_at')">Registered At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination"></div>

  <!-- ID Cards -->
  <div class="section-title">üÜî ID Card Preview</div>
  <div id="idPreview"></div>

</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>

<!-- Script -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Supabase client
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

let students = [], filteredStudents = [], schoolLogo = null;

// Upload logo to Supabase storage
window.uploadLogo = async () => {
  const file = document.getElementById("logoUpload").files[0];
  if (!file) return alert("Select a logo file first.");
  
  // Upload logo to Supabase Storage
  const { data, error } = await supabase.storage.from('schoollogo').upload('logos/' + file.name, file);
  
  if (error) {
    console.error(error);
    return alert("Error uploading logo.");
  }

  schoolLogo = data.Key; // Store the logo URL path
  document.getElementById("logoStatus").textContent = "Logo uploaded successfully!";
  renderIDPreview();
};

// Delete the logo from Supabase storage
window.deleteLogo = async () => {
  if (!schoolLogo) return alert("No logo to delete.");

  const { error } = await supabase.storage.from('schoollogo').remove([`logos/${schoolLogo}`]);
  
  if (error) {
    console.error(error);
    return alert("Error deleting logo.");
  }

  schoolLogo = null;
  document.getElementById("logoStatus").textContent = "Logo deleted successfully!";
  renderIDPreview();
};

// Preview the current logo
window.previewLogo = async () => {
  if (!schoolLogo) return alert("No logo uploaded.");
  
  const { publicURL, error } = await supabase.storage.from('schoollogo').getPublicUrl(`logos/${schoolLogo}`);
  
  if (error) {
    console.error(error);
    return alert("Error retrieving logo.");
  }

  const logoPreviewWindow = window.open("", "Logo Preview", "width=600,height=600");
  logoPreviewWindow.document.write(`<img src="${publicURL}" alt="Logo Preview" style="width:100%">`);
};

// ID Card Preview
function renderIDPreview() {
  const previewDiv = document.getElementById("idPreview");
  previewDiv.innerHTML = "";
  filteredStudents.slice(0, 10).forEach(s => {
    const div = document.createElement("div");
    div.className = "id-card";
    div.innerHTML = `
      ${schoolLogo ? `<img class="logo" src="${schoolLogo}">` : ''}
      ${s.photo ? `<img class="photo" src="${s.photo}">` : ''}
      <div class="text">
        <div><strong>${s.studentname}</strong></div>
        <div>Adm No: ${s.studentid}</div>
        <div>Class: ${s.grade}</div>
        <div>Stream: ${s.stream}</div>
      </div>
    `;
    previewDiv.appendChild(div);
  });
}

// Back button
window.goBack = () => { location.href = "register.html"; }
</script>

</body>
</html>
