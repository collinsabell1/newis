<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>All Registered Students - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Body & Container */
body {
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
.floating-back {
  position:fixed;
  top:20px;
  left:20px;
  padding:10px 16px;
  border-radius:30px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  background:rgba(0,198,255,0.9);
  color:black;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
  backdrop-filter:blur(10px);
  z-index:1000;
  transition:0.3s;
}
.floating-back:hover {background:#00c6ff; transform:translateY(-2px) scale(1.05);}
.container {
  max-width:1200px;
  margin:80px auto 30px;
  padding:20px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
}
h1{text-align:center; font-size:1.8rem; margin-bottom:20px;}

/* Table */
.table-wrapper {
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  border-radius:10px;
}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:0.9rem;
}
thead th {
  position: sticky;
  top:0;
  background:rgba(255,255,255,0.2);
  backdrop-filter:blur(5px);
  z-index:5;
  cursor:pointer;
}
th,td{
  padding:8px;
  text-align:center;
  vertical-align: middle;
}
tr:nth-child(even){background:rgba(255,255,255,0.05);}

/* Buttons & Inputs */
button, select, input {
  padding:6px 10px;
  margin:3px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}
button:hover{transform:scale(1.05);}
.status-active{color:#00ff99;font-weight:bold;}
.status-suspended{color:orange;font-weight:bold;}
.status-expelled{color:red;font-weight:bold;}
.delete-btn{background:#ff4d4d;color:white;}
.pagination{text-align:center;margin-top:15px; flex-wrap:wrap; display:flex; justify-content:center;}
.pagination button{margin:3px;}

/* Images */
img.student-photo{width:50px;height:50px;object-fit:cover;border-radius:6px;}
.section-title{font-weight:bold;margin:20px 0 10px;font-size:1.2rem;text-align:center;}
.upload-container{text-align:center;margin-bottom:30px;background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;}

/* ID Cards */
#idPreview{margin-top:15px; display:flex; flex-wrap: wrap; gap:10px; justify-content:center;}
.id-card{
  width:85mm;
  height:55mm;
  border:1px solid #fff;
  border-radius:5px;
  padding:5mm;
  background:rgba(255,255,255,0.1);
  position:relative;
  color:white;
  font-size:12px;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
}
.id-card img.logo{width:20mm; height:20mm; object-fit:cover; position:absolute; top:5mm; left:5mm;}
.id-card img.photo{width:25mm; height:30mm; object-fit:cover; position:absolute; top:5mm; right:5mm;}
.id-card .text{position:absolute; top:5mm; left:30mm;}

/* Responsive */
@media(max-width:768px){
  .container{margin:60px 10px;padding:15px;}
  h1{font-size:1.5rem;}
  table{font-size:0.8rem;}
  .id-card{width:70mm; height:45mm;}
}
</style>
</head>
<body>

<button class="floating-back" onclick="goBack()">‚¨Ö Back</button>

<div class="container">

  <!-- Upload Logo -->
  <div class="upload-container">
    <div class="section-title">üè´ Upload School Logo</div>
    <input type="file" id="logoUpload" accept="image/*">
    <button onclick="uploadLogo()">Upload Logo</button>
    <span id="logoStatus" style="margin-left:10px;"></span>
  </div>

  <!-- Header -->
  <h1>üìã All Registered Students</h1>

  <!-- Filters & Actions -->
  <div style="text-align:center;margin-bottom:20px;">
    <input type="text" id="searchInput" placeholder="Search Admission No or Name">
    <select id="classFilter"><option value="All">All Classes</option></select>
    <select id="statusFilter">
      <option value="All">All Status</option>
      <option>Active</option>
      <option>Suspended</option>
      <option>Expelled</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
    <button onclick="bulkAction('Suspended')">Bulk Suspend</button>
    <button onclick="bulkAction('Expelled')">Bulk Expel</button>
    <button onclick="bulkAction('Active')">Bulk Restore</button>
    <button class="delete-btn" onclick="deleteSelected()">üóë Delete Selected</button>
    <button onclick="downloadPDF()">Export PDF</button>
    <button onclick="downloadExcel()">Export Excel</button>
    <button onclick="downloadIDCards()">Download ID Cards</button>
    <button onclick="bulkPromote()">Promote Selected</button>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    <table id="studentsTable">
      <thead>
        <tr>
          <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
          <th onclick="sortTable('studentid')">Adm No</th>
          <th onclick="sortTable('studentname')">Name</th>
          <th onclick="sortTable('dateofbirth')">DOB</th>
          <th onclick="sortTable('age')">Age</th>
          <th onclick="sortTable('school')">School</th>
          <th onclick="sortTable('level')">Level</th>
          <th onclick="sortTable('grade')">Class</th>
          <th onclick="sortTable('stream')">Stream</th>
          <th>Photo</th>
          <th onclick="sortTable('status')">Status</th>
          <th onclick="sortTable('created_at')">Registered At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination"></div>

  <!-- ID Cards -->
  <div class="section-title">üÜî ID Card Preview</div>
  <div id="idPreview"></div>

</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>

<!-- Script -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Supabase client
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

let students=[], filteredStudents=[], currentPage=1, perPage=20;
let sortField="studentid", sortAsc=true;
let schoolLogo=null;

// IndexedDB offline
const dbRequest = indexedDB.open('NEWIS_Students',1);
let db;
dbRequest.onupgradeneeded = e => {db=e.target.result; db.createObjectStore('students',{keyPath:'id'});}
dbRequest.onsuccess = e => {db=e.target.result; loadOffline();}
dbRequest.onerror = e => console.error(e);

// Save/load offline
function saveOffline(){if(!db) return; const tx=db.transaction('students','readwrite'); const store=tx.objectStore('students'); students.forEach(s=>store.put(s));}
function loadOffline(){
  if(!db) return;
  const tx=db.transaction('students','readonly');
  const store=tx.objectStore('students');
  const req=store.getAll();
  req.onsuccess = ()=>{if(req.result.length>0){students=req.result; filteredStudents=[...students]; populateClassFilter(); renderTable(); renderIDPreview();}else{loadStudents();}}
}

// Load students
async function loadStudents(){
  try{
    const {data,error} = await supabase.from("students").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    students = data.map(s=>({...s,status:s.status||"Active"}));
    filteredStudents=[...students];
    populateClassFilter();
    renderTable();
    renderIDPreview();
    saveOffline();
  }catch(err){console.error(err);}
}

function populateClassFilter(){
  const classSet = new Set(students.map(s=>s.grade).filter(Boolean));
  const cf=document.getElementById("classFilter");
  cf.innerHTML='<option value="All">All Classes</option>';
  classSet.forEach(c=>{cf.innerHTML+=`<option>${c}</option>`});
}

function renderTable(){
  filteredStudents.sort((a,b)=>{
    let va=a[sortField]||"", vb=b[sortField]||"";
    if(typeof va==="string") va=va.toLowerCase();
    if(typeof vb==="string") vb=vb.toLowerCase();
    if(va<vb) return sortAsc?-1:1;
    if(va>vb) return sortAsc?1:-1;
    return 0;
  });
  const start=(currentPage-1)*perPage;
  const page=filteredStudents.slice(start,start+perPage);
  const tbody=document.querySelector("#studentsTable tbody");
  tbody.innerHTML="";
  page.forEach(s=>{
    let sc="status-active";
    if(s.status==="Suspended") sc="status-suspended";
    if(s.status==="Expelled") sc="status-expelled";
    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="selectBox" value="${s.id}"></td>
      <td>${s.studentid||""}</td>
      <td>${s.studentname||""}</td>
      <td>${s.dateofbirth||""}</td>
      <td>${s.age||""}</td>
      <td>${s.school||""}</td>
      <td>${s.level||""}</td>
      <td>${s.grade||""}</td>
      <td>${s.stream||""}</td>
      <td>${s.photo?`<img class="student-photo" src="${s.photo}">`:""}</td>
      <td class="${sc}">${s.status}</td>
      <td>${s.created_at?new Date(s.created_at).toLocaleString():""}</td>
      <td>
        <button onclick="changeStatus('${s.id}','Active')">Restore</button>
        <button onclick="changeStatus('${s.id}','Suspended')">Suspend</button>
        <button onclick="changeStatus('${s.id}','Expelled')">Expel</button>
        <button class="delete-btn" onclick="deleteStudent('${s.id}')">Delete</button>
      </td>
    </tr>`;
  });
  renderPagination();
  renderIDPreview();
}

function renderPagination(){
  const p=document.getElementById("pagination");
  p.innerHTML="";
  const total=Math.ceil(filteredStudents.length/perPage);
  for(let i=1;i<=total;i++) p.innerHTML+=`<button onclick="goToPage(${i})">${i}</button>`;
}

window.goToPage=p=>{currentPage=p; renderTable();}
window.sortTable=f=>{ if(sortField===f) sortAsc=!sortAsc; else{sortField=f; sortAsc=true;} renderTable();}
window.toggleSelectAll=m=>{document.querySelectorAll(".selectBox").forEach(cb=>cb.checked=m.checked);}
window.applyFilters=()=>{
  const search=document.getElementById("searchInput").value.toLowerCase();
  const classF=document.getElementById("classFilter").value;
  const statusF=document.getElementById("statusFilter").value;
  filteredStudents=students.filter(s=>{
    const matchSearch=s.studentid.toLowerCase().includes(search)||(s.studentname||"").toLowerCase().includes(search);
    const matchClass=classF==="All"||s.grade===classF;
    const matchStatus=statusF==="All"||s.status===statusF;
    return matchSearch&&matchClass&&matchStatus;
  });
  currentPage=1; renderTable();
};

// Status & delete actions
window.changeStatus=async(id,status)=>{await supabase.from("students").update({status}).eq("id",id); loadStudents();}
window.deleteStudent=async(id)=>{if(!confirm("Delete this student permanently?")) return; await supabase.from("students").delete().eq("id",id); loadStudents();}
window.bulkAction=async(status)=>{const ids=[...document.querySelectorAll(".selectBox:checked")].map(cb=>cb.value); for(const id of ids){await supabase.from("students").update({status}).eq("id",id);} loadStudents();}
window.deleteSelected=async()=>{const ids=[...document.querySelectorAll(".selectBox:checked")].map(cb=>cb.value); if(ids.length===0) return alert("No students selected."); if(!confirm(`Delete ${ids.length} student(s)?`)) return; for(const id of ids){await supabase.from("students").delete().eq("id",id);} loadStudents();}

// Logo Upload
window.uploadLogo=async()=>{
  const file=document.getElementById("logoUpload").files[0];
  if(!file) return alert("Select a logo file first.");
  const reader=new FileReader();
  reader.onload=e=>{
    schoolLogo=e.target.result;
    document.getElementById("logoStatus").textContent=" Logo loaded!";
    renderIDPreview();
    localStorage.setItem('schoolLogo',schoolLogo);
  };
  reader.readAsDataURL(file);
};
if(localStorage.getItem('schoolLogo')) schoolLogo=localStorage.getItem('schoolLogo');

// ID Card Preview
function renderIDPreview(){
  const previewDiv=document.getElementById("idPreview");
  previewDiv.innerHTML="";
  const page=filteredStudents.slice(0,10);
  page.forEach(s=>{
    const div=document.createElement("div");
    div.className="id-card";
    div.innerHTML=`
      ${schoolLogo?`<img class="logo" src="${schoolLogo}">`:''}
      ${s.photo?`<img class="photo" src="${s.photo}">`:''}
      <div class="text">
        <div><strong>${s.studentname}</strong></div>
        <div>Adm No: ${s.studentid}</div>
        <div>Class: ${s.grade}</div>
        <div>Stream: ${s.stream}</div>
      </div>
    `;
    previewDiv.appendChild(div);
  });
}

// Export PDF & Excel & ID cards
window.downloadPDF=function(){
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("Registered Students - NEWIS",10,10);
  let y=20;
  filteredStudents.forEach(s=>{
    pdf.text(`${s.studentid} | ${s.studentname} | ${s.grade} | ${s.stream} | ${s.status}`,10,y);
    y+=6;if(y>280){pdf.addPage(); y=20;}
  });
  pdf.save("Students.pdf");
};
window.downloadExcel=function(){
  const data=[["Adm No","Name","DOB","Age","School","Level","Class","Stream","Status","Registered At"]];
  filteredStudents.forEach(s=>{data.push([s.studentid,s.studentname,s.dateofbirth,s.age,s.school,s.level,s.grade,s.stream,s.status,s.created_at]);});
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(data),"Students");
  XLSX.writeFile(wb,"Students.xlsx");
};
window.downloadIDCards=function(){
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF({unit:'mm', format:'a4'});
  let x=10,y=10,w=85,h=55,gap=10;
  filteredStudents.forEach(s=>{
    pdf.rect(x,y,w,h);
    pdf.setFontSize(12);
    if(schoolLogo) pdf.addImage(schoolLogo,'JPEG',x+5,y+2,20,20);
    if(s.photo) pdf.addImage(s.photo,'JPEG',x+w-25,y+5,20,30);
    pdf.text("School Name", x+30, y+12);
    pdf.text(`Name: ${s.studentname}`, x+5, y+25);
    pdf.text(`Adm No: ${s.studentid}`, x+5, y+33);
    pdf.text(`Class: ${s.grade}`, x+5, y+41);
    pdf.text(`Stream: ${s.stream}`, x+5, y+49);
    x+=w+gap;if(x+w>210){x=10;y+=h+gap;}
    if(y+h>297){pdf.addPage(); x=10; y=10;}
  });
  pdf.save("ID_Cards.pdf");
};

// Bulk Promote
window.bulkPromote=async()=>{
  const ids=[...document.querySelectorAll(".selectBox:checked")].map(cb=>cb.value);
  if(ids.length===0) return alert("No students selected.");
  const updates=[];
  ids.forEach(id=>{
    const stu=students.find(s=>s.id===id);
    if(stu && stu.grade){
      let next=parseInt(stu.grade);
      if(!isNaN(next)) updates.push({id:id, grade:(next+1).toString()});
    }
  });
  for(const u of updates){
    await supabase.from("students").update({grade:u.grade}).eq("id",u.id);
  }
  loadStudents();
};

window.goBack=()=>{location.href="student-registration.html";};

loadOffline();
</script>

</body>
</html>
