<!DOCTYPE html>
<html>
<head>
<title>All Registered Students - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

.floating-back{
  position:fixed;
  top:20px;
  left:20px;
  padding:10px 16px;
  border-radius:30px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  background:rgba(0,198,255,0.9);
  color:black;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
  backdrop-filter:blur(10px);
  transition:0.3s;
  z-index:1000;
}
.floating-back:hover{
  background:#00c6ff;
  transform:translateY(-2px) scale(1.05);
}

.container{
  max-width:1600px;
  margin:80px auto 30px;
  padding:30px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
}

h1{text-align:center;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:8px;
  text-align:center;
}
th{
  background:rgba(255,255,255,0.2);
  cursor:pointer;
}
tr:nth-child(even){
  background:rgba(255,255,255,0.05);
}

button,select,input{
  padding:6px 10px;
  margin:4px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

.status-active{color:#00ff99;font-weight:bold;}
.status-suspended{color:orange;font-weight:bold;}
.status-expelled{color:red;font-weight:bold;}

.delete-btn{
  background:#ff4d4d;
  color:white;
}

.pagination{
  margin-top:15px;
  text-align:center;
}
.pagination button{margin:3px;}
</style>
</head>

<body>

<button class="floating-back" onclick="goBackToRegister()">â¬… Back</button>

<div class="container">

<h1>ðŸ“‹ All Registered Students</h1>

<div style="text-align:center;">
<input type="text" id="searchInput" placeholder="Search Admission No">

<select id="classFilter">
  <option value="All">All Classes</option>
</select>

<select id="statusFilter">
  <option value="All">All Status</option>
  <option>Active</option>
  <option>Suspended</option>
  <option>Expelled</option>
</select>

<button onclick="applyFilters()">Apply</button>
<button onclick="bulkAction('Suspended')">Bulk Suspend</button>
<button onclick="bulkAction('Expelled')">Bulk Expel</button>
<button onclick="bulkAction('Active')">Bulk Restore</button>

<button class="delete-btn" onclick="deleteSelected()">ðŸ—‘ Delete Selected</button>

<button onclick="downloadPDF()">Export PDF</button>
<button onclick="downloadExcel()">Export Excel</button>
</div>

<table id="studentsTable">
<thead>
<tr>
<th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
<th onclick="sortTable('adm')">Adm No</th>
<th onclick="sortTable('name')">Name</th>
<th onclick="sortTable('class')">Class</th>
<th onclick="sortTable('stream')">Stream</th>
<th onclick="sortTable('school')">School</th>
<th onclick="sortTable('status')">Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="pagination" id="pagination"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, getDocs, collection,
  deleteDoc, doc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCkMThRpTLJ7QC0d2OC0Neeim8bBRkzJcQ",
  authDomain: "newis-96304.firebaseapp.com",
  projectId: "newis-96304",
  storageBucket: "newis-96304.firebasestorage.app",
  messagingSenderId: "695908769426",
  appId: "1:695908769426:web:dc0db0866cbdaa4fb6d04b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allStudents=[], filteredStudents=[];
let sortField="adm", sortAsc=true;
let currentPage=1;
const perPage=20;

window.goBackToRegister=()=>window.location.href="register.html";

async function loadStudents(){
  const snap=await getDocs(collection(db,"students"));
  allStudents=[];
  const classSet=new Set();

  snap.forEach(d=>{
    const s=d.data();
    allStudents.push({
      id:d.id,
      adm:s.studentId||"",
      name:s.studentName||"",
      class:s.grade||"",
      stream:s.stream||"",
      school:s.school||"",
      status:s.status||"Active"
    });
    if(s.grade) classSet.add(s.grade);
  });

  const cf=document.getElementById("classFilter");
  cf.innerHTML="<option value='All'>All Classes</option>";
  classSet.forEach(c=>cf.innerHTML+=`<option>${c}</option>`);

  applyFilters();
}
loadStudents();

window.applyFilters=function(){
  const search=document.getElementById("searchInput").value.toLowerCase();
  const c=document.getElementById("classFilter").value;
  const s=document.getElementById("statusFilter").value;

  filteredStudents=allStudents.filter(st=>{
    if(search && !st.adm.toLowerCase().includes(search)) return false;
    if(c!=="All" && st.class!==c) return false;
    if(s!=="All" && st.status!==s) return false;
    return true;
  });

  currentPage=1;
  renderTable();
};

function renderTable(){
  filteredStudents.sort((a,b)=>{
    let v=a[sortField].localeCompare(b[sortField]);
    return sortAsc?v:-v;
  });

  const start=(currentPage-1)*perPage;
  const page=filteredStudents.slice(start,start+perPage);
  const tbody=document.querySelector("#studentsTable tbody");
  tbody.innerHTML="";

  page.forEach(s=>{
    let sc="status-active";
    if(s.status==="Suspended") sc="status-suspended";
    if(s.status==="Expelled") sc="status-expelled";

    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="selectBox" value="${s.id}"></td>
      <td>${s.adm}</td>
      <td>${s.name}</td>
      <td>${s.class}</td>
      <td>${s.stream}</td>
      <td>${s.school}</td>
      <td class="${sc}">${s.status}</td>
      <td>
        <button onclick="changeStatus('${s.id}','Active')">Restore</button>
        <button onclick="changeStatus('${s.id}','Suspended')">Suspend</button>
        <button onclick="changeStatus('${s.id}','Expelled')">Expel</button>
        <button class="delete-btn" onclick="deleteStudent('${s.id}')">Delete</button>
      </td>
    </tr>`;
  });
  renderPagination();
}

function renderPagination(){
  const p=document.getElementById("pagination");
  p.innerHTML="";
  const total=Math.ceil(filteredStudents.length/perPage);
  for(let i=1;i<=total;i++){
    p.innerHTML+=`<button onclick="goToPage(${i})">${i}</button>`;
  }
}

window.goToPage=p=>{currentPage=p;renderTable();};

window.sortTable=f=>{
  if(sortField===f) sortAsc=!sortAsc;
  else{sortField=f;sortAsc=true;}
  renderTable();
};

window.toggleSelectAll=m=>{
  document.querySelectorAll(".selectBox").forEach(cb=>cb.checked=m.checked);
};

window.changeStatus=async(id,status)=>{
  await updateDoc(doc(db,"students",id),{status});
  loadStudents();
};

window.deleteStudent=async(id)=>{
  if(confirm("Delete this student permanently?")){
    await deleteDoc(doc(db,"students",id));
    loadStudents();
  }
};

window.bulkAction=async(status)=>{
  const ids=[...document.querySelectorAll(".selectBox:checked")].map(cb=>cb.value);
  for(const id of ids){
    await updateDoc(doc(db,"students",id),{status});
  }
  loadStudents();
};

window.deleteSelected=async()=>{
  const ids=[...document.querySelectorAll(".selectBox:checked")].map(cb=>cb.value);
  if(ids.length===0) return alert("No students selected.");
  if(!confirm(`Delete ${ids.length} student(s)? This cannot be undone.`)) return;

  for(const id of ids){
    await deleteDoc(doc(db,"students",id));
  }
  loadStudents();
};

window.downloadPDF=function(){
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("Registered Students - NEWIS",10,10);
  let y=20;
  filteredStudents.forEach(s=>{
    pdf.text(`${s.adm} | ${s.name} | ${s.class} | ${s.status}`,10,y);
    y+=6;
    if(y>280){pdf.addPage();y=20;}
  });
  pdf.save("Students.pdf");
};

window.downloadExcel=function(){
  const data=[["Adm","Name","Class","Stream","School","Status"]];
  filteredStudents.forEach(s=>data.push([s.adm,s.name,s.class,s.stream,s.school,s.status]));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(data),"Students");
  XLSX.writeFile(wb,"Students.xlsx");
};
</script>

</body>
</html>
