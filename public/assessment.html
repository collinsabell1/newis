<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Socioeconomic Risk Records - NEWIS</title>

<style>
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
  color:#fff;
}
.container{
  max-width:1200px;
  margin:20px auto;
  padding:20px;
  background: rgba(255,255,255,0.08);
  border-radius:15px;
  backdrop-filter: blur(15px);
  box-shadow:0 0 40px rgba(0,0,0,0.5);
}
h1,h2{text-align:center;margin-bottom:20px;}
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(320px,1fr));
  gap:20px;
}
.section{
  background:#f4f6fa;
  padding:20px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  color:#000;
}
label{display:block;margin:6px 0;}
input[type="text"]{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
.buttons{
  margin-top:25px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
button{
  padding:10px 15px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  min-width:120px;
}
.save{background:#28a745;color:#fff;}
.update{background:#ffc107;}
.delete{background:#dc3545;color:#fff;}
.clear{background:#6c757d;color:#fff;}
.nav{background:#203a43;color:#fff;}
.view{background:#6f42c1;color:#fff;}
.circle{
  width:170px;
  height:170px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  font-weight:bold;
  margin:20px auto;
  color:#fff;
}
.green{background:#28a745;}
.yellow{background:#ffc107;color:black;}
.red{background:#dc3545;}
/* Table styles */
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:0.9rem;
}
th, td { padding:8px; text-align:center; }
th { background: rgba(255,255,255,0.2); }
tr:nth-child(even){background: rgba(255,255,255,0.05);}
@media screen and (max-width:768px){
  table, thead, tbody, th, td, tr { display:block; width:100%; }
  thead { display:none; }
  tr { margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); }
  td { text-align:right; padding-left:50%; position:relative; }
  td::before {
    position:absolute; left:15px; width:45%; white-space:nowrap; font-weight:bold;
  }
  td:nth-of-type(1)::before{content:"Select";}
  td:nth-of-type(2)::before{content:"Adm No";}
  td:nth-of-type(3)::before{content:"Name";}
  td:nth-of-type(4)::before{content:"Class";}
  td:nth-of-type(5)::before{content:"Risk %";}
  td:nth-of-type(6)::before{content:"Date Recorded";}
  td:nth-of-type(7)::before{content:"Status";}
  td:nth-of-type(8)::before{content:"Report";}
}
</style>
</head>

<body>
<div class="container">

<h1>Socioeconomic Risk Assessment Records</h1>

<div class="grid">

<div class="section">
<h3>Student Details</h3>
<label>Admission Number:</label>
<input type="text" id="studentId" placeholder="Enter Admission Number">
<label>Student Name:</label>
<input type="text" id="studentName">
<label>Class:</label>
<input type="text" id="studentClass">
</div>

<div class="section">
<h3>Socioeconomic Risk Indicators</h3>
<label><input type="checkbox" class="risk" data-weight="10" value="poverty"> Household poverty</label>
<label><input type="checkbox" class="risk" data-weight="15" value="fees"> Unable to pay school fees</label>
<label><input type="checkbox" class="risk" data-weight="12" value="orphan"> Orphan / vulnerable child</label>
<label><input type="checkbox" class="risk" data-weight="15" value="childlabour"> Child labour</label>
<label><input type="checkbox" class="risk" data-weight="10" value="singleparent"> Single parent</label>
<label><input type="checkbox" class="risk" data-weight="15" value="violence"> Domestic/community violence</label>
<label><input type="checkbox" class="risk" data-weight="8" value="largedependents"> Large dependent family</label>
<label><input type="checkbox" class="risk" data-weight="8" value="poorhousing"> Poor housing conditions</label>
<label><input type="checkbox" class="risk" data-weight="15" value="pregnancy"> Early pregnancy</label>
<label><input type="checkbox" class="risk" data-weight="12" value="absenteeism"> Chronic absenteeism</label>
<label><input type="checkbox" class="risk" data-weight="8" value="drought"> Drought / disaster</label>
<label><input type="checkbox" class="risk" data-weight="8" value="distance"> Long distance to school</label>
</div>

<div class="section">
<h3>Socioeconomic Risk Level</h3>
<div id="riskCircle" class="circle green">0%</div>
<p style="text-align:center;font-weight:bold;" id="riskLevel">Low Risk</p>
</div>

</div>

<div class="buttons">
<button class="save" onclick="saveRecord()">Save</button>
<button class="update" onclick="updateRecord()">Update</button>
<button class="delete" onclick="deleteRecord()">Delete</button>
<button class="clear" onclick="clearForm()">Clear</button>
<button class="view" onclick="renderTable()">View All Records</button>
</div>

<!-- Table -->
<table id="recordsTable">
<thead>
<tr>
<th><input type="checkbox" id="selectAll"></th>
<th>Adm No</th>
<th>Name</th>
<th>Class</th>
<th>Risk %</th>
<th>Date Recorded</th>
<th>Status</th>
<th>Report</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* SUPABASE CONNECTION */
const supabase = createClient(
  "https://xnvnskxcsphbvkxhndui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhudm5za3hjc3BoYnZreGhuZHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjEwNjIsImV4cCI6MjA4Njk5NzA2Mn0.QMn4OHjv9CQC3RIj62aJG8JXI03gtbodtUEIP7uhwLQ"
);

let allData=[];

/* RISK CALCULATION */
function calculateRisk(){
  let total=0;
  document.querySelectorAll(".risk:checked").forEach(cb=>{
    total+=Number(cb.dataset.weight);
  });
  if(total>100) total=100;

  const circle=document.getElementById("riskCircle");
  const level=document.getElementById("riskLevel");

  circle.textContent=total+"%";

  if(total<45){
    circle.className="circle green";
    level.textContent="Low Risk";
  } else if(total<=55){
    circle.className="circle yellow";
    level.textContent="Medium Risk";
  } else{
    circle.className="circle red";
    level.textContent="High Risk";
  }

  return total;
}

document.querySelectorAll(".risk").forEach(cb=>cb.addEventListener("change",calculateRisk));

/* SAVE */
window.saveRecord=async()=>{
  const id=studentId.value.trim();
  if(!id) return alert("Enter admission number");

  const { error } = await supabase
    .from("assessments")
    .insert({
      admission_no:id,
      name:studentName.value,
      class:studentClass.value,
      risk_percent:calculateRisk(),
      risks:[...document.querySelectorAll(".risk:checked")].map(c=>c.value),
      date_recorded:new Date()
    });
  if(error) return alert(error.message);
  alert("Saved successfully");
  loadData();
};

/* UPDATE */
window.updateRecord=async()=>{
  const id=studentId.value.trim();
  if(!id) return;
  const { error } = await supabase
    .from("assessments")
    .update({
      name:studentName.value,
      class:studentClass.value,
      risk_percent:calculateRisk(),
      risks:[...document.querySelectorAll(".risk:checked")].map(c=>c.value),
      date_recorded:new Date()
    })
    .eq("admission_no",id);
  if(error) return alert(error.message);
  alert("Updated successfully");
  loadData();
};

/* DELETE */
window.deleteRecord=async()=>{
  const id=studentId.value.trim();
  if(!id) return;
  if(!confirm("Delete this record?")) return;
  const { error } = await supabase
    .from("assessments")
    .delete()
    .eq("admission_no",id);
  if(error) return alert(error.message);
  alert("Deleted");
  clearForm();
  loadData();
};

/* CLEAR */
window.clearForm=()=>{
  studentId.value="";
  studentName.value="";
  studentClass.value="";
  document.querySelectorAll(".risk").forEach(cb=>cb.checked=false);
  calculateRisk();
};

/* LOAD TABLE DATA */
async function loadData(){
  const { data, error } = await supabase
    .from("assessments")
    .select("*")
    .order("date_recorded",{ascending:false});
  if(error) return alert(error.message);
  allData = data.map(r=>({
    id: r.id,
    adm: r.admission_no,
    name: r.name,
    class: r.class,
    risk: r.risk_percent,
    date: new Date(r.date_recorded),
    status: r.risk_percent>55 ? "High" : r.risk_percent>=45 ? "Medium" : "Low"
  }));
  renderTable();
}

/* RENDER TABLE */
window.renderTable=()=>{
  const tbody=document.querySelector("#recordsTable tbody");
  tbody.innerHTML="";
  allData.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="checkbox" class="rowCheck" data-id="${r.id}"></td>
      <td>${r.adm}</td>
      <td>${r.name}</td>
      <td>${r.class}</td>
      <td>${r.risk}%</td>
      <td>${r.date.toLocaleDateString()}</td>
      <td class="${r.status==='High'?'red':r.status==='Medium'?'yellow':'green'}">${r.status}</td>
      <td><button onclick='printReport(${JSON.stringify(r)})'>Print</button></td>
    `;
    tbody.appendChild(tr);
  });
};

/* SELECT ALL */
document.getElementById("selectAll").addEventListener("change",function(){
  document.querySelectorAll(".rowCheck").forEach(cb=>cb.checked=this.checked);
});

/* PRINT */
window.printReport=(r)=>{
  const win=window.open("","_blank");
  win.document.write(`
    <h2>Socioeconomic Report</h2>
    Admission: ${r.adm}<br>
    Name: ${r.name}<br>
    Class: ${r.class}<br>
    Risk: ${r.risk}%<br>
    Status: ${r.status}<br>
    Date: ${r.date.toLocaleDateString()}<br><br>
    <button onclick="window.print()">Print</button>
  `);
};

/* INITIAL LOAD */
loadData();
</script>

</body>
</html>
