<!DOCTYPE html>
<html>
<head>
<title>All Academic Records - NEWIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
.container{
  max-width:1300px;
  margin:30px auto;
  padding:30px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter:blur(15px);
  box-shadow:0 0 40px rgba(0,0,0,0.5);
}
h1{text-align:center;margin-bottom:20px;}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:10px;
  text-align:center;
}
th{
  background:rgba(255,255,255,0.2);
}
tr:nth-child(even){
  background:rgba(255,255,255,0.05);
}
button,select,input{
  padding:8px 14px;
  margin:5px;
  border:none;
  border-radius:10px;
  font-weight:bold;
}
.btn-download{background:#00c6ff;color:white;}
.btn-nav{background:#17a2b8;color:white;}
.btn-filter{background:#ffc107;color:black;}
.btn-print{background:#28a745;color:white;}
.btn-delete{background:#dc3545;color:white;}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“Š All Students Academic Records</h1>

<div style="text-align:center;">
<button class="btn-nav" onclick="window.location.href='/index.html'">â¬… Back to Index</button>
<button class="btn-nav" onclick="window.location.href='/academics.html'">â¬… Back to Academics</button>
<button class="btn-nav" onclick="window.location.href='/behavioral.html'">Next âž¡ Behavioral</button>
</div>

<br>

<div style="text-align:center;">
<input type="text" id="searchInput" placeholder="Search Admission Number">

<select id="yearFilter"></select>

<select id="classFilter">
<option value="All">All Classes</option>
</select>

<select id="averageFilter">
<option value="All">All Performance</option>
<option value="Above">Above 50%</option>
<option value="Below">Below 50%</option>
<option value="Equal">Exactly 50%</option>
</select>

<button class="btn-filter" onclick="renderTable()">Apply</button>
</div>

<br>

<button class="btn-download" onclick="downloadAll()">Download All</button>
<button class="btn-download" onclick="downloadSelected()">Download Selected</button>
<button class="btn-delete" onclick="deleteSelected()">ðŸ—‘ Delete Selected</button>

<table id="recordsTable">
<thead>
<tr>
<th><input type="checkbox" id="selectAll"></th>
<th>Adm No</th>
<th>Name</th>
<th>Class</th>
<th>Year</th>
<th>T1</th>
<th>T2</th>
<th>T3</th>
<th>Average</th>
<th>Rank</th>
<th>Report</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://xnvnskxcsphbvkxhndui.supabase.co","YOUR_KEY");

import {
  getFirestore,
  getDocs,
  collection,
  doc,
  writeBatch


  currentFiltered.forEach(r=>{
    const key = r.year + "_" + r.class;
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  }])

  Object.values(grouped).forEach(group=>{
    group.sort((a,b)=>b.avg-a.avg);
    group.forEach((r,i)=>r.rank=i+1);
  }])

  currentFiltered.forEach((r,index)=>{
    let color="lightgreen";
    if(r.avg<50) color="red";
    else if(r.avg<=65) color="yellow";

    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="rowCheck" data-index="${index}"></td>
      <td>${r.adm}</td>
      <td>${r.name}</td>
      <td>${r.class}</td>
      <td>${r.year}</td>
      <td>${r.t1}</td>
      <td>${r.t2}</td>
      <td>${r.t3}</td>
      <td style="color:${color};font-weight:bold">${r.avg.toFixed(1)}%</td>
      <td>${r.rank}</td>
      <td><button class="btn-print" onclick='printReport(${JSON.stringify(r)})'>Print</button></td>
    </tr>`;
  }])
};

selectAll.addEventListener("change",function(){
  document.querySelectorAll(".rowCheck").forEach(cb=>cb.checked=this.checked);
}])

/* ðŸ—‘ DELETE SELECTED WITH CONFIRMATION */
window.deleteSelected = async function(){
  const selected = [...document.querySelectorAll(".rowCheck")]
    .filter(c=>c.checked)
    .map(c=>currentFiltered[c.dataset.index]);

  if(!selected.length){
    alert("âš ï¸ Please select at least one record to delete.");
    return;
  }

  const confirmDelete = confirm(
    `âš ï¸ CONFIRM DELETION\n\nYou are about to permanently delete ${selected.length} academic record(s).\n\nThis action CANNOT be undone.\n\nClick OK to proceed or Cancel to stop.`
  );

  if(!confirmDelete) return;

  const batch = writeBatch(db);
  selected.forEach(r=>batch.delete(doc(db,r.docPath)));
  await batch.commit();

  alert("âœ… Selected records deleted successfully.");
  loadData();
};

/* DOWNLOAD */
function downloadCSV(rows,filename){
  let csv="AdmNo,Name,Class,Year,T1,T2,T3,Average,Rank\n";
  rows.forEach(r=>{
    csv+=`${r.adm},${r.name},${r.class},${r.year},${r.t1},${r.t2},${r.t3},${r.avg},${r.rank}\n`;
  }])
  const blob=new Blob([csv],{type:"text/csv"}])
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
window.downloadAll=()=>downloadCSV(currentFiltered,"All_Academic_Records.csv");
window.downloadSelected=()=>{
  const sel=[...document.querySelectorAll(".rowCheck")]
    .filter(c=>c.checked)
    .map(c=>currentFiltered[c.dataset.index]);
  if(!sel.length) return alert("Select students first!");
  downloadCSV(sel,"Selected_Records.csv");
};

/* PRINT */
window.printReport=function(data){
  const win=window.open("");
  win.document.write(`
    <h2>Student Report Card</h2>
    <p><b>Admission:</b> ${data.adm}</p>
    <p><b>Name:</b> ${data.name}</p>
    <p><b>Class:</b> ${data.class}</p>
    <p><b>Year:</b> ${data.year}</p>
    <p><b>Average:</b> ${data.avg}%</p>
    <button onclick="print()">Print</button>
  `);
};
</script>
</body>
<script type="module" src="test.js"></script>
</html>
