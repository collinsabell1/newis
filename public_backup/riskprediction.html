<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEWIS AI Dropout Risk Dashboard (CBC)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#134E5E,#71B280);
}
.container{padding:25px;padding-bottom:200px;}

.top-widget{
  background:#fff;padding:20px;border-radius:15px;
  display:flex;justify-content:space-between;flex-wrap:wrap;
  align-items:center;
  gap:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
}
.top-widget input{padding:8px;border-radius:6px;border:1px solid #ccc;}
.top-widget button{
  padding:8px 14px;border:none;border-radius:8px;
  background:#134E5E;color:#fff;font-weight:bold;cursor:pointer;
}
.top-widget .nav-btn{
  background:#0b3c49;
}
.top-widget .refresh-btn{
  background:#1e7e34;
}

.details-card{
  background:#203a43;color:#fff;
  padding:20px;border-radius:15px;margin:20px 0;
}

.summary{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px;}
.summary-card{
  flex:1 1 200px;padding:20px;border-radius:15px;
  text-align:center;font-weight:bold;font-size:18px;color:#fff;
}

.green{background:#28a745;}
.yellow{background:#ffc107;color:#111;}
.red{background:#dc3545;}

.chart-card{
  background:#fff;padding:20px;border-radius:15px;height:320px;
}
canvas{width:100%!important;height:100%!important;}

.prediction-card{
  position:fixed;right:16px;bottom:16px;
  width:min(95vw,420px);
  padding:22px;border-radius:26px;
  color:#fff;display:none;
  box-shadow:0 25px 50px rgba(0,0,0,.5);
}

.pred-title{font-size:20px;font-weight:900;}
.pred-meta{font-size:13px;margin:6px 0;white-space:pre-line;}

.confidence{
  display:inline-block;
  padding:6px 14px;border-radius:14px;
  font-weight:bold;margin:4px 4px 4px 0;
}

.low{background:#28a745;}
.mid{background:#f0ad4e;color:#000;}
.high{background:#dc3545;}

.explain{
  margin-top:10px;padding:12px;border-radius:14px;
  background:rgba(255,255,255,.18);
  font-size:13px;white-space:pre-line;
}
</style>
</head>

<body>

<div class="container">

<div class="top-widget">
  <h2>AI Dropout Risk Dashboard (CBC)</h2>
  <div>
    <input id="studentId" placeholder="Admission Number">
    <button onclick="loadStudent()">Load</button>

    <!-- ðŸ”¹ NEW BUTTONS -->
    <button class="refresh-btn" onclick="location.reload()">Refresh</button>
    <button class="nav-btn" onclick="window.location.href='index.html'">Home</button>
    <button class="nav-btn" onclick="window.location.href='intervention.html'">Interventions</button>
    <button onclick="window.location.href='riskview.html'">View All</button>
  </div>
</div>

<div class="details-card">
  <p><b>Name:</b> <span id="studentName">-</span></p>
  <p><b>Class:</b> <span id="studentClass">-</span></p>
  <p><b>School:</b> <span id="studentSchool">-</span></p>
</div>

<div class="summary">
  <div id="academicCard" class="summary-card">Academic</div>
  <div id="behaviourCard" class="summary-card">Behaviour</div>
  <div id="assessmentCard" class="summary-card">Social</div>
  <div id="finalCard" class="summary-card">Overall</div>
</div>

<div class="chart-card"><canvas id="barChart"></canvas></div>

</div>

<div id="predictionCard" class="prediction-card">
  <div id="predTitle" class="pred-title"></div>
  <div id="predMeta" class="pred-meta"></div>
  <div id="completionTag" class="confidence"></div>
  <div id="dropoutTag" class="confidence"></div>
  <div id="predExplain" class="explain"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://xnvnskxcsphbvkxhndui.supabase.co","YOUR_KEY");

import { getFirestore, collection, query, where, getDocs, getDoc, doc }

const app = initializeApp({
  apiKey:"AIzaSyCkMThRpTLJ7QC0d2OC0Neeim8bBRkzJcQ",
  projectId:"newis-96304"
}])
const db = getFirestore(app);
const safe = v => Math.max(0, Math.min(100, Number(v)||0));
let chart;

/* ðŸ”¹ ACCURATE ACADEMIC AVERAGE FETCH */
async function getLatestAcademicAverage(studentDocId){
  const snap = await getDocs(collection(db,"students",studentDocId,"academics"));
  if(snap.empty) return 0;

  const records = snap.docs.map(d => d.data());

  records.sort((a,b)=>{
    if(a.year && b.year) return b.year - a.year;
    if(a.timestamp && b.timestamp) return b.timestamp.seconds - a.timestamp.seconds;
    return 0;
  }])

  return safe(records[0].average);
}

function drawBar(a,b,c,o){
  if(chart) chart.destroy();
  chart=new Chart(barChart,{
    type:"bar",
    data:{
      labels:["Academic","Behaviour","Social","Overall"],
      datasets:[{
        data:[a,b,c,o],
        backgroundColor:["#1abc9c","#3498db","#9b59b6","#e74c3c"]
      }]
    },
    options:{scales:{y:{min:0,max:100}}}
  }])
}

window.loadStudent = async()=>{
  const adm = studentId.value.trim();
  if(!adm) return alert("Enter Admission Number");

  const q=query(collection(db,"students"),where("studentId","==",adm));
  const snap=await getDocs(q);
  if(snap.empty) return alert("Student not found");

  const d=snap.docs[0];
  const s=d.data();

  studentName.textContent=s.studentName;
  studentClass.textContent=s.grade;
  studentSchool.textContent=s.school||"-";

  const academicAvg = await getLatestAcademicAverage(d.id);
  const academicRisk = safe(100 - academicAvg);

  let behaviour=0,social=0;
  const b=await getDoc(doc(db,"students",d.id,"behavioral","record"));
  if(b.exists()) behaviour=safe(b.data().riskPercent);

  const a=await getDoc(doc(db,"students",d.id,"assessment","record"));
  if(a.exists()) social=safe(a.data().riskPercent);

  // ðŸ”’ STRICT & ONLY ALLOWED FORMULA
  const overall = safe(
    academicRisk * 0.4 +
    behaviour * 0.3 +
    social * 0.3
  );

  academicCard.textContent=`Academic ${academicRisk}%`;
  behaviourCard.textContent=`Behaviour ${behaviour}%`;
  assessmentCard.textContent=`Social ${social}%`;
  finalCard.textContent=`Overall ${overall}%`;

  academicCard.className=`summary-card ${academicRisk<35?"green":academicRisk<60?"yellow":"red"}`;
  behaviourCard.className=`summary-card ${behaviour<35?"green":behaviour<60?"yellow":"red"}`;
  assessmentCard.className=`summary-card ${social<35?"green":social<60?"yellow":"red"}`;
  finalCard.className=`summary-card ${overall<35?"green":overall<60?"yellow":"red"}`;

  drawBar(academicRisk,behaviour,social,overall);
  predictOutcome(overall,s.grade);
};

function predictOutcome(risk,cls){
  predictionCard.style.display="block";

  const now=new Date();
  const year=now.getFullYear();
  const term=Math.ceil((now.getMonth()+1)/4);
  const g=parseInt(cls.match(/\d+/)?.[0]||0);

  let finalGrade=cls.toLowerCase().includes("form")?4:12;
  const completionYear=year+(finalGrade-g);

  const horizon=risk<=35?4:risk<=60?2:1;
  const predictedYear=year+horizon;

  let status,grad,clsTag;
  if(predictedYear>completionYear){
    status="LIKELY TO SUCCESSFULLY COMPLETE";
    grad="linear-gradient(135deg,#11998e,#38ef7d)";
    clsTag="low";
  }else if(predictedYear===completionYear){
    status="COMPLETION AT RISK";
    grad="linear-gradient(135deg,#f7971e,#ffd200)";
    clsTag="mid";
  }else{
    status="MIGHT NOT COMPLETE";
    grad="linear-gradient(135deg,#cb2d3e,#ef473a)";
    clsTag="high";
  }

  predictionCard.style.background=grad;
  predTitle.textContent=status;
  predMeta.textContent=
`Predicted Review: Term ${term}, ${predictedYear}
Expected Completion Year: ${completionYear}`;

  completionTag.textContent=status;
  completionTag.className=`confidence ${clsTag}`;
  dropoutTag.textContent=`Overall Risk: ${risk}%`;
  dropoutTag.className=`confidence ${clsTag}`;

  predExplain.textContent=
`Overall = (Academic Ã— 0.4) + (Behaviour Ã— 0.3) + (Social Ã— 0.3)

This formula is strictly enforced and used consistently across NEWIS.`;
}
</script>

</body>
<script type="module" src="test.js"></script>
</html>
